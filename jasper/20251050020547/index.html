<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="google-site-verification" content="M2t8cZr5nIzHmltyt7Utj3nWYxNyNkCzFyigXBHkGUs"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.31/dist/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"jasper1024.com","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.25.0","exturl":true,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"vs2015","dark":"vs2015"},"prism":{"light":"prism-vsc-dark-plus","dark":"prism-vsc-dark-plus"},"copy_button":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":true,"nav":{"disqus":{"text":"disqus","order":-1},"utteranc":{"text":"utteranc","order":-2}}},"stickytabs":true,"motion":{"enable":true,"async":true,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/config.min.js" defer></script><meta name="description" content="clixon 线程模型解析 更新  12025.05.00 初始 初始"><meta property="og:type" content="article"><meta property="og:title" content="Clixon 线程模型"><meta property="og:url" content="https://jasper1024.com/jasper/20251050020547/index.html"><meta property="og:site_name" content="默"><meta property="og:description" content="clixon 线程模型解析 更新  12025.05.00 初始 初始"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2025-05-10T12:00:00.000Z"><meta property="article:modified_time" content="2025-05-10T10:42:28.000Z"><meta property="article:author" content="Jasper"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://jasper1024.com/jasper/20251050020547/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://jasper1024.com/jasper/20251050020547/","path":"jasper/20251050020547/","title":"Clixon 线程模型"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Clixon 线程模型 | 默</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-207687331-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-207687331-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/third-party/analytics/google-analytics.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script><script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous" defer></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.31/dist/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous" defer></script><script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/comments.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/utils.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/motion.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/sidebar.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/next-boot.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/pjax.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.5.0/dist/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/third-party/search/local-search.min.js" defer></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdn.jsdelivr.net/npm/pdfobject@2.3.1/pdfobject.min.js","integrity":"sha256-jI72I8ZLVflVOisZIOaLvRew3tyvzeu6aZXFm7P7dEo="},"url":"/lib/pdf/web/viewer.html"}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/third-party/tags/pdf.min.js" defer></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@11.10.1/dist/mermaid.min.js","integrity":"sha256-BmQmdWDS8X2OTbrwELWK366LV6escyWhHHe0XCTU/Hk="}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/third-party/tags/mermaid.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/third-party/fancybox.min.js" defer></script><script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"ItayEcWO7OsLFKF2Y8SsAYG1-MdYXbMMI","app_key":"18UBQFmJXXcOQFebLovT36lh","server_url":null,"security":false}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/third-party/statistics/lean-analytics.min.js" defer></script><script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha256-UF1fgpAiu3tPJN/uCqEUHNe7pnr+QR0SQDNfgglgtcM=" crossorigin="anonymous"><script src="https://cdn.jsdelivr.net/npm/quicklink@3.0.1/dist/quicklink.umd.js" integrity="sha256-44BednzIpUeQJcY8qtLyarFu0UCCTbgmWOvaoehiFQQ=" crossorigin="anonymous" defer></script><script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":false,"archive":false,"delay":true,"timeout":3000,"priority":true,"url":"https://jasper1024.com/jasper/20251050020547/"}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/third-party/quicklink.min.js" defer></script><link rel="stylesheet" href="source/_data/callout_blocks.css"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="默" type="application/rss+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">默</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">生存是唯一的长路</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">45</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">330</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">65</span></a></li><li class="menu-item menu-item-guestbook"><a href="/guestbook/" rel="section"><i class="fa fa-comments fa-fw"></i>留言</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#clixon-%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B"><span class="nav-number">1.</span> <span class="nav-text">Clixon 线程模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E6%9C%BA%E5%88%B6"><span class="nav-number">1.1.</span> <span class="nav-text">核心事件循环机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E4%B8%AD%E7%9A%84%E4%BA%8B%E4%BB%B6%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%A4%84%E7%90%86"><span class="nav-number">1.2.</span> <span class="nav-text">模块中的事件注册与处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#backend-%E6%A8%A1%E5%9D%97"><span class="nav-number">1.2.1.</span> <span class="nav-text">Backend 模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#restconf-%E6%A8%A1%E5%9D%97"><span class="nav-number">1.2.2.</span> <span class="nav-text">RESTCONF 模块</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#restconf-get-%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.3.</span> <span class="nav-text">RESTCONF GET 请求处理流程示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.4.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Jasper" src="/images/avatar.jfif"><p class="site-author-name" itemprop="name">Jasper</p><div class="site-description" itemprop="description">微尘</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">330</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">45</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">65</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2phc3Blci0xMDI0" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jasper-1024"><i class="fab fa-github fa-fw"></i>GitHub</span> </span><span class="links-of-author-item"><a href="/ljy087621@gmail.com" title="E-Mail → ljy087621@gmail.com" rel="noopener me"><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly94LmNvbS9KYXNwZXJfMTAyNA==" title="Twitter → https:&#x2F;&#x2F;x.com&#x2F;Jasper_1024"><i class="fab fa-twitter fa-fw"></i>Twitter</span> </span><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly90Lm1lL2phc3BlcjEwMjQ=" title="Telegram → https:&#x2F;&#x2F;t.me&#x2F;jasper1024"><i class="fab fa-skype fa-fw"></i>Telegram</span> </span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → &#x2F;atom.xml" rel="noopener me"><i class="fas fa-rss fa-fw"></i>RSS</a></span></div></div></div><div class="back-to-top animated" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div><div class="sidebar-inner sidebar-blogroll"><div class="links-of-blogroll animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> 链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmZvcmVjaG8uY29tLw==" title="https:&#x2F;&#x2F;blog.forecho.com&#x2F;">forecho</span></li><li class="links-of-blogroll-item"><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmZvcmVjaG8uY29tL2ZyaWVuZHNoaXAtbGlua3Mv" title="https:&#x2F;&#x2F;blog.forecho.com&#x2F;friendship-links&#x2F;">友链聚合</span></li></ul></div></div><div class="pjax"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://jasper1024.com/jasper/20251050020547/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jfif"><meta itemprop="name" content="Jasper"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="默"><meta itemprop="description" content="微尘"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Clixon 线程模型 | 默"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Clixon 线程模型</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2025-05-10 12:00:00 / 修改时间：10:42:28" itemprop="dateCreated datePublished" datetime="2025-05-10T12:00:00Z">2025-05-10</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/clixon/" itemprop="url" rel="index"><span itemprop="name">clixon</span></a> </span></span><span id="/jasper/20251050020547/" class="post-meta-item leancloud_visitors" data-flag-title="Clixon 线程模型" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Disqus：</span> <a title="disqus" href="/jasper/20251050020547/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="jasper/20251050020547/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>5.1k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>5 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li>clixon 线程模型解析</li><li>更新</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2025.05</span>.<span class="number">00</span> 初始 初始</span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="clixon-线程模型"><a class="markdownIt-Anchor" href="#clixon-线程模型"></a> Clixon 线程模型</h2><p>官方文档:</p><blockquote><p>“The Clixon programs run as <strong>non-blocking single-threaded</strong> applications.”</p></blockquote><blockquote><p>“The callback code must be written with this programming model in mind. The behavior of the callback directly impacts the behavior of the caller and the whole system.”</p></blockquote><p>Clixon 采用单线程 非阻塞 I/O 和事件驱动模型. 这意味着所有操作,包括插件回调,都在同一个主线程中顺序执行.</p><h3 id="核心事件循环机制"><a class="markdownIt-Anchor" href="#核心事件循环机制"></a> 核心事件循环机制</h3><p>Clixon 的事件处理核心是 <code>lib/src/clixon_event.c</code></p><p>关键数据结构 <code>struct event_data</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 事件数据结构 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">event_data</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event_data</span>          *<span class="title">e_next</span>;</span>                 <span class="comment">/* 链表中的下一个事件 */</span></span><br><span class="line">    <span class="type">int</span>                       (*e_fn)(<span class="type">int</span>, <span class="type">void</span>*);      <span class="comment">/* 回调函数 重要*/</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> &#123;</span>EVENT_FD, EVENT_TIME&#125; e_type;                 <span class="comment">/* 事件类型 */</span></span><br><span class="line">    <span class="type">int</span>                         e_fd;                   <span class="comment">/* 文件描述符 */</span></span><br><span class="line">    <span class="type">int</span>                         e_prio;                 <span class="comment">/* 优先级 表示高优先级文件描述符 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span>              <span class="title">e_time</span>;</span>                 <span class="comment">/* 超时时间 */</span></span><br><span class="line">    <span class="type">void</span>                       *e_arg;                  <span class="comment">/* 函数参数 */</span></span><br><span class="line">    <span class="type">char</span>                        e_string[EVENT_STRLEN]; <span class="comment">/* 用于调试的字符串 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 全局事件列表 */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">event_data</span> *<span class="title">ee</span> =</span> <span class="literal">NULL</span>;        <span class="comment">// 普通文件描述符事件</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">event_data</span> *<span class="title">ee_timers</span> =</span> <span class="literal">NULL</span>; <span class="comment">// 定时器事件</span></span><br></pre></td></tr></table></figure><p>事件注册接口:</p><ul><li><code>clixon_event_reg_fd()</code>: 注册文件描述符事件.</li><li><code>clixon_event_reg_fd_prio()</code>: 注册带优先级的文件描述符事件.</li><li><code>clixon_event_reg_timeout()</code>: 注册定时器事件.</li></ul><p><code>clixon_event_loop()</code> 是事件循环核心</p><ol><li><code>select()</code> 监听多个文件描述符</li><li>当有描述符就绪时,依次 <code>*e-&gt;e_fn</code> 调用对应的回调函数</li><li>所有回调在同一个线程中顺序执行</li></ol><h3 id="模块中的事件注册与处理"><a class="markdownIt-Anchor" href="#模块中的事件注册与处理"></a> 模块中的事件注册与处理</h3><p>Clixon 的各个主要模块,如 Backend 和 RESTCONF,都依赖此事件模型.</p><h4 id="backend-模块"><a class="markdownIt-Anchor" href="#backend-模块"></a> Backend 模块</h4><p>Backend 服务在 <code>backend_main.c</code> 中启动.其 <code>main</code> 函数会调用 <code>backend_server_socket()</code> 来创建监听套接字.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">backend_server_socket</span><span class="params">(clixon_handle h)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ss;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((ss = backend_socket_init(h)) &lt; <span class="number">0</span>) <span class="comment">// 初始化套接字</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">// 为监听套接字 ss 注册回调函数 backend_accept_client</span></span><br><span class="line">    <span class="keyword">if</span> (clixon_event_reg_fd(ss, backend_accept_client, h, <span class="string">&quot;server socket&quot;</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        close(ss);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ss;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>clixon_event_loop(h)</code> 启动事件循环.</p><p>新的客户端连接请求, <code>select</code> 检测到套接字可读,调用 <code>backend_accept_client</code> 回调函数处理新的连接.</p><h4 id="restconf-模块"><a class="markdownIt-Anchor" href="#restconf-模块"></a> RESTCONF 模块</h4><p>RESTCONF 服务 在 <code>restconf_main_native.c</code> 启动.通过 <code>openssl_init_socket()</code> 创建监听套接字,并为该套接字注册 <code>restconf_accept_client</code> 回调函数.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// openssl_init_socket 函数片段</span></span><br><span class="line">    <span class="comment">/* ss is a server socket that the clients connect to. The callback</span></span><br><span class="line"><span class="comment">       therefore accepts clients on ss */</span></span><br><span class="line">    rsock-&gt;rs_ss = ss; <span class="comment">// ss 是监听套接字</span></span><br><span class="line">    <span class="comment">// 为监听套接字 rs_ss 注册回调函数 restconf_accept_client</span></span><br><span class="line">    <span class="keyword">if</span> (clixon_event_reg_fd(rsock-&gt;rs_ss, restconf_accept_client, rsock, <span class="string">&quot;restconf socket&quot;</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line"><span class="comment">// …</span></span><br><span class="line">    <span class="keyword">if</span> (clixon_event_loop(h) &lt; <span class="number">0</span>) <span class="comment">// 启动事件循环</span></span><br><span class="line">        <span class="keyword">goto</span> done;</span><br></pre></td></tr></table></figure><p>新连接到达时触发 restconf_accept_client</p><h3 id="restconf-get-请求处理流程示例"><a class="markdownIt-Anchor" href="#restconf-get-请求处理流程示例"></a> RESTCONF GET 请求处理流程示例</h3><p>以一次简化的 RESTCONF GET 请求为例,说明其在单线程模型下的处理路径:</p><ol><li><p><strong>连接建立</strong>:</p><ul><li>RESTCONF 客户端发起连接.</li><li>事件循环检测到 RESTCONF 监听套接字可读,调用 <code>restconf_accept_client</code> 回调,建立连接,并为新的客户端连接套接字注册新的回调 (例如处理 HTTP 请求的函数).</li></ul></li><li><p><strong>请求接收与转换</strong>:</p><ul><li>当客户端发送 GET 请求数据,对应客户端套接字变为可读.</li><li>事件循环调用注册的 HTTP 请求处理回调.</li><li>此回调解析 RESTCONF GET 请求,最终可能调用如 <code>api_data_get()</code> -&gt; <code>api_data_get2()</code>.</li><li><code>api_data_get2()</code> 将 RESTCONF 请求转换为 NETCONF GET 请求的 XML 消息.</li><li>调用 <code>clicon_rpc_get()</code> -&gt; <code>clicon_rpc_msg()</code> 向 Backend 发送此 NETCONF GET 请求.</li></ul></li><li><p><strong>Backend 处理连接与请求</strong>:</p><ul><li><code>clicon_rpc_msg()</code> 内部尝试连接 Backend.如果这是第一个到 Backend 的请求或连接已断开,会建立新的 Unix socket 连接.</li><li>Backend 的监听套接字 (之前由 <code>backend_server_socket</code> 创建并注册) 变为可读.</li><li>事件循环调用 <code>backend_accept_client</code> 回调.</li><li><code>backend_accept_client</code> 接受来自 RESTCONF (作为客户端) 的连接,创建一个新的套接字 <code>s</code> 代表这个连接,并为 <code>s</code> 注册 <code>from_client</code> 回调.</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// backend_accept_client 函数片段</span></span><br><span class="line"><span class="keyword">if</span> ((s = accept(fd, &amp;from, &amp;len)) &lt; <span class="number">0</span>)&#123; <span class="comment">/* … */</span> &#125; <span class="comment">// fd 是监听套接字</span></span><br><span class="line"><span class="comment">// …</span></span><br><span class="line"><span class="comment">// 为新的客户端连接 s 注册 from_client 回调</span></span><br><span class="line"><span class="keyword">if</span> (clixon_event_reg_fd_prio(s, from_client, (<span class="type">void</span>*)ce, <span class="string">&quot;local netconf client socket&quot;</span>, …) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> done;</span><br></pre></td></tr></table></figure></li><li><p><strong>Backend 消息处理与插件回调</strong>:</p><ul><li>当 RESTCONF 通过 <code>s</code> 发送 NETCONF GET 请求消息后,套接字 <code>s</code> 变为可读.</li><li>事件循环调用 <code>from_client</code> 回调.</li><li><code>from_client</code> 读取消息,然后调用 <code>from_client_msg()</code>.</li><li><code>from_client_msg()</code> 进一步调用 <code>rpc_callback_call()</code>,它会根据 RPC 名称查找并执行注册的回调.对于 <code>&lt;get&gt;</code> 操作,这通常是 <code>from_client_get</code> (在 <code>backend_rpc_init</code> 中注册).</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// backend_main.c -&gt; main()</span></span><br><span class="line"><span class="comment">// 注册 &lt;get&gt; 操作的回调</span></span><br><span class="line"><span class="keyword">if</span> (rpc_callback_register(h, from_client_get, <span class="literal">NULL</span>, NETCONF_BASE_NAMESPACE, <span class="string">&quot;get&quot;</span>) &lt; <span class="number">0</span>)</span><br><span class="line"><span class="comment">// …</span></span><br></pre></td></tr></table></figure><ul><li><code>from_client_get</code> 调用 <code>get_common()</code>.</li><li>如果请求的是 <code>state data</code> (operational data),路径通常会导向 <code>get_state_data()</code>.</li><li><code>get_state_data()</code> 调用 <code>clixon_plugin_statedata_all()</code>,它会遍历所有已加载的 Backend 插件.</li><li><code>clixon_plugin_statedata_all()</code> 对每个插件调用 <code>clixon_plugin_statedata_one()</code>.</li><li><code>clixon_plugin_statedata_one()</code> 获取插件注册的 <code>ca_statedata</code> 回调函数,并执行它.</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// clixon_plugin_statedata_one 函数片段</span></span><br><span class="line"><span class="comment">// 获取插件的 statedata 回调函数</span></span><br><span class="line"><span class="keyword">if</span> ((fn = clixon_plugin_api_get(cp)-&gt;ca_statedata) != <span class="literal">NULL</span>)&#123;</span><br><span class="line">    <span class="comment">// …</span></span><br><span class="line">    <span class="comment">// 执行插件的回调函数</span></span><br><span class="line">    <span class="keyword">if</span> (fn(h, nsc, xpath, x) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">// …</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// …</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>关键点</strong>: 所有这些步骤,从 RESTCONF 接收请求到 Backend 插件回调的执行,都在同一个主线程中按顺序发生.</p></li><li><p><strong>响应返回</strong>:</p><ul><li>插件回调填充数据后,结果会逐层返回,最终由 RESTCONF 模块发送 HTTP 响应给客户端.</li></ul></li></ol><pre><code class="highlight mermaid">sequenceDiagram
    participant Client
    participant RESTCONF as RESTCONF Module (Event Thread)
    participant EventLoop as Clixon Event Loop
    participant Backend as Backend Module (Event Thread)
    participant Plugin as Backend Plugin (Event Thread)

    Client -&gt;&gt; RESTCONF: HTTP GET Request
    EventLoop -&gt;&gt; RESTCONF: Calls HTTP request handler
    RESTCONF -&gt;&gt; RESTCONF: api_data_get() / clicon_rpc_get()
    Note over RESTCONF, Backend: (Potentially) Establishes Unix socket to Backend
    EventLoop -&gt;&gt; Backend: backend_accept_client() for new connection from RESTCONF
    RESTCONF -&gt;&gt; Backend: Sends NETCONF &lt;get&gt; message
    EventLoop -&gt;&gt; Backend: Calls from_client()
    Backend -&gt;&gt; Backend: from_client_msg() -&gt; rpc_callback_call()
    Backend -&gt;&gt; Backend: from_client_get() -&gt; get_common() -&gt; get_state_data()
    Backend -&gt;&gt; Backend: clixon_plugin_statedata_all()
    Backend -&gt;&gt; Plugin: clixon_plugin_statedata_one() -&gt; plugin_statedata_callback()
    Plugin --&gt;&gt; Backend: Returns data
    Backend --&gt;&gt; RESTCONF: Returns NETCONF &lt;rpc-reply&gt;
    RESTCONF --&gt;&gt; Client: HTTP Response</code></pre><h3 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h3><p>Clixon 的线程模型:</p><ul><li><strong>单线程执行</strong>: 所有 Clixon 程序 (包括 clixon_backend, clixon_cli, clixon_restconf) 均作为非阻塞单线程应用程序运行.</li><li><strong>事件驱动</strong>: 通过 <code>select()</code> 监听文件描述符事件,触发对应回调</li><li><strong>同步调用</strong>: 插件回调在主线程中同步执行,一个回调未完成前,其他请求无法处理</li><li><strong>顺序处理</strong>: 事件回调按照注册优先级顺序执行,无并发机制</li></ul><p>这种设计简化了并发控制和状态管理,但要求插件开发者编写非阻塞的回调代码,以避免长时间操作阻塞整个系统.</p></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"><strong>本文作者： </strong>Jasper</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://jasper1024.com/jasper/20251050020547/" title="Clixon 线程模型">https://jasper1024.com/jasper/20251050020547/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div><div class="post-nav"><div class="post-nav-item"><a href="/jasper/20250505090125/" rel="prev" title="记录贴 - GPT 尝试 第三弹"><i class="fa fa-angle-left"></i> 记录贴 - GPT 尝试 第三弹</a></div><div class="post-nav-item"><a href="/jasper/20251050020547/" rel="next" title="Clixon 线程模型-源码">Clixon 线程模型-源码 <i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="tabs tabs-comment"><ul class="nav-tabs"><li class="tab"><a href="#comment-disqus">disqus</a></li><li class="tab"><a href="#comment-utterances">utterances</a></li></ul><div class="tab-content"><div class="tab-pane disqus" id="comment-disqus"><div class="comments" id="disqus_thread"><noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript></div></div><div class="tab-pane utterances" id="comment-utterances"><div class="comments utterances-container"></div></div></div></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2016 – <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">JasperHale</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span>站点总字数：</span> <span title="站点总字数">1.4m</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span>站点阅读时长 &asymp;</span> <span title="站点阅读时长">20:54</span></span></div><div class="powered-by">由 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZy9waXNjZXMv">NexT.Pisces</span> 强力驱动</div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="reading-progress-bar"></div><span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL0phc3Blci0xMDI0" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"jasper1024","count":true,"i18n":{"disqus":"disqus"}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/third-party/comments/disqus.min.js" defer></script><script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"Jasper-1024/blog_discuss","issue_term":"pathname","theme":"github-dark"}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/third-party/comments/utterances.min.js" defer></script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script></body></html>