<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="google-site-verification" content="M2t8cZr5nIzHmltyt7Utj3nWYxNyNkCzFyigXBHkGUs"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.31/dist/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"jasper1024.com","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.25.0","exturl":true,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"vs2015","dark":"vs2015"},"prism":{"light":"prism-vsc-dark-plus","dark":"prism-vsc-dark-plus"},"copy_button":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":true,"nav":{"disqus":{"text":"disqus","order":-1},"utteranc":{"text":"utteranc","order":-2}}},"stickytabs":true,"motion":{"enable":true,"async":true,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/config.min.js" defer></script><meta name="description" content="微尘"><meta property="og:type" content="website"><meta property="og:title" content="默"><meta property="og:url" content="https://jasper1024.com/page/32/index.html"><meta property="og:site_name" content="默"><meta property="og:description" content="微尘"><meta property="og:locale" content="zh_CN"><meta property="article:author" content="Jasper"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://jasper1024.com/page/32/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/32/index.html","title":""}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>默 - 生存是唯一的长路</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-207687331-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-207687331-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/third-party/analytics/google-analytics.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script><script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous" defer></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.31/dist/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous" defer></script><script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/comments.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/utils.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/motion.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/sidebar.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/next-boot.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/pjax.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.5.0/dist/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/third-party/search/local-search.min.js" defer></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdn.jsdelivr.net/npm/pdfobject@2.3.1/pdfobject.min.js","integrity":"sha256-jI72I8ZLVflVOisZIOaLvRew3tyvzeu6aZXFm7P7dEo="},"url":"/lib/pdf/web/viewer.html"}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/third-party/tags/pdf.min.js" defer></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@11.10.1/dist/mermaid.min.js","integrity":"sha256-BmQmdWDS8X2OTbrwELWK366LV6escyWhHHe0XCTU/Hk="}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/third-party/tags/mermaid.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/third-party/fancybox.min.js" defer></script><script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"ItayEcWO7OsLFKF2Y8SsAYG1-MdYXbMMI","app_key":"18UBQFmJXXcOQFebLovT36lh","server_url":null,"security":false}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/third-party/statistics/lean-analytics.min.js" defer></script><script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha256-UF1fgpAiu3tPJN/uCqEUHNe7pnr+QR0SQDNfgglgtcM=" crossorigin="anonymous"><script src="https://cdn.jsdelivr.net/npm/quicklink@3.0.1/dist/quicklink.umd.js" integrity="sha256-44BednzIpUeQJcY8qtLyarFu0UCCTbgmWOvaoehiFQQ=" crossorigin="anonymous" defer></script><script class="next-config" data-name="quicklink" type="application/json">{"enable":false,"home":false,"archive":false,"delay":true,"timeout":3000,"priority":true,"url":"https://jasper1024.com/page/32/"}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/third-party/quicklink.min.js" defer></script><link rel="stylesheet" href="source/_data/callout_blocks.css"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="默" type="application/rss+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">默</h1><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">生存是唯一的长路</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">45</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">330</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">65</span></a></li><li class="menu-item menu-item-guestbook"><a href="/guestbook/" rel="section"><i class="fa fa-comments fa-fw"></i>留言</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-overview-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Jasper" src="/images/avatar.jfif"><p class="site-author-name" itemprop="name">Jasper</p><div class="site-description" itemprop="description">微尘</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">330</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">45</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">65</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2phc3Blci0xMDI0" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jasper-1024"><i class="fab fa-github fa-fw"></i>GitHub</span> </span><span class="links-of-author-item"><a href="/ljy087621@gmail.com" title="E-Mail → ljy087621@gmail.com" rel="noopener me"><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly94LmNvbS9KYXNwZXJfMTAyNA==" title="Twitter → https:&#x2F;&#x2F;x.com&#x2F;Jasper_1024"><i class="fab fa-twitter fa-fw"></i>Twitter</span> </span><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly90Lm1lL2phc3BlcjEwMjQ=" title="Telegram → https:&#x2F;&#x2F;t.me&#x2F;jasper1024"><i class="fab fa-skype fa-fw"></i>Telegram</span> </span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → &#x2F;atom.xml" rel="noopener me"><i class="fas fa-rss fa-fw"></i>RSS</a></span></div></div></div><div class="back-to-top animated" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div><div class="sidebar-inner sidebar-blogroll"><div class="links-of-blogroll animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> 链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmZvcmVjaG8uY29tLw==" title="https:&#x2F;&#x2F;blog.forecho.com&#x2F;">forecho</span></li><li class="links-of-blogroll-item"><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmZvcmVjaG8uY29tL2ZyaWVuZHNoaXAtbGlua3Mv" title="https:&#x2F;&#x2F;blog.forecho.com&#x2F;friendship-links&#x2F;">友链聚合</span></li></ul></div></div><div class="pjax"></div></aside></div><div class="main-inner index posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://jasper1024.com/jasper/257d4745/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jfif"><meta itemprop="name" content="Jasper"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="默"><meta itemprop="description" content="微尘"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content=" | 默"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/jasper/257d4745/" class="post-title-link" itemprop="url">Android随手记—Glide加载Drawable对象</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2017-11-04 12:00:00" itemprop="dateCreated datePublished" datetime="2017-11-04T12:00:00Z">2017-11-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Android笔记</span></a> </span></span><span id="/jasper/257d4745/" class="post-meta-item leancloud_visitors" data-flag-title="Android随手记—Glide加载Drawable对象" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Disqus：</span> <a title="disqus" href="/jasper/257d4745/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="jasper/257d4745/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>552</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><hr><p>编程环境</p><ul><li>Android Studio 3.0</li></ul><hr><h3 id="问题"><a class="markdownIt-Anchor" href="#问题"></a> 问题</h3><ul><li><p>Glide是一个通用的图片缓存框架,但是在MyPrivacy显示appIcon时,传入 一个Drawable对象,提示类型不匹配.</p></li><li><p>(注意: 这里是直接传入Drawable对象,不是经过 R.xx 引用 !)</p></li></ul><h3 id="过程"><a class="markdownIt-Anchor" href="#过程"></a> 过程</h3><ul><li><p>查阅资料后,确认Glide不支持直接加载传入的Drawable对象,转换为bitDrawable类型也不可.</p></li><li><p>解决思路来自</p><blockquote><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2J1bXB0ZWNoL2dsaWRlL2lzc3Vlcy81ODg=">https://github.com/bumptech/glide/issues/588<i class="fa fa-external-link-alt"></i></span></p></blockquote></li><li><p>不支持直接加载,但Glide的.error(Icon)错误时显示 .placeholder(Icon)占位符,支持Drawable对象</p></li></ul><h3 id="解决"><a class="markdownIt-Anchor" href="#解决"></a> 解决</h3><ul><li>不再直接加载 .load 传入空字符串, 通过 .placeholder 简洁加载.</li><li>demo<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Drawable Icon　＝　ｘｘｘ；</span><br><span class="line"></span><br><span class="line">RequestOptions options = new RequestOptions()</span><br><span class="line">             .error(Icon)</span><br><span class="line">             .placeholder(Icon);</span><br><span class="line"></span><br><span class="line"> Glide.with(context)</span><br><span class="line">             .load(&quot;&quot;)</span><br><span class="line">             .apply(options)</span><br><span class="line">             .into(imageView);</span><br></pre></td></tr></table></figure></li></ul><h3 id="备注"><a class="markdownIt-Anchor" href="#备注"></a> 备注</h3><ul><li>placeholder 在Glide 4.x版本中,移入了 RequestOptions 对象中.</li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://jasper1024.com/jasper/ec334596/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jfif"><meta itemprop="name" content="Jasper"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="默"><meta itemprop="description" content="微尘"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content=" | 默"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/jasper/ec334596/" class="post-title-link" itemprop="url">qemu 运行 linux</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2017-09-10 10:17:11 / 修改时间：12:00:00" itemprop="dateCreated datePublished" datetime="2017-09-10T10:17:11Z">2017-09-10</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/%E5%85%B6%E4%BB%96/" itemprop="url" rel="index"><span itemprop="name">其他</span></a> </span></span><span id="/jasper/ec334596/" class="post-meta-item leancloud_visitors" data-flag-title="qemu 运行 linux" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Disqus：</span> <a title="disqus" href="/jasper/ec334596/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="jasper/ec334596/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>3.5k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>3 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><hr><ul><li>ubuntu16.04</li><li>使用busybox编译最小文件系统，使用qemu运行起来。</li><li>内容来自 奔跑吧linux内核第6章</li><li>这里将输入代码过程集合到了几个.sh文件,不做重复的工作 !</li><li>当然网好是前提,最好挂代理.</li></ul><hr><h2 id="安装工具"><a class="markdownIt-Anchor" href="#安装工具"></a> 安装工具</h2><ul><li><p>首先需要安装qemu gcc, ubuntu16.04中自带的gcc版本较低,这里我们安装书中推荐的gcc-arm-linux-gnueabi</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install qemu libncurses5-dev gcc-arm-linux-gnueabi build-essential</span><br></pre></td></tr></table></figure></li><li><p>下载busybox源码</p><ul><li><p>书中推荐版本是1.24,但最新版本已经到了busybox-1.27.2.这里我们使用最新版</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://busybox.net/downloads/busybox-1.27.2.tar.bz2</span><br></pre></td></tr></table></figure></li><li><p>解压到 busybox 文件夹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -jxvf busybox-1.27.2.tar.bz2</span><br></pre></td></tr></table></figure></li></ul></li><li><p>下载linux内核源码</p><ul><li><p>还是以配套的4.0源码为例,(提醒:内核解压后大约占800MB,请预留出足够空间)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://www.kernel.org/pub/linux/kernel/v4.x/linux-4.0.tar.gz</span><br></pre></td></tr></table></figure></li><li><p>解压到linux文件夹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -jxvf linux-4.0.tar.gz</span><br></pre></td></tr></table></figure></li></ul></li></ul><h2 id="编译最小文件系统"><a class="markdownIt-Anchor" href="#编译最小文件系统"></a> 编译最小文件系统</h2><ul><li>别问我最小文件系统是什么,我也有点😵,但是先用起来.</li></ul><hr><ul><li><p>首先利用 busybox 手工编译一个最小文件系统。<br>在busybox文件夹下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export ARCH=ARM</span><br><span class="line">export CROSS_COMPILE=arm-linux-gnueabi-</span><br><span class="line">make menuconfig</span><br><span class="line">make install</span><br></pre></td></tr></table></figure></li><li><p>进入menuconfig后,配置静态编译</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Busybox Settings ---&gt;</span><br><span class="line">Build Options ---&gt;</span><br><span class="line">[*] Build BusyBox as a static binary (no shared libs)</span><br></pre></td></tr></table></figure></li><li><p>然后 make install 编译完成。编译完成后,把 busybox 根目录下面的_install 目录拷贝到 linux-4.0 下。</p></li><li><p>进入_install 目录，创建 etc、dev 等目录。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir etc</span><br><span class="line">mkdir dev</span><br><span class="line">mkdir mnt</span><br><span class="line">mkdir -p etc/init.d/</span><br></pre></td></tr></table></figure></li><li><p>在_install /etc/init.d/目录下创建 文件名rcS 的文件，写入以下内容：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkdir –p /proc</span><br><span class="line">mkdir –p /tmp</span><br><span class="line">mkdir -p /sys</span><br><span class="line">mkdir –p /mnt</span><br><span class="line">/bin/mount -a</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -t devpts devpts /dev/pts</span><br><span class="line">echo /sbin/mdev &gt; /proc/sys/kernel/hotplug</span><br><span class="line">mdev –s</span><br></pre></td></tr></table></figure><p>同时使用 <code>chmod +x rcS</code>修改rcS的可执行权限.</p></li><li><p>在_install /etc 目录创建文件名 fstab 的文件，并写入以下内容。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">proc /proc proc defaults 0 0</span><br><span class="line">tmpfs /tmp tmpfs defaults 0 0</span><br><span class="line">sysfs /sys sysfs defaults 0 0</span><br><span class="line">tmpfs /dev tmpfs defaults 0 0</span><br><span class="line">debugfs /sys/kernel/debug debugfs defaults 0 0</span><br></pre></td></tr></table></figure></li><li><p>在_install /etc 目录创建文件名 inittab 的文件，并写入如下内容。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">::sysinit:/etc/init.d/rcS</span><br><span class="line">::respawn:-/bin/sh</span><br><span class="line">::askfirst:-/bin/sh</span><br><span class="line">::ctrlaltdel:/bin/umount -a –r</span><br></pre></td></tr></table></figure></li><li><p>在_install/dev 目录下创建如下设备节点，以root权限执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd _install/dev/</span><br><span class="line">sudo mknod console c 5 1</span><br><span class="line">sudo mknod null c 1 3</span><br></pre></td></tr></table></figure></li></ul><h3 id="sh配合chmod-x使用"><a class="markdownIt-Anchor" href="#sh配合chmod-x使用"></a> .sh(配合chmod +x使用)</h3><ul><li><p><span class="exturl" data-url="aHR0cDovL2J1aWxkLnNo">build.sh<i class="fa fa-external-link-alt"></i></span>: 编译busybox</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export ARCH=ARM</span><br><span class="line">export CROSS_COMPILE=arm-linux-gnueabi-</span><br><span class="line">make menuconfig</span><br><span class="line">make install</span><br></pre></td></tr></table></figure></li><li><p><span class="exturl" data-url="aHR0cDovL2NyZWF0LnNo">creat.sh<i class="fa fa-external-link-alt"></i></span>: _install文件夹下处理</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">rm -rf etc</span><br><span class="line">rm -rf dev</span><br><span class="line">rm -rf mnt</span><br><span class="line">mkdir etc</span><br><span class="line">mkdir dev</span><br><span class="line">mkdir mnt</span><br><span class="line">mkdir -p etc/init.d/</span><br><span class="line"></span><br><span class="line">echo &quot;mkdir -p /proc</span><br><span class="line">mkdir -p /tmp</span><br><span class="line">mkdir -p /sys</span><br><span class="line">mkdir -p /mnt</span><br><span class="line">/bin/mount -a</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -t devpts devpts /dev/pts</span><br><span class="line">echo /sbin/mdev &gt; /proc/sys/kernel/hotplug</span><br><span class="line">mdev -s</span><br><span class="line">&quot; &gt; etc/init.d/rcS</span><br><span class="line">chmod +x etc/init.d/rcS</span><br><span class="line"></span><br><span class="line">echo &quot;proc /proc proc defaults 0 0</span><br><span class="line">tmpfs /tmp tmpfs defaults 0 0</span><br><span class="line">sysfs /sys sysfs defaults 0 0</span><br><span class="line">tmpfs /dev tmpfs defaults 0 0</span><br><span class="line">debugfs /sys/kernel/debug debugfs defaults 0 0</span><br><span class="line">&quot; &gt; etc/fstab</span><br><span class="line"></span><br><span class="line">echo &quot;::sysinit:/etc/init.d/rcS</span><br><span class="line">::respawn:-/bin/sh</span><br><span class="line">::askfirst:-/bin/sh</span><br><span class="line">::ctrlaltdel:/bin/umount -a -r</span><br><span class="line">&quot; &gt; etc/inittab</span><br><span class="line"></span><br><span class="line">cd dev/</span><br><span class="line">sudo mknod console c 5 1</span><br><span class="line">sudo mknod null c 1 3</span><br></pre></td></tr></table></figure></li></ul><h2 id="编译内核"><a class="markdownIt-Anchor" href="#编译内核"></a> 编译内核</h2><ul><li><p>编译内核</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd linux-4.0</span><br><span class="line">export ARCH=arm</span><br><span class="line">export CROSS_COMPILE=arm-linux-gnueabi-</span><br><span class="line">make vexpress_defconfig</span><br><span class="line">make menuconfig</span><br></pre></td></tr></table></figure></li><li><p>配置 initramfs，在 initramfs source file 中填入_install。另外需要把 Default kernel command string 清空。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">General setup ---&gt;</span><br><span class="line">[*] Initial RAM filesystem and RAM disk (initramfs/initrd) support</span><br><span class="line">(_install) Initramfs source file(s)</span><br><span class="line">Boot options --&gt;</span><br><span class="line">()Default kernel command string</span><br></pre></td></tr></table></figure></li><li><p>配置 memory split 为“3G/1G user/kernel split”以及打开高端内存。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Kernel Features ---&gt;</span><br><span class="line">Memory split (3G/1G user/kernel split) ---&gt;</span><br><span class="line">[ *] High Memory Support</span><br></pre></td></tr></table></figure></li><li><p>开始编译 kernel</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make bzImage -j4 ARCH=arm CROSS_COMPILE=arm-linux-gnueabi-</span><br><span class="line">make dtbs</span><br></pre></td></tr></table></figure></li><li><p>运行 QEMU 来模拟 4 核 Cortex-A9 的 Versatile Express 开发平台。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-arm -M vexpress-a9 -smp 4 -m 1024M -kernel arch/arm/boot/zImage -append &quot;rdinit=/linuxrc console=ttyAMA0 loglevel=8&quot; -dtb arch/arm/boot/dts/vexpress-v2p-ca9.dtb -nographic</span><br></pre></td></tr></table></figure></li></ul><h3 id="sh配合chmod-x"><a class="markdownIt-Anchor" href="#sh配合chmod-x"></a> .sh(配合chmod +x)</h3><ul><li><p><span class="exturl" data-url="aHR0cDovL2J1aWxkLnNo">build.sh<i class="fa fa-external-link-alt"></i></span> : 编译内核</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">export ARCH=arm</span><br><span class="line">export CROSS_COMPILE=arm-linux-gnueabi-</span><br><span class="line">make vexpress_defconfig</span><br><span class="line">make menuconfig</span><br><span class="line">make bzImage -j4 ARCH=arm CROSS_COMPILE=arm-linux-gnueabi-</span><br><span class="line">make dtbs</span><br></pre></td></tr></table></figure></li><li><p><span class="exturl" data-url="aHR0cDovL3J1bi5zaA==">run.sh<i class="fa fa-external-link-alt"></i></span> : 运行arm内核</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-arm -M vexpress-a9 -smp 4 -m 1024M -kernel arch/arm/boot/zImage -append &quot;rdinit=/linuxrc console=ttyAMA0 loglevel=8&quot; -dtb arch/arm/boot/dts/vexpress-v2p-ca9.dtb -nographicyun</span><br></pre></td></tr></table></figure></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://jasper1024.com/jasper/e21031bc/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jfif"><meta itemprop="name" content="Jasper"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="默"><meta itemprop="description" content="微尘"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content=" | 默"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/jasper/e21031bc/" class="post-title-link" itemprop="url">linux笔记——看门狗内核API文档翻译</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2017-08-23 17:52:16 / 修改时间：10:10:11" itemprop="dateCreated datePublished" datetime="2017-08-23T17:52:16Z">2017-08-23</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/linux%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">linux学习</span></a> </span></span><span id="/jasper/e21031bc/" class="post-meta-item leancloud_visitors" data-flag-title="linux笔记——看门狗内核API文档翻译" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Disqus：</span> <a title="disqus" href="/jasper/e21031bc/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="jasper/e21031bc/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>6.9k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>6 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li>wdt第二弹，内核API，勉强翻译下来了，还需要进一步整理</li></ul><hr><h2 id="看门狗定时器驱动内核api"><a class="markdownIt-Anchor" href="#看门狗定时器驱动内核api"></a> 看门狗定时器驱动内核API</h2><ul><li>最后更新时间 2013.2.12</li><li>Wim Van Sebroeck <span class="exturl" data-url="bWFpbHRvOndpbUBpZ3VhbmEuYmU=">wim@iguana.be<i class="fa fa-external-link-alt"></i></span></li></ul><h3 id="介绍"><a class="markdownIt-Anchor" href="#介绍"></a> 介绍</h3><ul><li>本文档没有描述看门狗设备或驱动。也不涉及那些在用户空间调用的API，对应在 Documentation/watchdog/watchdog-api.txt</li><li>本文档描述的是，利用看门狗子系统框架方式进行看门狗驱动编写时所使用到的API。看门狗子系统框架提供了所有与用户空间交互的接口，不需要每次编写重复的代码。这意味这驱动程序只需要提供几个不同的操作函数，就可以控制WDT了。</li></ul><h3 id="api"><a class="markdownIt-Anchor" href="#api"></a> API</h3><ul><li><p>每一个想要使用看门狗核心子系统的驱动程序都必须包含<code>#include&lt;linux/watchdog.h&gt;</code>(编写驱动程序是不得不做的工作)。<code>linux/watchdog.h</code>包含以下两个注册/卸载函数：</p></li><li><pre class="highlight"><code class="shell">extern int watchdog_register_device(struct watchdog_device *);
extern void watchdog_unregister_device(struct watchdog_device *);
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 注册函数将wdt设备注册进wdt子系统，函数的参数是一个指向struct watchdog_device的结构体_。当注册成功时返回0.注册失败返回一个负值。</span><br><span class="line">* 卸载函数是将wdt设备从wdt子系统卸载，函数参数是一个指向struct watchdog_device的结构体_</span><br><span class="line">* 看门子系统包含了注册时间调整机制（原文是 an registration deferral mechanism 一种延期机制？上下文不太对啊），允许在开机阶段，你可以按照你设定的尽可早的注册一个看门狗设备。</span><br><span class="line"></span><br><span class="line">### struct watchdog_device_</span><br><span class="line"></span><br><span class="line">* 这里粘贴的是linux4.1里定义的watchdog_device，原文的watchdog_device更长但跟源码对不起来，所以这里就以内核4.1里定义的为准了😑：</span><br><span class="line"></span><br><span class="line">  ```c</span><br><span class="line">  struct watchdog_device &#123;</span><br><span class="line">    int id;</span><br><span class="line">    struct cdev cdev;</span><br><span class="line">    struct device *dev;</span><br><span class="line">    struct device *parent;</span><br><span class="line">    const struct watchdog_info *info;</span><br><span class="line">    const struct watchdog_ops *ops;</span><br><span class="line">    unsigned int bootstatus;</span><br><span class="line">    unsigned int timeout;</span><br><span class="line">    unsigned int min_timeout;</span><br><span class="line">    unsigned int max_timeout;</span><br><span class="line">    void *driver_data;</span><br><span class="line">    struct mutex lock;</span><br><span class="line">    unsigned long status;</span><br><span class="line">    /* Bit numbers for status flags */</span><br><span class="line">    #define WDOG_ACTIVE  0 /* Is the watchdog running/active */</span><br><span class="line">    #define WDOG_DEV_OPEN  1 /* Opened via /dev/watchdog ? */</span><br><span class="line">    #define WDOG_ALLOW_RELEASE 2 /* Did we receive the magic char ? */</span><br><span class="line">    #define WDOG_NO_WAY_OUT  3 /* Is &#x27;nowayout&#x27; feature set ? */</span><br><span class="line">    #define WDOG_UNREGISTERED 4 /* Has the device been unregistered */</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

</code></pre></li><li><p>包含以下字段：</p><ul><li>id：由watchdog_register_device函数注册。id 0是一个特殊的，id 0 有/dev/watchdog0 cdev（动态主设备号，次设备号0） 和 /dev/watchdog miscdev。id 在调用到watchdog_register_device时自动注册。<ul><li><strong>NOTE</strong>看源码，wdt子系统是基于misc子系统的，注册wdt设备调用的是<code>misc_register(&amp;watchdog_miscdev);</code>而misc设备主设备号只能为10,这里结论有冲突，等待解决中。。。</li></ul></li><li>parent：在调用watchdog_register_device函数前，设置父设备（或者设置为null）</li><li>info：指向watchdog_info结构体的指针，watchdog_info提供了看门狗本身的一些附加信息（像是看门狗独有的名称之类的）</li><li>ops：指向watchdog_ops结构体的指针，watchdog_ops是看门狗支持操作(函数)的集合。</li><li>bootstatus:启动后设备状态(与看门狗WDIOF_* 标志位一同开启)_</li><li>timeout:看门狗超时的时间(秒为单位).如果设置了WDOG_ACTIVE_启用了看门狗,在这个时间长度后,用户空间还没有发送心跳包,看门狗会将系统复位重启.</li><li>min_timeout:_可设置的看门狗最小超时时间</li><li>max_timeout:_可设置的看门狗最大超时时间</li><li>driver_data:_指向看门狗设备私有数据的指针,这个data只能由watchdog_set_drvdata 和 watchdog_get_drvdata routines函数访问.</li><li>struct mutex lock; <strong>原文档没有🙄</strong></li><li>status:这个字段包含了许多状态位,提供有关设备的额外信息(例如:看门狗的活动状态\限制,现在nowayout 位设置与否)(括号里翻译是否准确存疑)</li></ul></li></ul><h3 id="struct-watchdog_ops"><a class="markdownIt-Anchor" href="#struct-watchdog_ops"></a> struct watchdog_ops</h3><ul><li><p>watchdog_ops_</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watchdog_ops</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">  <span class="comment">/* mandatory operations */</span></span><br><span class="line">  <span class="type">int</span> (*start)(<span class="keyword">struct</span> watchdog_device *);</span><br><span class="line">  <span class="type">int</span> (*stop)(<span class="keyword">struct</span> watchdog_device *);</span><br><span class="line">  <span class="comment">/* optional operations */</span></span><br><span class="line">  <span class="type">int</span> (*ping)(<span class="keyword">struct</span> watchdog_device *);</span><br><span class="line">  <span class="type">unsigned</span> <span class="title function_">int</span> <span class="params">(*status)</span><span class="params">(<span class="keyword">struct</span> watchdog_device *)</span>;</span><br><span class="line">  <span class="type">int</span> (*set_timeout)(<span class="keyword">struct</span> watchdog_device *, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">  <span class="type">unsigned</span> <span class="title function_">int</span> <span class="params">(*get_timeleft)</span><span class="params">(<span class="keyword">struct</span> watchdog_device *)</span>;</span><br><span class="line">  <span class="type">void</span> (*ref)(<span class="keyword">struct</span> watchdog_device *);</span><br><span class="line">  <span class="type">void</span> (*unref)(<span class="keyword">struct</span> watchdog_device *);</span><br><span class="line">  <span class="type">long</span> (*ioctl)(<span class="keyword">struct</span> watchdog_device *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li><li><p>你一开始定义的看门狗的module owner是非常重要的,module owner 在使用看门狗时会同时锁定看门狗设备.(这样避免了在卸载模块时/dev/watchdog依然是打开状态引起的系统崩溃)</p></li><li><p>某些函数是必须实现的,其他是可选的,必须实现的函数如下:</p><ul><li>*start :*指向看门狗设备启动函数的指针.这个函数参数为一个 struct watchdog_device,_成功返回0,失败返回负数.</li><li>*stop :*通过这个函数关闭看门狗设备.这个函数参数为一个 struct watchdog_device,_成功返回0,失败返回负数.<ul><li>一些硬件看门狗设备只能启动,没有关闭选项.对应这些设备的驱动,不用实现 *stop ,*如果驱动程序没有关闭设备功能,看门狗核心层会在设备关闭后设置 WDOG_HW_RUNNING 并调用驱动程序的 keepalive pings功能.</li><li>如果看门狗驱动没有实现<em>stop</em>必须设置max_hw_heartbeat_ms_</li></ul></li></ul></li><li><p>不是所有的硬件看门狗都有相同的功能,这就是为什么会有可选函数了,只有但这项功能被硬件看门🐶支持时,才编写对应函数.</p><ul><li>ping:这是看门狗驱动实现的喂狗函数,这个函数的参数时一个指向struct watchdog_device的指针_.函数执行成功返回0,失败返回负数.<ul><li>大多数的硬件不支持直接喂狗的特殊功能,一般是直接重启硬件看门狗.</li><li>看门狗子系统的核心层也是这样做的:但定期喂狗的操作转发到硬件看门狗时,核心层在 <em>ping 实现</em>时调用喂狗函数,但喂狗函数没有实现时,使用 start 对应函数</li><li>( WDIOC_KEEPALIVE对应的 ioctl命令只有在i看门狗info里的WDIOF_KEEPALIVEPING被设置为1后才会生效 )</li></ul></li><li>status: 这个函数用来检查看门狗设备的状态,通过看门狗的WDIOF_*_状态标志位报告.WDIOF_MAGICCLOSE and WDIOF_KEEPALIVEPING由看门狗核心层报告.没有必要在驱动程序中报告.此外如果驱动程序没有实现该函数,看门狗核心层会返回 struct watchdog_device_中的bootstatus状态位.</li><li>set_timeout:这个函数设置和检查 超时时间的变化,返回0表示成功,返回-EINVAL表示超出范围,返回-EIO表示无法写入看门狗.设置成功后,函数应该将设定的超时时间写入看门狗.(或许与通过接口获取的超时时间不同,因为看门狗的分辨率不一定能到1s).<ul><li>实现了max_hw_heartbeat_ms的驱动将硬件看门狗心跳值设置为超时时间和max_hw_heartbeat_ms之间的最小值.Those drivers set the timeout value of the watchdog_device either to the requested timeout value (if it is larger than max_hw_heartbeat_ms), or to the achieved timeout value.</li><li>如果看门狗驱动程序没有执行任何操作,但设置了watchdog_device.timeout_,此回掉函数忽略.</li><li>如果没有设置 set_timeout,但设置了WDIOF_SETTIMEOUT,看门狗架构会将 watchdog_device中timeout值更新为请求的值.</li><li>如果使用了pretimeout feature (WDIOF_PRETIMEOUT),那么set_timeout 必须同时检查 pretimeout 是否有效 ,设置相应定时器. 这些操作在核心层没有races无法完成,所以必须在驱动中完成.</li></ul></li><li>set_pretimeout_:这个函数支持检查/改变看门狗中pretimeout值(pretimeout详情见wdt用户层api翻译).这个函数是可选支持的,因为不是所有的看门狗都支持这个功能.pretimeout 不是绝对时间,其数值是在超时时间之前几秒发生.<ul><li>返回0表示执行成功,返回-EINVAL,表示超出范围,返回-EIO表示未能成功向看门狗写入.</li><li>设置pretimeou为0值,代表禁用pretimeout功能.(WDIOF_PRETIMEOUT_需要在看门狗的info 结构体中设置)</li><li>如果驱动没有实现任何功能,但设定了 watchdog_device.pretimeout_,此回掉函数忽略.这意味这,如果没有提供set_pretimeout_函数,但设定了WDIOF_PRETIMEOUT_,看门狗架构会将pretimeout的值更新为请求值.</li></ul></li><li>get_timeleft:_这个函数返回复位前剩余时间.</li><li>restart:此函数重启看门狗硬件,返回0表示成功,失败返回对应错误码.</li><li>ioctl:如果这个函数存在,在系统进行内部ioctl命令处理前,会首先调用此函数.如果不支持ioctrl命令,应该返回 -ENOIOCTLCMD .这个函数的参数为(watchdog_device, cmd and arg)_</li><li>ref和unref 已经不再被支持.</li></ul></li><li><p>The status bits should (preferably) be set with the set_bit and clear_bit alike bit-operations. The status bits that are defined are:</p><ul><li><p>WDOG_ACTIVE:_这个状态位标识着从用户空间看一个看门狗设备是否被激活,如果被激活,用户空间需要执行喂狗动作</p></li><li><p>WDOG_NO_WAY_OUT:_这个状态位标识这nowayout的设置,如果被激活,那看门狗启动后,无法被停止.</p></li><li><p>WDOG_HW_RUNNING:如果硬件看门狗运行,此状态位被置1.</p><ul><li>当硬件看门狗不能被停止时,这个状态位必须被置1.</li><li>如果系统启动后自动启动看门狗,在看门狗打开前,必须设置此状态位.</li><li>当此状态位被置1,即使WDOG_ACTIVE为0_.看门狗架构也会执行喂狗动作.</li><li>(当你直接注册设置了 WDOG_HW_RUNNING位的看门狗设备时,执行open /dev/watchdog动作,系统会直接跳过启动操作,直接执行喂狗操作 )</li></ul></li><li><p>要设置WDOG_NO_WAY_OUT_状态位(在注册看门狗设备前)你可以:</p><ul><li><p>在watchdog_device_的结构体中设置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.status = WATCHDOG_NOWAYOUT_INIT_STATUS,</span><br></pre></td></tr></table></figure><p>这样等同于将WDOG_NO_WAY_OUT_值设置为CONFIG_WATCHDOG_NOWAYOUT</p></li><li><p>使用下面的函数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">static inline void watchdog_set_nowayout(struct watchdog_device *wdd, int nowayout)</span><br></pre></td></tr></table></figure></li></ul></li></ul></li><li><p>(note:) wdt驱动程序核心支持magic close和 nowayout功能.要使用magic close,需要在看门狗的 info中设置WDIOF_MAGICCLOSE_位.开启 nowayout 会覆盖magic close.</p></li><li><p>获取或设定驱动程序特殊数据,应该使用以下两个函数:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">static inline void watchdog_set_drvdata(struct watchdog_device *wdd, void *data)</span><br><span class="line">static inline void *watchdog_get_drvdata(struct watchdog_device *wdd)</span><br></pre></td></tr></table></figure><ul><li>watchdog_set_drvdata函数允许你添加向驱动程序添加特殊数据,此函数的参数为指向看门狗设备的指针,和指向需要添加数据的指针.</li><li>watchdog_get_drvdata函数运行你读取驱动程序中的特殊数据,此函数的参数为指向你想读取的看门狗设备的指针.</li></ul></li><li><p>初始化 timeout ,会用到下面的函数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extern int watchdog_init_timeout(struct watchdog_device *wdd,unsigned int timeout_parm, struct device *dev);</span><br></pre></td></tr></table></figure><ul><li>watchdog_init_timeout允许使用模块的 timeout 字段初始化 timeout ,当模块的 timeout 字段无效时,设备树中的timeout-sec也可.最好的做法是将watchdog_device_中timeout的值,设置为初始默认值,然后使用到函数的用户可以分别设置自定义值.</li></ul></li><li><p>重启后禁用看门狗,需要使用以下函数:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">static inline void watchdog_stop_on_reboot(struct watchdog_device *wdd);</span><br></pre></td></tr></table></figure></li><li><p>卸载看门狗设备时禁用看门狗,必须调用此函数,如果 nowayout 没有设置,这个函数只会停止看门狗.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">static inline void watchdog_stop_on_unregister(struct watchdog_device *wdd);</span><br></pre></td></tr></table></figure></li><li><p>更改重启处理程序的优先级,(猜测是不同看门狗的优先级)调用下面的函数:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oid watchdog_set_restart_priority(struct watchdog_device *wdd, int priority);</span><br></pre></td></tr></table></figure><ul><li>设定优先级时,用户需要遵循以下规则<ul><li>0:优先级最低,非常有限的重启能力</li><li>128:重启处理的默认选择,如果没有其他的重启处理程序可用,或者没有重启整个系统的重启处理程序可用.</li><li>255:最高优先级,会覆盖其他所有重启处理程序</li></ul></li></ul></li><li><p>使用pretimeout 通知功能,需要利用以下函数:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void watchdog_notify_pretimeout(struct watchdog_device *wdd)</span><br></pre></td></tr></table></figure><ul><li>这个函数可以在中断上下文中调用,如果启用了watchdog pretimeout governor 框架(kbuild CONFIG_WATCHDOG_PRETIMEOUT_GOV),就会采用进入驱动程序分配好的处理程序,如果没有启用watchdog pretimeout governor 框架,watchdog_notify_pretimeout()会将信息输出到内核日志缓存.</li></ul></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://jasper1024.com/jasper/d3251fe6/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jfif"><meta itemprop="name" content="Jasper"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="默"><meta itemprop="description" content="微尘"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content=" | 默"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/jasper/d3251fe6/" class="post-title-link" itemprop="url">linux笔记—看门狗API文档翻译</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2017-08-22 17:52:16 / 修改时间：10:10:11" itemprop="dateCreated datePublished" datetime="2017-08-22T17:52:16Z">2017-08-22</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/linux%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">linux学习</span></a> </span></span><span id="/jasper/d3251fe6/" class="post-meta-item leancloud_visitors" data-flag-title="linux笔记—看门狗API文档翻译" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Disqus：</span> <a title="disqus" href="/jasper/d3251fe6/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="jasper/d3251fe6/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>4.3k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>4 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><hr><ul><li>随手翻译的文档，要看懂linux内核，内核附带的文档自然是逃不过😂，全英文配合Google翻译也得上。。。。</li></ul><hr><ul><li><p>最后更新时间 10/05/2007</p></li><li><p>linux看门狗设备API</p></li><li><p>Copyright 2002 Christer Weingel <span class="exturl" data-url="bWFpbHRvOndpbmdlbEBuYW5vLXN5c3RlbS5jb20=">wingel@nano-system.com<i class="fa fa-external-link-alt"></i></span></p></li><li><p>本文档的一些内容来自 sbc60xxwdt ，版权属于 Copyright 2000 Jakob Oestergaard <span class="exturl" data-url="bWFpbHRvOmpha29iQG9zdGVuZmVsZC5kaw==">jakob@ostenfeld.dk<i class="fa fa-external-link-alt"></i></span></p></li><li><p>本文档基于linux内核 2.4.18</p></li></ul><hr><h3 id="介绍"><a class="markdownIt-Anchor" href="#介绍"></a> 介绍</h3><ul><li>你应该已经知道了，看门狗定时器（WDT）是一个硬件复位电路，在系统软件出现故障时复位系统。</li><li>通常，用户空间的定期喂狗程序通过/dev/watchdog的设备文件通知内核看门狗驱动程序。驱动收到通知，会告知硬件看门狗一切正常，硬件看门狗需要等一会再复位系统。如果用户空间通知失败（RAM错误、内核漏洞等等），通知将停止。超时后，硬件看门狗将复位系统（重启）。</li><li>linux看门狗的API是相当特殊的结构，不同的驱动程序对API的执行各不相同，有时会碰到不兼容的情况。本文档参数记录现有的情况，以供未来的驱动开发参考。</li></ul><h3 id="最简单的api"><a class="markdownIt-Anchor" href="#最简单的api"></a> 最简单的API</h3><ul><li>所有驱动都支持的基本操作模式。/dev/watchdog被打开后，看门狗被激活并复位系统，除非在一小段时间内被ping通？（喂狗），这段时间被称为超时时间或间断时间。简单的喂狗的方式是向驱动程序写入一些数据，一个非常简单的实例在<code>see samples/watchdog/watchdog-simple.c</code>下.</li><li>更高级的驱动程序可以做到例如检查一个http服务器，在执行喂狗操作之前，做出回应。</li><li>/dev/下设备节点被关闭后，看门狗也同时被禁用，除非支持“Magic Close”（见下文），这并不是个好办法。因为如果看看门狗demo有bug导致系统崩溃，但系统不会重启。因为这样一些驱动支持&quot;Disable watchdog shutdown on close&quot;, CONFIG_WATCHDOG_NOWAYOUT&quot;这样的配置选项。一旦编译内核时候启用这些选项，一旦看门狗程序激活，就不可能禁用看门狗。如果看门狗demo崩溃，系统会在超时后自动重启。看门狗驱动通常也支持nowayout module parameter，以便在运行时控制nowayout module。</li></ul><h3 id="magic-close-feature"><a class="markdownIt-Anchor" href="#magic-close-feature"></a> Magic Close feature</h3><ul><li>如果驱动程序支持<code>Magic Close</code>,那么设备将不支持禁用看门狗，除非在关闭设备文件前，向/dev/watchdog下设备文件写入特定的magic 字符 ‘V’。如果用户空间的 daemon关闭了看门的设备文件，但是没有发送那个特定的字符，驱动会认为daemon进程已经被杀，并且停止了定期喂狗行为。这样会导致超时后系统重启。</li></ul><h3 id="ioctl-api"><a class="markdownIt-Anchor" href="#ioctl-api"></a> ioctl API</h3><ul><li><p>所有的驱动程序都支持ioctl API</p></li><li><p><strong>喂狗操作使用ioctl完成</strong></p></li><li><p>所有的驱动都要支持一个KEEPALIVE的ioctl命令，这个命令可以起到向驱动写入数据一样的作用。所以watchdog daemon的主函数循环可以这样实现</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"> ioctl(fd, WDIOC_KEEPALIVE, <span class="number">0</span>);</span><br><span class="line"> sleep(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="setting-and-getting-the-timeout"><a class="markdownIt-Anchor" href="#setting-and-getting-the-timeout"></a> Setting and getting the timeout</h3><ul><li><p>某些驱动支持运行时通过SETTIMEOUT ioctl命令修改超时时间，这些驱动都有WDIOF_SETTIMEOUT的标志位_。超时时间是一个单位为秒的整数，驱动程序会返回这个变量实际设置的数值，但是由于硬件限制，返回的数值可能与设置数值不同。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> timeout = <span class="number">45</span>;</span><br><span class="line">ioctl(fd, WDIOC_SETTIMEOUT, &amp;timeout);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;The timeout was set to %d seconds\n&quot;</span>, timeout);</span><br></pre></td></tr></table></figure></li><li><p>这个实例或许会输出&quot;The timeout was set to 60 seconds&quot;，如果设备超时时间为分钟。</p></li><li><p>自从2.4.18内核开始，可以使用GETTIMEOUT ioctl命令，获取超时时间。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ioctl(fd, WDIOC_GETTIMEOUT, &amp;timeout);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;The timeout was is %d seconds\n&quot;</span>, timeout);</span><br></pre></td></tr></table></figure></li></ul><h3 id="pretimeouts"><a class="markdownIt-Anchor" href="#pretimeouts"></a> Pretimeouts</h3><ul><li><p>一些看门狗定时器可以在系统重启前一段时间设置一个触发器。这样运行linux在系统从前记录一些重要的信息（像panic信息和kernel coredumps），具体可以通过NMT、中断等机制实现。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pretimeout = <span class="number">10</span>;</span><br><span class="line">ioctl(fd, WDIOC_SETPRETIMEOUT, &amp;pretimeout);</span><br></pre></td></tr></table></figure></li><li><p>请注意，pretimeout 时间是在 超时关闭系统 之前的秒数。不是直到发生pretimeout 事件的秒数。例如设定的超时时间是60s， pretimeout是10s。pretimeout事件会在50s时发生。pretimeout设置为0代表禁用pretimeout。</p></li><li><p>同样存在一个获取pretimeout的ioctl命令。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ioctl(fd, WDIOC_GETPRETIMEOUT, &amp;timeout);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;The pretimeout was is %d seconds\n&quot;</span>, timeout);</span><br></pre></td></tr></table></figure></li><li><p>不是所有看门狗驱动都支持 pretimeout</p></li></ul><h3 id="获取重启前秒数"><a class="markdownIt-Anchor" href="#获取重启前秒数"></a> 获取重启前秒数</h3><ul><li><p>一些看门狗驱动支持获取系统重启前秒数。通过WDIOC_GETTIMELEFT ioctl_命令可以返回系统重启前秒数。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ioctl(fd, WDIOC_GETTIMELEFT, &amp;timeleft);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;The timeout was is %d seconds\n&quot;</span>, timeleft);</span><br></pre></td></tr></table></figure></li></ul><h3 id="环境监测"><a class="markdownIt-Anchor" href="#环境监测"></a> 环境监测</h3><ul><li><p>所有的看门狗驱动都被要求返回更多关于系统最后一次重启的信息，像是温度、风扇转速、电源等。GETSUPPORT ioctl 的命令可以返回 设备可以支持的信息。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watchdog_info</span> <span class="title">ident</span>;</span></span><br><span class="line">ioctl(fd, WDIOC_GETSUPPORT, &amp;ident);</span><br></pre></td></tr></table></figure></li><li><p>返回的结构ident中的字段如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">identity  描述watchdog driver的字符串</span><br><span class="line"></span><br><span class="line">firmware_version the firmware version of the card <span class="keyword">if</span> available</span><br><span class="line">options   设备支持情况的标志位</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>options描述了GET_STATUS 和GET_BOOT_STATUS ioctl命令_可以返回那些信息。并且可以设置。（）<strong>??无法理解什么意思??</strong></p></li><li><p>WDIOF_OVERHEAT cpu过热复位_<br>系统重启因为，超过了温度限制上限。</p></li><li><p>WDIOF_FANFAULT 风扇失效复位_</p></li><li><p>WDIOF_EXTERN1 External relay 1_<br>外部监控电源1被触发，？？？Controllers intended for real world applications include external monitoring pins that will trigger a reset.？？（不明白什么意思）</p></li><li><p>WDIOF_EXTERN2 External relay 2<br>外部监控电源2被触发</p></li><li><p>WDIOF_POWERUNDER 电源坏了，电源带不动了<br>机器显示欠压。</p></li></ul><hr><ul><li>后面一点不翻了，有时间再添坑</li></ul><hr><ul><li><p>WDIOF_CARDRESET Card previously reset the CPU<br>The last reboot was caused by the watchdog card</p></li><li><p>WDIOF_POWEROVER Power over voltage<br>The machine is showing an overvoltage status. Note that if one level is under and one over both bits will be set - this may seem odd but makes sense.</p></li><li><p>WDIOF_KEEPALIVEPING Keep alive ping reply<br>The watchdog saw a keepalive ping since it was last queried.</p></li><li><p>WDIOF_SETTIMEOUT Can set/get the timeout<br>The watchdog can do pretimeouts.</p></li><li><p>WDIOF_PRETIMEOUT Pretimeout (in seconds), get/set<br>For those drivers that return any bits set in the option field, the GETSTATUS and GETBOOTSTATUS ioctls can be used to ask for the current status, and the status at the last reboot, respectively.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> flags;</span><br><span class="line">ioctl(fd, WDIOC_GETSTATUS, &amp;flags);</span><br></pre></td></tr></table></figure><p>or</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ioctl(fd, WDIOC_GETBOOTSTATUS, &amp;flags);</span><br></pre></td></tr></table></figure></li><li><p>Note that not all devices support these two calls, and some only support the GETBOOTSTATUS call.</p></li><li><p>Some drivers can measure the temperature using the GETTEMP ioctl. The returned value is the temperature in degrees fahrenheit.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> temperature;</span><br><span class="line">ioctl(fd, WDIOC_GETTEMP, &amp;temperature);</span><br></pre></td></tr></table></figure></li><li><p>Finally the SETOPTIONS ioctl can be used to control some aspects of the cards operation.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> options = <span class="number">0</span>;</span><br><span class="line">ioctl(fd, WDIOC_SETOPTIONS, &amp;options);</span><br></pre></td></tr></table></figure></li><li><p>The following options are available:</p><ul><li>WDIOS_DISABLECARD Turn off the watchdog timer</li><li>WDIOS_ENABLECARD Turn on the watchdog timer</li><li>WDIOS_TEMPPANIC Kernel panic on temperature trip</li></ul></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://jasper1024.com/jasper/1b31712e/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jfif"><meta itemprop="name" content="Jasper"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="默"><meta itemprop="description" content="微尘"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content=" | 默"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/jasper/1b31712e/" class="post-title-link" itemprop="url">Linux内核C语言中的面向对象</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2017-07-11 10:17:11 / 修改时间：12:00:00" itemprop="dateCreated datePublished" datetime="2017-07-11T10:17:11Z">2017-07-11</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/linux%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">linux学习</span></a> </span></span><span id="/jasper/1b31712e/" class="post-meta-item leancloud_visitors" data-flag-title="Linux内核C语言中的面向对象" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Disqus：</span> <a title="disqus" href="/jasper/1b31712e/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="jasper/1b31712e/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>1.2k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><p>转载自”Blog of UnicornX” (<span class="exturl" data-url="aHR0cDovL3VuaWNvcm54LmdpdGh1Yi5pby8=">http://unicornx.github.io/<i class="fa fa-external-link-alt"></i></span>)</p></li><li><p>面向对象的思想在c语言中的应用，第一次看到才知道c语言还能这么用。。。</p></li></ul><hr><h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><ul><li>语言只是工具，重要的是思想。但是！！C语言用面向对象？？看了内核代码，真给那些写Linux、内核的大神跪了。。。</li><li>当然因为C语言的局限性，并非完全面向对象的实现，私有成员等就没有了。</li></ul><h3 id="封装"><a class="markdownIt-Anchor" href="#封装"></a> 封装</h3><ul><li><p>既类在C语言中的实现，实际上是 struct + 函数体 = 函数表<br>结构体里不允许存在成员函数，但是换成指向函数的指针是可以滴。</p></li><li><p>示例</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">foo_operations</span> &#123;</span></span><br><span class="line"> <span class="type">void</span> (*op_a) (<span class="keyword">struct</span> foo *, <span class="type">loff_t</span>, <span class="type">int</span>);</span><br><span class="line">  <span class="type">void</span> (*op_b) (<span class="keyword">struct</span> foo *, <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *);</span><br><span class="line">  <span class="type">void</span> (*op_c) (<span class="keyword">struct</span> foo *, <span class="type">const</span> <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *);</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure></li></ul><h3 id="继承"><a class="markdownIt-Anchor" href="#继承"></a> 继承</h3><ul><li><p>这个简单点， struct 里面套 struct ，警告熟悉c语言的应该都清除。。。这里没有父类子类的严格区分，实际上是完全自由的。</p></li><li><p>示例</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">foo</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> a;</span><br><span class="line">  <span class="type">int</span> b;</span><br><span class="line">  <span class="type">int</span> c;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">foo_operations</span> <span class="title">ops</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li></ul><h3 id="多态"><a class="markdownIt-Anchor" href="#多态"></a> 多态</h3><ul><li><p>这个是最有意思的，c语言中严格规定同一个.c文件/工程中不能存在重名函数，但是c语言的精华-指针给了思路，借助结构体，我函数名不变，每指向不同的结构体变量就行了。。。虽然还是很麻烦。。</p></li><li><p>示例</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">foo</span> <span class="title">a</span>;</span></span><br><span class="line">a-&gt;ops = ops1;</span><br><span class="line">a-&gt;ops-&gt;op_a(a);</span><br><span class="line"><span class="comment">//切换</span></span><br><span class="line">a-&gt;ops = ops2;</span><br><span class="line">a-&gt;ops-&gt;op_a(a);</span><br></pre></td></tr></table></figure></li></ul><h3 id="链表"><a class="markdownIt-Anchor" href="#链表"></a> 链表</h3><ul><li><p>内核内大量运用链表，开始不清楚真是头晕。。</p></li><li><p>示例</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>一个指向自身的结构体，包含下一个与自身的指针。<br>使用</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">A_LIST</span> &#123;</span></span><br><span class="line">  <span class="type">data_t</span>            data;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    *<span class="title">list</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li><li><p>offsetof宏</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> offsetof(type, member) (size_t)&amp;(((type*)0)-&gt;member)</span></span><br></pre></td></tr></table></figure><p>offsetof是用来判断结构体中成员的偏移位置</p></li><li><p>container_of_宏</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> container_of(ptr, type, member) (&#123; \</span></span><br><span class="line"><span class="meta">   const typeof( ((type *)0)-&gt;member ) *__mptr = (ptr); \</span></span><br><span class="line"><span class="meta">   (type *)( (char *)__mptr - offsetof(type,member) );&#125;)</span></span><br></pre></td></tr></table></figure><p>根据一个结构体变量中的一个域成员变量的指针来获取指向整个结构体变量的指针…链表元素常用</p></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://jasper1024.com/jasper/4dda4cf7/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jfif"><meta itemprop="name" content="Jasper"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="默"><meta itemprop="description" content="微尘"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content=" | 默"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/jasper/4dda4cf7/" class="post-title-link" itemprop="url">Android笔记—乐联网上传数据 TCP长连接总结</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2017-06-11 12:00:00" itemprop="dateCreated datePublished" datetime="2017-06-11T12:00:00Z">2017-06-11</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Android笔记</span></a> </span></span><span id="/jasper/4dda4cf7/" class="post-meta-item leancloud_visitors" data-flag-title="Android笔记—乐联网上传数据 TCP长连接总结" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Disqus：</span> <a title="disqus" href="/jasper/4dda4cf7/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="jasper/4dda4cf7/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>7.9k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>7 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><hr><p>资料来源如下</p><ul><li>乐联网</li></ul><p>编程环境</p><ul><li>Android Studio 2.2.3</li></ul><hr><h2 id="最终效果"><a class="markdownIt-Anchor" href="#最终效果"></a> 最终效果</h2><ul><li>使用okhttp上传数据。</li><li>Tcp长连接实现方向控制</li><li>以代码为主</li></ul><h2 id="相关教程"><a class="markdownIt-Anchor" href="#相关教程"></a> 相关教程</h2><ul><li><p>okhttp入门</p><blockquote><p><span class="exturl" data-url="aHR0cDovL2Jsb2cuY3Nkbi5uZXQvYmllemhpaHVhL2FydGljbGUvZGV0YWlscy81MDYwMzYyNA==">http://blog.csdn.net/biezhihua/article/details/50603624<i class="fa fa-external-link-alt"></i></span></p></blockquote></li><li><p>乐联网</p><blockquote><p><span class="exturl" data-url="aHR0cHM6Ly93d3cubGV3ZWk1MC5jb20vZGV2L2RvYy8xNzY=">https://www.lewei50.com/dev/doc/176<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cubGV3ZWk1MC5jb20vZGV2L2RvYy8xNTU=">https://www.lewei50.com/dev/doc/155<i class="fa fa-external-link-alt"></i></span></p></blockquote></li><li><p>Tcp长连接</p><blockquote><p><span class="exturl" data-url="aHR0cDovL2xzMTUxMTQ4NDM1NjkuYmxvZy41MWN0by5jb20vMTEwMTUzOTkvMTc2NzE5NQ==">http://ls15114843569.blog.51cto.com/11015399/1767195<i class="fa fa-external-link-alt"></i></span></p></blockquote></li><li><p>简易上传</p><blockquote><p><span class="exturl" data-url="aHR0cDovL2xzMTUxMTQ4NDM1NjkuYmxvZy41MWN0by5jb20vMTEwMTUzOTkvMTc2NzE5NQ==">http://ls15114843569.blog.51cto.com/11015399/1767195<i class="fa fa-external-link-alt"></i></span></p></blockquote></li></ul><h2 id="上传数据"><a class="markdownIt-Anchor" href="#上传数据"></a> 上传数据</h2><ul><li><p>API介绍</p><blockquote><p><span class="exturl" data-url="aHR0cHM6Ly93d3cubGV3ZWk1MC5jb20vZGV2L2FwaWluZm8vMw==">https://www.lewei50.com/dev/apiinfo/3<i class="fa fa-external-link-alt"></i></span></p></blockquote></li><li><p>API测试</p><blockquote><p><span class="exturl" data-url="aHR0cHM6Ly93d3cubGV3ZWk1MC5jb20vZGV2L2FwaXRlc3QvMw==">https://www.lewei50.com/dev/apitest/3<i class="fa fa-external-link-alt"></i></span></p></blockquote></li><li><p>地址：<span class="exturl" data-url="aHR0cDovL3d3dy5sZXdlaTUwLmNvbS9hcGkvdjEvZ2F0ZXdheS91cGRhdGVzZW5zb3JzLyVFNCVCRCVBMCVFNyU5QSU4NCVFNyVCRCU5MSVFNSU4NSVCMyVFNSU4RiVCNw==">http://www.lewei50.com/api/v1/gateway/updatesensors/你的网关号<i class="fa fa-external-link-alt"></i></span></p><p>POST方式</p><p>需要配置header头 Userkey</p></li><li><p>数据发送/返回方式JSON</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span><span class="string">&quot;T1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Value&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span><span class="string">&quot;01H1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Value&quot;</span><span class="punctuation">:</span><span class="string">&quot;96.2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>返回格式</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Successful&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Message&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li><li><p>okhttp POST 传感器数据 这里使用了一个静态内部类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">//返回数据处理</span></span><br><span class="line">  <span class="keyword">public</span> okhttp3.<span class="type">Callback</span> <span class="variable">callback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">okhttp3</span>.Callback() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(Call call, Response response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">          <span class="comment">//返回服务器内容</span></span><br><span class="line">          <span class="type">String</span> <span class="variable">responsedata</span> <span class="operator">=</span> response.body().string();</span><br><span class="line">          LogUtil.d(<span class="string">&quot;okHttp&quot;</span>, responsedata);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Call call, IOException e)</span> &#123;</span><br><span class="line">          <span class="comment">//异常处理</span></span><br><span class="line">          LogUtil.d(<span class="string">&quot;okHttp&quot;</span>, <span class="string">&quot;POST错误&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//内部类</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Http</span> &#123;</span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">MediaType</span> <span class="variable">MEDIA_TYPE_MARKDOWN</span></span><br><span class="line">              <span class="operator">=</span> MediaType.parse(<span class="string">&quot;text/x-markdown; charset=utf-8&quot;</span>);</span><br><span class="line"><span class="comment">//POST数据，指定接收回掉</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">postData</span><span class="params">(String sensor_name, String sensor_data, okhttp3.Callback callback)</span> &#123;</span><br><span class="line">          <span class="type">OkHttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>();</span><br><span class="line">          <span class="keyword">final</span> <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span></span><br><span class="line">                  <span class="string">&quot;[&quot;</span> +</span><br><span class="line">                          <span class="string">&quot;    &#123;&quot;</span> +</span><br><span class="line">                          <span class="string">&quot;        \&quot;Name\&quot;:\&quot;&quot;</span> + sensor_name + <span class="string">&quot;\&quot;,&quot;</span> +</span><br><span class="line">                          <span class="string">&quot;        \&quot;Value\&quot;:\&quot;&quot;</span> + sensor_data + <span class="string">&quot;\&quot;&quot;</span> +</span><br><span class="line">                          <span class="string">&quot;    &#125;&quot;</span> +</span><br><span class="line">                          <span class="string">&quot;]&quot;</span>;</span><br><span class="line">          <span class="type">RequestBody</span> <span class="variable">requestBody</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestBody</span>() &#123;</span><br><span class="line">              <span class="meta">@Override</span></span><br><span class="line">              <span class="keyword">public</span> MediaType <span class="title function_">contentType</span><span class="params">()</span> &#123;</span><br><span class="line">                  <span class="keyword">return</span> MEDIA_TYPE_MARKDOWN;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="meta">@Override</span></span><br><span class="line">              <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeTo</span><span class="params">(BufferedSink sink)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                  sink.write(value.getBytes());</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;;</span><br><span class="line">          <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">                  .url(<span class="string">&quot;http://www.lewei50.com/api/V1/gateway/UpdateSensors/01&quot;</span>)</span><br><span class="line">                  .header(<span class="string">&quot;userkey&quot;</span>, <span class="string">&quot;你的userkey&quot;</span>)</span><br><span class="line">                  .post(requestBody)</span><br><span class="line">                  .build();</span><br><span class="line">          client.newCall(request).enqueue(callback);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li><li><p>实际使用 放在一个后台服务内，调用相当简单</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Http.postData(<span class="string">&quot;PM2.5&quot;</span>, <span class="string">&quot;你的数据转为String&quot;</span>, callback);</span><br></pre></td></tr></table></figure></li></ul><h2 id="tcp长连接远程控制"><a class="markdownIt-Anchor" href="#tcp长连接远程控制"></a> Tcp长连接，远程控制</h2><ul><li><p>首先参考<span class="exturl" data-url="aHR0cHM6Ly93ZW5rdS5iYWlkdS5jb20vdmlldy9mMzQ1N2I2M2RkMzM4M2M0YmI0Y2QyZjAuaHRtbA==">乐联网反向控制教程<i class="fa fa-external-link-alt"></i></span>，新建一个控制器，这里以开关为例。</p></li><li><p>原理是与服务器保持一个TCP长连接，不到40s刷新一次，以此保持通道，与被控制段通信，发送控制信息。</p></li><li><p>Tcp长连接参考了@墨迹流韶的<span class="exturl" data-url="aHR0cDovL2Jsb2cuY29jb3Blci5jb20vMjAxNy8wMS8yMS9BbmRyb2lkL0NvbW1vbi8yMDE3LTAxLTIxLUFuZHJvaWQlRTUlOUYlQkElRTQlQkElOEVUY3AlRTUlOEQlOEYlRTglQUUlQUUlRTclOUElODRTb2NrZXQlRTklOTUlQkYlRTklOTMlQkUlRTYlOEUlQTUlRTUlQjAlODElRTglQTMlODUv">Android基于Tcp协议的Socket长链接封装<i class="fa fa-external-link-alt"></i></span></p></li><li><p>地址 <span class="exturl" data-url="aHR0cDovL3RjcC5sZXdlaTUwLmNvbQ==">tcp.lewei50.com<i class="fa fa-external-link-alt"></i></span><br>端口号 9960<br>心跳包间隔 1min以内</p></li><li><p>发送/接收数据格式 Json<br>本地发送数据格式</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;update&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;gatewayNo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;你的网关号&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;userkey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;你的userkey&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#125;</span>&amp;^!</span><br></pre></td></tr></table></figure><p>服务器发送控制命令格式，数据处理时需要去掉字符串最后的&amp;^!</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;send&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&quot;gatewayNo&quot;</span><span class="punctuation">:</span><span class="string">&quot;01&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&quot;userkey&quot;</span><span class="punctuation">:</span><span class="string">&quot;6d16ddb3c58c4e448a7e15e7acxxxxxx&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&quot;f&quot;</span><span class="punctuation">:</span><span class="string">&quot; updateSensor&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&quot;p1&quot;</span><span class="punctuation">:</span><span class="string">&quot;D1&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&quot;p2&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#125;</span>&amp;^!</span><br></pre></td></tr></table></figure><p>本地响应控制命令后返回数据格式</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;response&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&quot;result&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;ok!&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line"></span><br><span class="line">       <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;D1&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  	<span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#125;</span>&amp;^!</span><br></pre></td></tr></table></figure></li><li><p>TCP连接类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TcpSocketHelper</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">String</span> <span class="variable">mTag</span> <span class="operator">=</span> <span class="string">&quot;TcpSocketHelper&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> Socket socket;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">boolean</span> _connect;</span><br><span class="line">  <span class="keyword">private</span> ReceiveThread mReceiveThread;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">boolean</span> receiveStop;</span><br><span class="line">  <span class="keyword">private</span> Date lastKeepAliveOkTime;</span><br><span class="line">  <span class="keyword">private</span> OnRecivedListener mRecivedListener;</span><br><span class="line">  <span class="comment">//地址</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">String</span> <span class="variable">mIpAddr</span> <span class="operator">=</span> <span class="string">&quot;http://tcp.lewei50.com&quot;</span>;</span><br><span class="line">  <span class="comment">//端口</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> <span class="variable">mPort</span> <span class="operator">=</span> <span class="number">9960</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 开启链接socket</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> ipAddr</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> port</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startConnect</span><span class="params">(String ipAddr, <span class="type">int</span> port)</span>&#123;</span><br><span class="line">      LogUtil.d(mTag, <span class="string">&quot;准备链接...&quot;</span>);</span><br><span class="line">      <span class="built_in">this</span>.mIpAddr = ipAddr;</span><br><span class="line">      <span class="built_in">this</span>.mPort = port;</span><br><span class="line">      InetAddress serverAddr;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          socket = <span class="keyword">new</span> <span class="title class_">Socket</span>(ipAddr, port);</span><br><span class="line">          LogUtil.d(mTag, <span class="string">&quot;准备链接...&quot;</span>);</span><br><span class="line">          _connect = <span class="literal">true</span>;</span><br><span class="line">          mReceiveThread = <span class="keyword">new</span> <span class="title class_">ReceiveThread</span>();</span><br><span class="line">          receiveStop = <span class="literal">false</span>;</span><br><span class="line">          mReceiveThread.start();</span><br><span class="line">          LogUtil.d(mTag, <span class="string">&quot;链接成功...&quot;</span>);</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          LogUtil.d(mTag, <span class="string">&quot;链接出错...&quot;</span> + e.getMessage());</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 关闭链接</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">closeConnect</span><span class="params">()</span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (socket != <span class="literal">null</span>)&#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              socket.close();</span><br><span class="line">              socket = <span class="literal">null</span>;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">              e.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 保持心跳</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">KeepAlive</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="comment">// 判断socket是否已断开,断开就重连</span></span><br><span class="line">      <span class="keyword">if</span> (lastKeepAliveOkTime != <span class="literal">null</span>) &#123;</span><br><span class="line">          LogUtil.d(mTag, <span class="string">&quot;上次心跳成功时间:&quot;</span>+ DateFormat.format(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>, lastKeepAliveOkTime));</span><br><span class="line">          <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> Calendar.getInstance().getTime();</span><br><span class="line">          <span class="type">long</span> <span class="variable">between</span> <span class="operator">=</span> (now.getTime() - lastKeepAliveOkTime.getTime());<span class="comment">// 得到两者的毫秒数</span></span><br><span class="line">          <span class="keyword">if</span> (between &gt; <span class="number">60</span> * <span class="number">1000</span>) &#123;</span><br><span class="line">              LogUtil.d(mTag, <span class="string">&quot;心跳异常超过40,重新连接:&quot;</span>);</span><br><span class="line">              lastKeepAliveOkTime = <span class="literal">null</span>;</span><br><span class="line">              socket = <span class="literal">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          lastKeepAliveOkTime = Calendar.getInstance().getTime();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!checkIsAlive()) &#123;</span><br><span class="line">          LogUtil.d(mTag, <span class="string">&quot;链接已断开,重新连接.&quot;</span>);</span><br><span class="line">          startConnect(mIpAddr, mPort);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 此方法是检测是否连接</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkIsAlive</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (socket == <span class="literal">null</span>||!socket.isConnected())</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 发送数据的方法</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendmessage</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">      <span class="type">boolean</span> <span class="variable">isAlive</span> <span class="operator">=</span> checkIsAlive();</span><br><span class="line">      <span class="keyword">if</span> (!isAlive)</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      LogUtil.d(mTag, <span class="string">&quot;准备发送消息:&quot;</span> + msg);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (socket != <span class="literal">null</span> &amp;&amp; socket.isConnected()) &#123;</span><br><span class="line">              <span class="keyword">if</span> (!socket.isOutputShutdown()) &#123;</span><br><span class="line"></span><br><span class="line">                  <span class="comment">//2.得到socket读写流</span></span><br><span class="line">                  OutputStream os=socket.getOutputStream();</span><br><span class="line">                  <span class="comment">//true:是否自动flush</span></span><br><span class="line">                  PrintWriter outStream=<span class="keyword">new</span> <span class="title class_">PrintWriter</span>(os, <span class="literal">true</span>);</span><br><span class="line">                  outStream.print(msg);</span><br><span class="line">                  outStream.flush();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          LogUtil.d(mTag, <span class="string">&quot;发送成功!&quot;</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 设置接收数据监听器</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> mRecivedListener</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setmRecivedListener</span><span class="params">(OnRecivedListener mRecivedListener)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.mRecivedListener = mRecivedListener;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 数据接收线程</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">ReceiveThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  sleep(<span class="number">2000</span>);</span><br><span class="line">                    <span class="comment">// 判断 Socket 是否处于连接状态</span></span><br><span class="line">                  <span class="keyword">if</span> (socket != <span class="literal">null</span> &amp;&amp; socket.isConnected()) &#123;</span><br><span class="line">                      <span class="comment">// 客户端接收服务器端的响应，读取服务器端向客户端的输入流</span></span><br><span class="line">                      <span class="type">InputStream</span> <span class="variable">isRead</span> <span class="operator">=</span> socket.getInputStream();</span><br><span class="line">                      <span class="comment">// 缓冲区</span></span><br><span class="line">                      <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[isRead.available()];</span><br><span class="line">                      <span class="comment">// 读取缓冲区</span></span><br><span class="line">                      isRead.read(buffer);</span><br><span class="line">                      <span class="comment">// 转换为字符串</span></span><br><span class="line">                      <span class="type">String</span> <span class="variable">responseInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(buffer);</span><br><span class="line">                      <span class="comment">// 日志中输出</span></span><br><span class="line">                      <span class="keyword">if</span>(responseInfo != <span class="literal">null</span>&amp;&amp;!responseInfo.equals(<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">                          LogUtil.d(<span class="string">&quot;TcpManager&quot;</span>, <span class="string">&quot;返回：&quot;</span>+responseInfo);</span><br><span class="line">                          mRecivedListener.onRecived(responseInfo);</span><br><span class="line">                      &#125;</span><br><span class="line"></span><br><span class="line">                      lastKeepAliveOkTime = Calendar.getInstance().getTime();</span><br><span class="line">                      KeepAlive();</span><br><span class="line"></span><br><span class="line">                      <span class="keyword">continue</span>;</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      <span class="keyword">if</span> (socket != <span class="literal">null</span>)</span><br><span class="line">                          LogUtil.d(mTag, <span class="string">&quot;链接状态:&quot;</span> + socket.isConnected());</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">              &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                  LogUtil.d(mTag, <span class="string">&quot;监听出错:&quot;</span> + e.toString());</span><br><span class="line">                  e.printStackTrace();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>使用,包装在一个后台service中，在service中实现TcpSocketHelper的onRecived方法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  //tcp返回信息</span><br><span class="line">  @Override</span><br><span class="line">  public void onRecived(String data) &#123;</span><br><span class="line">      LogUtil.d(&quot;okHttpService&quot;, data);</span><br><span class="line">      //处理服务器发回的数据</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">TcpSocketHelper tcpSocketHelper  = new TcpSocketHelper();</span><br><span class="line">tcpSocketHelper.startConnect(&quot;tcp.lewei50.com&quot;, 9960);</span><br><span class="line">//设置监听</span><br><span class="line">tcpSocketHelper.setmRecivedListener(this);</span><br></pre></td></tr></table></figure></li><li><p>发送心跳包</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span></span><br><span class="line">          <span class="string">&quot;    &#123;&quot;</span> +</span><br><span class="line">                  <span class="string">&quot;        \&quot;method\&quot;:\&quot;update\&quot;,&quot;</span> +</span><br><span class="line">                  <span class="string">&quot;        \&quot;gatewayNo\&quot;:\&quot;01\&quot;,&quot;</span> +</span><br><span class="line">                  <span class="string">&quot;        \&quot;userkey\&quot;:\&quot;你的userkey\&quot;&quot;</span> +</span><br><span class="line">                  <span class="string">&quot;    &#125;&amp;^!&quot;</span>;</span><br><span class="line"> <span class="comment">//发送数据</span></span><br><span class="line"> tcpSocketHelper.sendmessage(value);</span><br></pre></td></tr></table></figure></li><li><p>处理数据 在service的onRecived中</p></li><li><p>本地处理完毕后，向服务器返回被控制器状态</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">value5</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;method\&quot;:\&quot;response\&quot;,\&quot;result\&quot;:&#123;\&quot;successful\&quot;:true,\&quot;message\&quot;:\&quot;ok!\&quot;,\&quot;data\&quot;:[&#123;\&quot;id\&quot;:\&quot;D1\&quot;,\&quot;value \&quot;:\&quot;1\&quot;&#125;]&#125;&#125;&amp;^! &quot;</span>;</span><br><span class="line"></span><br><span class="line">tcpSocketHelper.sendmessage(value6);</span><br></pre></td></tr></table></figure></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://jasper1024.com/jasper/2c46ee71/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jfif"><meta itemprop="name" content="Jasper"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="默"><meta itemprop="description" content="微尘"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content=" | 默"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/jasper/2c46ee71/" class="post-title-link" itemprop="url">Android笔记—Activity</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2016-12-07 12:00:00" itemprop="dateCreated datePublished" datetime="2016-12-07T12:00:00Z">2016-12-07</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2017-05-08 12:00:00" itemprop="dateModified" datetime="2017-05-08T12:00:00Z">2017-05-08</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Android笔记</span></a> </span></span><span id="/jasper/2c46ee71/" class="post-meta-item leancloud_visitors" data-flag-title="Android笔记—Activity" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Disqus：</span> <a title="disqus" href="/jasper/2c46ee71/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="jasper/2c46ee71/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>12k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>11 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><hr><ul><li>资料来源如下</li><li>第一行代码(第二版)</li></ul><hr><h2 id="activity基础"><a class="markdownIt-Anchor" href="#activity基础"></a> Activity基础</h2><h3 id="activity定义"><a class="markdownIt-Anchor" href="#activity定义"></a> Activity定义</h3><ul><li>Activity 是Android四大组件之一，用户可与其提供的屏幕进行交互，以执行操作。 每个 Activity 都会获得一个用于绘制其用户界面的窗口。窗口可以充满屏幕，也可浮动。应用通常由多个彼此联系的 Activity 组成。应用中的某个 Activity 为“主”Activity，即首次启动应用时的Activity。</li></ul><h3 id="创建activity"><a class="markdownIt-Anchor" href="#创建activity"></a> 创建Activity</h3><ul><li><p>新建FirstAtivity继承自AppCompatActivity</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FirstActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span>&#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span>  <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure></li><li><p>创建加载布局<br><a target="_blank" rel="noopener external nofollow noreferrer" href="http://snapgr.am/image/LoY4"><img data-src="https://i.loli.net/2019/03/26/5c9a2a9bf2a52.jpg" alt="1.jpg"></a></p></li><li><p>切换到first-layout</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  &lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="line">  &lt;LinearLayout</span><br><span class="line">  xmlns:android=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="line">  android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">  android:layout_height=<span class="string">&quot;match_parent&quot;</span>&gt;</span><br><span class="line">  &lt;Button</span><br><span class="line">      android:id=<span class="string">&quot;@+id/button_1&quot;</span></span><br><span class="line">      android:text=<span class="string">&quot;button_1&quot;</span></span><br><span class="line">      android:layout_width=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">      android:layout_height=<span class="string">&quot;wrap_content&quot;</span> /&gt;</span><br><span class="line">&lt;/LinearLayout&gt;</span><br></pre></td></tr></table></figure></li><li><p>在FirestActivity中加载layout<br>在onCreate中加入</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setContentView(R.layout.first_layout);</span><br></pre></td></tr></table></figure></li><li><p>在AndroidMainfest文件中注册。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;activity</span><br><span class="line">           android:name=<span class="string">&quot;.FirstActivity&quot;</span></span><br><span class="line">           android:label=<span class="string">&quot;This is FirstActivity&quot;</span>&gt;</span><br><span class="line">           &lt;intent-filter&gt;</span><br><span class="line">               &lt;action android:name=<span class="string">&quot;android.intent.action.MAIN&quot;</span>/&gt;</span><br><span class="line">               &lt;category android:name=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span>/&gt;</span><br><span class="line">           &lt;/intent-filter&gt;</span><br><span class="line">&lt;/activity&gt;</span><br></pre></td></tr></table></figure></li><li><p>在模拟器中启动apk<br><a target="_blank" rel="noopener external nofollow noreferrer" href="http://snapgr.am/image/LogP"><img data-src="https://i.loli.net/2019/03/26/5c9a2ab459df5.jpg" alt="5ea429.jpg"></a></p></li></ul><h3 id="使用toast"><a class="markdownIt-Anchor" href="#使用toast"></a> 使用Toast</h3><blockquote><p><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vZ3VpZGUvdG9waWNzL3VpL25vdGlmaWVycy90b2FzdHMuaHRtbCNQb3NpdGlvbmluZw==">Toast google官方说明<i class="fa fa-external-link-alt"></i></span></p></blockquote><ul><li><p>推送一个短小信息推送给用户<br>如图（摘自android developer）<br><img data-src="https://i.loli.net/2019/03/26/5c9a2acc54d34.png" alt="toast.png"></p></li><li><p>使用方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Toast.makeText(context, text, duration).show();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>举例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Toast.makeText(FirstActivity.<span class="built_in">this</span>, <span class="string">&quot;you clicked button 1&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line"><span class="comment">/*                  activity.this   消息内容                显示时间设置   */</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="使用menu"><a class="markdownIt-Anchor" href="#使用menu"></a> 使用Menu</h3><ul><li><p>创建菜单</p><ul><li>在res下新疆menu文件夹，右击menu文件夹—new—Menu resource file，创建main的菜单文件。</li><li>main.xml中添加如下代码<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">menu</span>        <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">item</span></span></span><br><span class="line"><span class="tag">     <span class="attr">android:id</span>=<span class="string">&quot;@+id/add_item&quot;</span></span></span><br><span class="line"><span class="tag">     <span class="attr">android:title</span>=<span class="string">&quot;Add&quot;</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">item</span></span></span><br><span class="line"><span class="tag">     <span class="attr">android:id</span>=<span class="string">&quot;@+id/remove_item&quot;</span></span></span><br><span class="line"><span class="tag">     <span class="attr">android:title</span>=<span class="string">&quot;Remove&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">menu</span>&gt;</span></span><br></pre></td></tr></table></figure>这里创建了两个菜单项 Add和Remove</li><li>在FirestActivity中重写 onCreateOptionsMenu()方法（快捷键 Ctrl+O）<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> &#123;</span><br><span class="line">    getMenuInflater().inflate(R.menu.main, menu);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><code>getMenuInflater()</code>可以得到MenuInflater对象，再调用.inflate就可以创建菜单。.inflat接受俩个参数，一是资源文件名，二是菜单项添加至那个对象中。onCreateOptionsMenu方法中返回true表示创建菜单并显示。</li><li>效果如下。<br><img data-src="https://i.loli.net/2019/03/26/5c9a2ae41cb42.png" alt="Screenshot_1481113497.png"></li></ul></li><li><p>创建菜单点击响应事件</p><ul><li>重写onOptionsItemSelected方法<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> &#123;</span><br><span class="line">   <span class="keyword">switch</span> (item.getItemId()) &#123;</span><br><span class="line">       <span class="keyword">case</span> R.id.add_item:</span><br><span class="line">           Toast.makeText(<span class="built_in">this</span>, <span class="string">&quot;Add&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">case</span> R.id.remove_item:</span><br><span class="line">           Toast.makeText(<span class="built_in">this</span>, <span class="string">&quot;Remove&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">default</span>:</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>通过item.getItemId()判断点击选项，弹出不同的Toast</li></ul></li></ul><h3 id="向一个activity-并传递字符串"><a class="markdownIt-Anchor" href="#向一个activity-并传递字符串"></a> 向一个activity 并传递字符串</h3><ul><li><p>构建一个Intent<br><code>Intent intent = new Intent(this, DisplayMessageActivity.class);</code><br>构造方法有两个参数：<br>Context 是第一个参数，这里使用了this是因为Activity是Context的子类。<br>Class 类是系统将要分发的APP组件，在这里，这个Activity将会被启动。</p></li><li><pre class="highlight"><code class="java"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(View view)</span> &#123;
    <span class="comment">// 创建一个新的intent对象，绑定DisplayMessageActivity</span>
    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="built_in">this</span>, DisplayMessageActivity.class);
    <span class="comment">//创建一个editText对象，绑定xml中editText</span>
    <span class="type">EditText</span> <span class="variable">editText</span> <span class="operator">=</span> (EditText) findViewById(R.id.edit_message);
    <span class="comment">//获取editText中输入文字，转成字符串</span>
    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> editText.getText().toString();
    <span class="comment">//一个Intent对象可以携带被称为extras的键值对。</span>
    <span class="comment">// putExtra()方法将键放在第一个参数中，将值放在第二个参数中。</span>
    intent.putExtra(EXTRA_MESSAGE, message);
    <span class="comment">//启动intent对应Activity</span>
    startActivity(intent);
    &#125;
&lt;!--code￼<span class="number">9</span>--&gt;

</code></pre></li></ul><h3 id="返回数据给上一个activity"><a class="markdownIt-Anchor" href="#返回数据给上一个activity"></a> 返回数据给上一个Activity</h3><ul><li><p>构建Intent使用startActivityForResult()方法传入请求码，启动下一个Activity<br>在下一个Activity中构建Intent，intent.putExtra存入键值-key，调用setResult()方法，传入finish()结束掉Activity<br>重写第一个Activity中的onActivityResult()方法，调用.getStringExtra取出key对应键值。</p></li><li><p>startActivityForResult(Intent, int Bundle) Intent与单纯启动Activity的Intent相同，第二个是请求码，下一级 回调提供相同的请求码，以便您应用可以正确识别结果。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(FirestActivity.<span class="built_in">this</span>,ScendActivity.class);</span><br><span class="line">startActivityForResult(intent,<span class="number">1</span>);</span><br></pre></td></tr></table></figure></li><li><p>setResult()方法，第一个参数向上级方法处理结果，一般使用RESULT_OK或RESULT_CANCELED，第二个参数 对应Intent</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//新建显示Intent</span></span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line"><span class="comment">//存入key-键值</span></span><br><span class="line">intent.putExtra(<span class="string">&quot;data_return&quot;</span>,<span class="string">&quot;Hello Firest&quot;</span>);</span><br><span class="line">setResult(RESULT_OK,intent);</span><br><span class="line"><span class="comment">//结束Activity</span></span><br><span class="line">finish();</span><br></pre></td></tr></table></figure></li><li><p>onActivityResult()三个参数.第一个startActivityForResult() 传递的请求代码。第二个 Activity 指定的结果代码。成功是 RESULT_OK；失败，则是 RESULT_CANCELED。第三个是传送结果数据的 Intent。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onActivityResult</span><span class="params">(<span class="type">int</span> requestCode,<span class="type">int</span> resultCode,Intent data)</span>&#123;</span><br><span class="line">    <span class="comment">//选择不同请求码对应处理逻辑</span></span><br><span class="line">    <span class="keyword">switch</span>(requestCode)&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="comment">//处理结果时候ok</span></span><br><span class="line">            <span class="keyword">if</span>(resultCode == RESULT_OK)&#123;</span><br><span class="line">                <span class="comment">//取出数据</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">returnedData</span> <span class="operator">=</span> data.getStringExtra(<span class="string">&quot;data_return&quot;</span>);</span><br><span class="line">                Log.d(<span class="string">&quot;FirstActivity&quot;</span>, returnedData);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="activity生命周期"><a class="markdownIt-Anchor" href="#activity生命周期"></a> Activity生命周期</h2><p><img data-src="https://i.loli.net/2019/03/26/5c9a2afc17732.png" alt="basic-lifecycle.png"></p><ul><li>Activity 3种状态<ul><li>Resumed/继续<br>Activity 处于前台，且用户可以与其交互</li><li>Paused/暂停<br>Activity 被在前台中处于另一个 Activity—部分阻挡。 暂停的 Activity 不会接收用户输入并且无法执行任何代码。</li><li>Stopped/停止<br>Activity完全隐藏，对用户完全不可见.当停止时，activity的所有状态信息比如成员变量都会被保留，但是不能再执行任何代码</li></ul></li></ul><h3 id="启动一个activity"><a class="markdownIt-Anchor" href="#启动一个activity"></a> 启动一个Activity</h3><ul><li>onCreate方法</li><li>主Activity：<ul><li>用户点击app图标，启动主Activity</li><li>在AndroidManifest.xml中声明<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul></li><li>通过调用onCreate方法创建一个Activity实例，onCreate方法在Activity的整个生命周期中只执行一次。</li><li>之后系统会很快的调用onStart和onResume方法，Activity进入Resumed/继续模式。直到被其他activity覆盖/屏幕关闭。</li></ul><h3 id="销毁activity"><a class="markdownIt-Anchor" href="#销毁activity"></a> 销毁Activity</h3><ul><li>onDestory方法<br>大多数的APP不需要实现这个方法，因为本地类引用会随着Activity一起总结，不过Activity的清理工作应该放在onPause下或者onStop。</li><li>Note:<br>在所有的情况下系统调用onDestory方法之后已经调用过onPause方法与onStop方法，不过有一个例外情况：你在onCreate方法中调用了finish方法。在一些例子中，当你的Activity临时决定要启动另一个Activity，你可能要在onCreate方法内调用finish方法来销毁这个Activity，在这种情况下，系统会立即调用onDestory方法，而不会调用其它任何生命周期方法。</li></ul><h3 id="暂停activity"><a class="markdownIt-Anchor" href="#暂停activity"></a> 暂停Activity</h3><ul><li>onPause()方法</li><li>Activity被其他Activity覆盖/失去用户焦点，系统调用onPause()方法，Activity 进入暂停状态。<ul><li>note：android7.0及以上版本加入了多窗口模式，当Activity失去用户焦点时，可能处于多窗口模式。</li></ul></li><li>onPause() 常用回调：<ul><li>检查 Activity 是否可见。不可见则停止可能消耗 CPU 的操作</li><li>提交未保存的更改，仅保存用户离开时希望永久性保存此类更改（比如电子邮件草稿）。</li><li>释放系统资源，GPS/Camer等</li><li>示例 (释放Camer)<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPause</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="built_in">super</span>.onPause();  <span class="comment">// Always call the superclass method first</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Release the Camera because we don&#x27;t need it when paused</span></span><br><span class="line"><span class="comment">// and other activities might need to use it.</span></span><br><span class="line"><span class="keyword">if</span> (mCamera != <span class="literal">null</span>) &#123;</span><br><span class="line">   mCamera.release();</span><br><span class="line">   mCamera = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>注意事项：<ul><li>在onPause()一般不执行永久性存储用户更改，不执行 CPU 密集型工作，这些工作一般放在onStop() 。</li></ul></li></ul></li></ul><h3 id="继续-activity"><a class="markdownIt-Anchor" href="#继续-activity"></a> 继续 Activity</h3><ul><li>onResume() 方法</li><li>暂停状态回到继续状态，Activity第一次启动时也会调用这个方法。</li><li>onResume() 以初始化在 onPause() 期间释放的组件。</li><li>示例(重新获取Camera)<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResume</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="built_in">super</span>.onResume();  <span class="comment">// Always call the superclass method first</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get the Camera instance as the activity achieves full user focus</span></span><br><span class="line">  <span class="keyword">if</span> (mCamera == <span class="literal">null</span>) &#123;</span><br><span class="line">      initializeCamera(); <span class="comment">// Local method to handle camera init</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="停止-activity"><a class="markdownIt-Anchor" href="#停止-activity"></a> 停止 Activity</h3><ul><li><p>note：<br>大多数相对简单的 Activity 而言，系统在 Activity 停止时会将Activity 实例保留在系统内存中，无需实现 onStop() 和 onRestart() 或甚至onStart() 方法。可能只需使用 onPause() 暂停正在进行的操作，并从系统资源断开连接。</p></li><li><p>onStop() 方法</p></li><li><p>场景：</p><ul><li>用户在最近应用切换到另一个应用</li><li>应用中执行开始新 Activity 的操作</li><li>Activity使用时，接打电话</li></ul></li><li><p>调用时，Activity不再可见，释放几乎所有用户不使用时不需要的资源。如果系统内存紧张，则可能销毁内存中的Acitivity实例。</p></li><li><p>onStop() 方法调用后，Activity不再可见，极端情况下，系统可能会仅终止应用进程，而不调用 onDestroy() ，因此需要使用 onStop() 释放几乎所有用户不使用时不需要的资源。</p></li><li><p>尽管 onPause() 方法在 onStop()之前调用，在onStop() 执行更大、占用更多 CPU 的关闭操作，比如向数据库写入信息</p></li><li><p>示例（草稿笔记内容保存在永久存储）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onStop</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="built_in">super</span>.onStop();  <span class="comment">// Always call the superclass method first</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Save the note&#x27;s current draft, because the activity is stopping</span></span><br><span class="line">  <span class="comment">// and we want to be sure the current note progress isn&#x27;t lost.</span></span><br><span class="line">  <span class="type">ContentValues</span> <span class="variable">values</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line">  values.put(NotePad.Notes.COLUMN_NAME_NOTE, getCurrentNoteText());</span><br><span class="line">  values.put(NotePad.Notes.COLUMN_NAME_TITLE, getCurrentNoteTitle());</span><br><span class="line"></span><br><span class="line">  getContentResolver().update(</span><br><span class="line">  mUri,    <span class="comment">// The URI for the note to update.</span></span><br><span class="line">  values,  <span class="comment">// The map of column names and new values to apply to them.</span></span><br><span class="line">   <span class="literal">null</span>,    <span class="comment">// No SELECT criteria are used.</span></span><br><span class="line">   <span class="literal">null</span>     <span class="comment">// No WHERE columns are used.</span></span><br><span class="line">   );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="启动重启-activity"><a class="markdownIt-Anchor" href="#启动重启-activity"></a> 启动/重启 Activity</h3><ul><li>onStart() 方法</li><li>Activity 停止转换为继续状态时，系统回调onRestart() 方法+ onStart() 方法.onStop() 方法清理了所有 Activity 的资源，重启 Activity 需要重新实例化它们。同时 Activity 初次创建时重新实例化它们。 出于此，经常使用 onStart() 方法作为 onStop() 方法的对应</li><li>示例<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="built_in">super</span>.onStart();  <span class="comment">// Always call the superclass method first</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// The activity is either being restarted or started for the first time</span></span><br><span class="line">   <span class="comment">// so this is where we should make sure that GPS is enabled</span></span><br><span class="line">   <span class="type">LocationManager</span> <span class="variable">locationManager</span> <span class="operator">=</span></span><br><span class="line">    (LocationManager) getSystemService(Context.LOCATION_SERVICE);</span><br><span class="line">   <span class="type">boolean</span> <span class="variable">gpsEnabled</span> <span class="operator">=</span> locationManager.isProviderEnabled(LocationManager.GPS_PROVIDER);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!gpsEnabled) &#123;</span><br><span class="line">    <span class="comment">// Create a dialog here that requests the user to enable GPS, and use an intent</span></span><br><span class="line">    <span class="comment">// with the android.provider.Settings.ACTION_LOCATION_SOURCE_SETTINGS action</span></span><br><span class="line">    <span class="comment">// to take the user to the Settings screen to enable GPS when they click &quot;OK&quot;</span></span><br><span class="line">   	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onRestart</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="built_in">super</span>.onRestart();  <span class="comment">// Always call the superclass method first</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// Activity being restarted from stopped state</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="保存-activity-状态"><a class="markdownIt-Anchor" href="#保存-activity-状态"></a> 保存 Activity 状态</h3><ul><li><p>onSaveInstanceState()方法</p></li><li><p>默认情况下，Activity 实例被销毁时系统会使用 Bundle 实例状态保存 Activity 布局中有关每个 View 对象的信息。在Activity 重建时，布局状态便自动恢复先前的状态。</p></li><li><p>默认实现保存有关 Activity 视图层次的状态信息，例如 EditText 小部件中的文本或ListView 的滚动位置</p></li><li><p>要恢复的更多信息，需要重写 onSaveInstanceState()方法，将键值对添加至 Bundle 对象</p></li><li><p><img data-src="https://i.loli.net/2019/03/26/5c9a2b13d82f2.png" alt="basic-lifecycle-savestate.png"></p></li><li><p>note:<br>旋转屏幕时，Activity 将被销毁并重新创建。原因：方向更改时可能需要时加载备用资源（比如布局）</p></li><li><p>示例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">STATE_SCORE</span> <span class="operator">=</span> <span class="string">&quot;playerScore&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">STATE_LEVEL</span> <span class="operator">=</span> <span class="string">&quot;playerLevel&quot;</span>;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSaveInstanceState</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">  <span class="comment">// Save the user&#x27;s current game state</span></span><br><span class="line">   savedInstanceState.putInt(STATE_SCORE, mCurrentScore);</span><br><span class="line">   savedInstanceState.putInt(STATE_LEVEL, mCurrentLevel);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Always call the superclass so it can save the view hierarchy state</span></span><br><span class="line">   <span class="built_in">super</span>.onSaveInstanceState(savedInstanceState);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="恢复-activity"><a class="markdownIt-Anchor" href="#恢复-activity"></a> 恢复 Activity</h3><ul><li>onCreate() 和 onRestoreInstanceState() 回调方法均接收包含实例状态信息的相同 Bundle</li><li>onCreate() 方法</li><li>调用onCreate() 方法需要区分是创建 Activity 的新实例还是恢复先前的实例，判断 Bundle 是否为 null</li><li>示例<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">   <span class="built_in">super</span>.onCreate(savedInstanceState); <span class="comment">// Always call the superclass first</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// Check whether we&#x27;re recreating a previously destroyed instance</span></span><br><span class="line">   <span class="keyword">if</span> (savedInstanceState != <span class="literal">null</span>) &#123;</span><br><span class="line">       <span class="comment">// Restore value of members from saved state</span></span><br><span class="line">       mCurrentScore = savedInstanceState.getInt(STATE_SCORE);</span><br><span class="line">       mCurrentLevel = savedInstanceState.getInt(STATE_LEVEL);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="comment">// Probably initialize members with default values for a new instance</span></span><br><span class="line">  	 &#125;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>onRestoreInstanceState()方法</li><li>只需要恢复的已保存的状态</li><li>示例</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onRestoreInstanceState</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">   <span class="comment">// Always call the superclass so it can restore the view hierarchy</span></span><br><span class="line">   <span class="built_in">super</span>.onRestoreInstanceState(savedInstanceState);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Restore state members from saved instance</span></span><br><span class="line">   mCurrentScore = savedInstanceState.getInt(STATE_SCORE);</span><br><span class="line">   mCurrentLevel = savedInstanceState.getInt(STATE_LEVEL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="重启activity其他选择"><a class="markdownIt-Anchor" href="#重启activity其他选择"></a> 重启Activity其他选择</h3><ul><li><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vZ3VpZGUvdG9waWNzL3Jlc291cmNlcy9ydW50aW1lLWNoYW5nZXMuaHRtbA==">官方说明<i class="fa fa-external-link-alt"></i></span></li><li>重启应用并恢复大量数据不仅成本高昂，而且会留下糟糕的使用体验，有两个其他选择</li></ul><h4 id="在配置变更期间保留对象"><a class="markdownIt-Anchor" href="#在配置变更期间保留对象"></a> 在配置变更期间保留对象</h4><ul><li>Activity 因配置变更而重启，则可通过保留 Fragment 来减轻重新初始化 Activity 的负担</li><li>当 Android 系统因配置变更而关闭 Activity 时，不会销毁已标记为要保留的 Activity 的片段。 您可以将此类片段添加到 Activity 以保留有状态的对象。</li></ul><h2 id="activity最佳实践"><a class="markdownIt-Anchor" href="#activity最佳实践"></a> Activity最佳实践</h2><h3 id="知晓当前运行的活动"><a class="markdownIt-Anchor" href="#知晓当前运行的活动"></a> 知晓当前运行的活动</h3><ul><li><p>自定义BaseActivity继承自AppCompatActivity<br>重写onCreate方法，打印当前运行的Activity名<br>app类所有Activity改为继承BaseActivity</p></li><li><p>代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">      <span class="comment">//打印当前类名</span></span><br><span class="line">      Log.d(<span class="string">&quot;BaseActivity&quot;</span>, getClass().getSimpleName())；</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li><li><p>效果如下<br><img data-src="https://i.loli.net/2019/03/26/5c9a2b32811f2.png" alt="ScreenShot_20161208172740.png"></p></li></ul><h3 id="随时退出程序"><a class="markdownIt-Anchor" href="#随时退出程序"></a> 随时退出程序</h3><ul><li>新建ActivityCollector类作为活动管理器，添加/删除Activity登记,在BaseActivity中添加对应代码。</li><li>代码如下<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActivityCollector</span> &#123;</span><br><span class="line"><span class="comment">//新建Activity的列表对象</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Activity&gt; activities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="comment">//添加Activity进入列表</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addActivity</span><span class="params">(Activity activity)</span> &#123;</span><br><span class="line">       activities.add(activity);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//在列表中移除Activity</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">removeActivity</span><span class="params">(Activity activity)</span> &#123;</span><br><span class="line">       activities.remove(activity);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//for循环列表 结束所有Activity</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">finishAll</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">for</span> (Activity activity : activities) &#123;</span><br><span class="line">           <span class="keyword">if</span> (!activity.isFinishing()) &#123;</span><br><span class="line">               activity.finish();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li><li>BaseActivity<br>在onCreate()方法中添加<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Activity管理器中添加新的活动</span></span><br><span class="line">ActivityCollector.addActivity(<span class="built_in">this</span>);</span><br></pre></td></tr></table></figure>重写onDestroy()方法<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">super</span>.onDestroy();</span><br><span class="line">    <span class="comment">//Activity管理器中移除活动</span></span><br><span class="line">    ActivityCollector.removeActivity(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>在任何地方调用finishAll()方法即可。</li></ul><h3 id="启动活动的最近写法"><a class="markdownIt-Anchor" href="#启动活动的最近写法"></a> 启动活动的最近写法</h3><ul><li>启动下一个Activity并传递数据模块化</li><li>在SecondActivity内增加actionStart()方法<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//调用的Activity，数据1，数据2</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">actionStart</span><span class="params">(Context context, String data1, String data2)</span>&#123;</span><br><span class="line">    <span class="comment">//新建Intent，绑定SecondActivity</span></span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(context,ScendActivity.class);</span><br><span class="line">    <span class="comment">//存入data1，data2</span></span><br><span class="line">    intent.putExtra(<span class="string">&quot;param1&quot;</span>,data1);</span><br><span class="line">    intent.putExtra(<span class="string">&quot;param2&quot;</span>,data2);</span><br><span class="line">    <span class="comment">//启动Activity</span></span><br><span class="line">    context.startActivity(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>启动SecondActivity方式<br><code>ScendActivity.actionStart(FirestActivity.this,&quot;data1&quot;,&quot;data2&quot;);</code></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://jasper1024.com/jasper/4a534826/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jfif"><meta itemprop="name" content="Jasper"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="默"><meta itemprop="description" content="微尘"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content=" | 默"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/jasper/4a534826/" class="post-title-link" itemprop="url">Android笔记-自用MVP框架</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2017-05-08 12:00:00" itemprop="dateCreated datePublished" datetime="2017-05-08T12:00:00Z">2017-05-08</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Android笔记</span></a> </span></span><span id="/jasper/4a534826/" class="post-meta-item leancloud_visitors" data-flag-title="Android笔记-自用MVP框架" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Disqus：</span> <a title="disqus" href="/jasper/4a534826/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="jasper/4a534826/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>3.6k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>3 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><hr><p>资料来源如下</p><ul><li>网络</li></ul><p>编程环境</p><ul><li>Android Studio 2.2.3</li></ul><p>导语</p><ul><li>转眼刚用上手的MVP又不符合需求了，还是总结一下，继续MVVM吧。</li></ul><hr><h3 id="起"><a class="markdownIt-Anchor" href="#起"></a> 起</h3><ul><li><p>主要内容是转载，搭建小工程应该足够了。<br><span class="exturl" data-url="aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZGFudGVzdG9uZXMvYXJ0aWNsZS9kZXRhaWxzLzUwODk5MjM1">Android mvp 架构的自述<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZGFudGVzdG9uZXMvYXJ0aWNsZS9kZXRhaWxzLzUxNDQ1MjA4">如何更高效的使用MVP以及官方MVP架构解析<i class="fa fa-external-link-alt"></i></span></p></li><li><p>框架开源在GitHub 地址<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0phc3Blci0xMDI0L012cFRlc3Q=">点我直达<i class="fa fa-external-link-alt"></i></span></p></li><li><p>好，我们开始吧！</p></li></ul><hr><h3 id="mvc-mvp-mvvm"><a class="markdownIt-Anchor" href="#mvc-mvp-mvvm"></a> MVC MVP MVVM</h3><ul><li>省略200行，详情看<span class="exturl" data-url="aHR0cHM6Ly93d3cudGlhbm1heWluZy5jb20vdHV0b3JpYWwvQW5kcm9pZE1WQw==">Android App的设计架构：MVC,MVP,MVVM与架构经验谈<i class="fa fa-external-link-alt"></i></span></li><li>再累赘属于掉书袋了，作者写的是很用心，恩，MVVM也有。</li></ul><h3 id="框架详解"><a class="markdownIt-Anchor" href="#框架详解"></a> 框架详解</h3><ul><li><p>整个框架截图<br><img data-src="https://i.loli.net/2019/03/26/5c9a27f178026.png" alt="ScreenShot_20170509215208.png"></p></li><li><p>整体层次比较明确了，BaseClass 里存放基类，Model层存放数据存储有关类、Presenter层存放逻辑代码、View层存放Activity、frament等。</p></li><li><p>这个框架是由MVP在Android中应用存在的问题而搭建的，基类中代码也由此而来。</p></li></ul><h3 id="问题"><a class="markdownIt-Anchor" href="#问题"></a> 问题</h3><ul><li><p>presenter一直持有Activity对象导致的内存泄漏问题</p><ul><li>使用mvp的时候，presenter会持有view，如果presenter有后台异步的长时间的动作，比如网络请求，这时如果返回退出了Activity，后台异步的动作不会立即停止，这里就会有内存泄漏的隐患。</li><li>需要一个销毁view的方法，这里是在基类中完成的。</li></ul></li><li><p>presenter绑定和解绑繁琐</p><ul><li>一般一个presenter对应一个Activity，一般应用内存在多个Actiivity，绑定与解绑相当繁琐。</li><li>统一在 Basepresenter 与 BaseActivity中进行，同时解决内存泄漏问题，还有其他常用内容一并添加。</li></ul></li><li><p>presenter 与 Model 的通信问题。</p><ul><li>presenter已经与View层 强耦合了，框架中需要解耦presenter 与 Model ，使用异步通信。Handle等都太复杂了。。。</li><li>开始没有什么好的解决办法，直到遇到了EventBus，当然EventBus也不是万能解决方案，跨进程，还是要另辟蹊径，不过EventBus足够自己写着完了。还有Rxjava，恩，还在玩着，没搞太懂。</li></ul></li></ul><h3 id="代码"><a class="markdownIt-Anchor" href="#代码"></a> 代码</h3><ul><li><p>BasePresenter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BasePresenter</span>&lt;Viewinterface&gt; &#123;</span><br><span class="line">   <span class="comment">//传入泛型</span></span><br><span class="line">   <span class="keyword">public</span> Viewinterface mView;</span><br><span class="line">   <span class="comment">//绑定</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">attach</span><span class="params">(Viewinterface mView)</span> &#123;</span><br><span class="line">       <span class="built_in">this</span>.mView = mView;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//解绑，防止view为空是内存泄漏</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dettach</span><span class="params">()</span> &#123;</span><br><span class="line">       mView = <span class="literal">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>BaseActivity</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseActivity</span> &lt;Viewinterface,mPresenter <span class="keyword">extends</span> <span class="title class_">BasePresenter</span>&lt;Viewinterface&gt;&gt;<span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">   <span class="comment">//获取Presenter对象</span></span><br><span class="line">   <span class="keyword">public</span> mPresenter mpresenter;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">       <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">       <span class="comment">//Presenter实例化</span></span><br><span class="line">       mpresenter = initPresenter();</span><br><span class="line">       <span class="comment">//打印当前activity</span></span><br><span class="line">       LogUtil.d(<span class="string">&quot;Activity&quot;</span>, getClass().getSimpleName()+<span class="string">&quot;onCreate&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onResume</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">//重新刷新时重新绑定view</span></span><br><span class="line">       mpresenter.attach((Viewinterface) <span class="built_in">this</span>);</span><br><span class="line">       <span class="built_in">super</span>.onResume();</span><br><span class="line">       LogUtil.d(<span class="string">&quot;Activity&quot;</span>, getClass().getSimpleName()+<span class="string">&quot;onResume&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">//解绑presenter持有的view</span></span><br><span class="line">       mpresenter.dettach();</span><br><span class="line">       <span class="built_in">super</span>.onDestroy();</span><br><span class="line">       LogUtil.d(<span class="string">&quot;Activity&quot;</span>, getClass().getSimpleName()+<span class="string">&quot;onDestroy&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span>  <span class="keyword">abstract</span> mPresenter <span class="title function_">initPresenter</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Presenter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Presenter</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>mPresenter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">mPresenter</span> <span class="keyword">extends</span> <span class="title class_">BasePresenter</span>&lt;Viewif&gt; <span class="keyword">implements</span> <span class="title class_">Presenter</span> &#123;</span><br><span class="line">   <span class="keyword">private</span> Model mModel;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">mPresenter</span><span class="params">(Viewif view)</span> &#123;</span><br><span class="line">       <span class="built_in">this</span>.attach(view);</span><br><span class="line">       <span class="built_in">this</span>.mModel = <span class="keyword">new</span> <span class="title class_">mModel</span>();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>BaseView</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BaseView</span>&lt;T&gt;  &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>Viewif</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Viewif</span> <span class="keyword">extends</span> <span class="title class_">BaseView</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>MainActivity</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">BaseActivity</span>&lt;Viewif, mPresenter&gt; <span class="keyword">implements</span> <span class="title class_">Viewif</span>&#123;</span><br><span class="line"></span><br><span class="line">   Presenter presenter;</span><br><span class="line">   <span class="comment">//Presenter初始化</span></span><br><span class="line">   <span class="keyword">public</span> mPresenter <span class="title function_">initPresenter</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">mPresenter</span>(<span class="built_in">this</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">       <span class="comment">//presenter初始化</span></span><br><span class="line">       presenter = mpresenter;</span><br><span class="line">       <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">       setContentView(R.layout.activity_main);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>LogUtil</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogUtil</span> &#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">VERBOSE</span> <span class="operator">=</span> <span class="number">1</span>;<span class="comment">//啰嗦，等级最低的</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEBUG</span> <span class="operator">=</span> <span class="number">2</span>;<span class="comment">//调试</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">INFO</span> <span class="operator">=</span> <span class="number">3</span>;<span class="comment">//信息</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">WARN</span> <span class="operator">=</span> <span class="number">4</span>;<span class="comment">//警告</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ERROR</span> <span class="operator">=</span> <span class="number">5</span>;<span class="comment">//错误</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NOTHING</span> <span class="operator">=</span> <span class="number">6</span>;<span class="comment">//什么也不打印出来</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">level</span> <span class="operator">=</span> VERBOSE;<span class="comment">//LEVEL:标准</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">v</span><span class="params">(String tag, String msg)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (level &lt;= VERBOSE) &#123;<span class="comment">//如果大于或者等于定义的标准就打印出来</span></span><br><span class="line">           Log.v(tag, msg);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">d</span><span class="params">(String tag, String msg)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (level &lt;= DEBUG) &#123;</span><br><span class="line">           Log.d(tag, msg);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">i</span><span class="params">(String tag, String msg)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (level &lt;= INFO) &#123;</span><br><span class="line">           Log.i(tag, msg);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">w</span><span class="params">(String tag, String msg)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (level &lt;= WARN) &#123;</span><br><span class="line">           Log.w(tag, msg);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">e</span><span class="params">(String tag, String msg)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (level &lt;= ERROR) &#123;</span><br><span class="line">           Log.e(tag, msg);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://jasper1024.com/jasper/b69fad24/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jfif"><meta itemprop="name" content="Jasper"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="默"><meta itemprop="description" content="微尘"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content=" | 默"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/jasper/b69fad24/" class="post-title-link" itemprop="url">Android笔记—蓝牙串口(BlueTooth+EventBus)</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2017-04-17 12:00:00" itemprop="dateCreated datePublished" datetime="2017-04-17T12:00:00Z">2017-04-17</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Android笔记</span></a> </span></span><span id="/jasper/b69fad24/" class="post-meta-item leancloud_visitors" data-flag-title="Android笔记—蓝牙串口(BlueTooth+EventBus)" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Disqus：</span> <a title="disqus" href="/jasper/b69fad24/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="jasper/b69fad24/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>8.7k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>8 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><hr><p>资料来源如下</p><ul><li>第一行代码(第二版)</li></ul><p>编程环境</p><ul><li>Android Studio 2.2.3</li></ul><p>导语</p><ul><li>毕设中的蓝牙部分,记录以供复习</li></ul><hr><h2 id="概述"><a class="markdownIt-Anchor" href="#概述"></a> 概述</h2><h3 id="最终效果"><a class="markdownIt-Anchor" href="#最终效果"></a> 最终效果</h3><ul><li><p>Android应用 与 Hc-05 蓝牙模块连接,单片机与 Android 端 可以通过串口正常收发数据.</p></li><li><p>预留足够灵活的接口, Android 应用中可以在任意位置获取到蓝牙数据</p></li><li><p>Activity切换时,蓝牙连接不断开.</p></li></ul><h3 id="用到的开源库知识点资料-简介来源"><a class="markdownIt-Anchor" href="#用到的开源库知识点资料-简介来源"></a> 用到的开源库/知识点资料 简介/来源</h3><ul><li>蓝牙:<br><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vZ3VpZGUvdG9waWNzL2Nvbm5lY3Rpdml0eS9ibHVldG9vdGguaHRtbA==">Android API 指南<i class="fa fa-external-link-alt"></i></span></li></ul><blockquote><p><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vZ3VpZGUvdG9waWNzL2Nvbm5lY3Rpdml0eS9ibHVldG9vdGguaHRtbA==">https://developer.android.com/guide/topics/connectivity/bluetooth.html<i class="fa fa-external-link-alt"></i></span></p></blockquote><ul><li><p>EventBus:<br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dyZWVucm9ib3QvRXZlbnRCdXM=">EventBus-GitHub<i class="fa fa-external-link-alt"></i></span> 是一个Android端优化的publish/subscribe消息总线,用来替代 Intent 、 Handler 、 Broadcast 等在 Actvity 、 Fragment 、 Service 等组件之间传递信息 . EventBus 可以传递一个完整的对象,简单高效, <strong>注意 EventBus 只能在多线程之间传递消息,无法在不同进程之间传递消息</strong> ,EventBus 3.0 以后进一步简化了传递方式,真的是很值得学习的一个开源库!</p><p>参考资料如下:</p><p><span class="exturl" data-url="aHR0cDovL3d3dy5qaWFuc2h1LmNvbS9wL2FjZmU3ODI5NmJiNQ==">EventBus 3.0初探: 入门使用及其使用 完全解析<i class="fa fa-external-link-alt"></i></span></p><p><span class="exturl" data-url="aHR0cDovL3d3dy5qaWFuc2h1LmNvbS9wLzFlYWNhMzRlNTMxNA==">EventBus3(3.0.0)源码解析<i class="fa fa-external-link-alt"></i></span></p></li></ul><hr><h2 id="基础部分"><a class="markdownIt-Anchor" href="#基础部分"></a> 基础部分</h2><ul><li>蓝牙 与 EventBus 基础部分</li></ul><h3 id="bluetooth"><a class="markdownIt-Anchor" href="#bluetooth"></a> BlueTooth</h3><hr><ul><li>备注 : 这里使用的是 传统蓝牙 即 蓝牙4.0以前版本, 而不是 蓝牙4.0 ( ble低功耗蓝牙)及以后版本</li></ul><hr><ul><li>Android 对 Bluetooth 做了很好的封装,我们可以比较轻松的在 Android Bluetooth API 上进行开发.</li><li>Android中所有蓝牙API均来自 android.bluetooth 包</li></ul><h4 id="bluetooth基础"><a class="markdownIt-Anchor" href="#bluetooth基础"></a> BlueTooth基础</h4><ul><li><p>BluetoothAdapter 本地蓝牙适配器<br>BluetoothAdapter 是所有蓝牙交互的入口点, 在初始化蓝牙及蓝牙配对阶段使用<br>1.发现其他蓝牙设备<br>2.查询绑定（配对）设备的列表<br>3.使用已知的 MAC 地址实例化 BluetoothDevice<br>4.创建 BluetoothServerSocket 侦听来自其他设备的通信。</p></li><li><p>BluetoothDevice 远程蓝牙设备<br>含有该设备的信息，例如设备的名称、地址、类和绑定状态等。</p></li><li><p>BluetoothSocket 蓝牙套接字接口（与 TCP Socket 相似）<br>与 BluetoothDevice 配合建立远程连接,允许应用通过 InputStream 和 OutputStream 与其他蓝牙设备交换数据.</p></li></ul><h4 id="初始化蓝牙"><a class="markdownIt-Anchor" href="#初始化蓝牙"></a> 初始化蓝牙</h4><ul><li><p>声明蓝牙权限<br>Android 应用使用蓝牙前都需要声明蓝牙权限<br>一般只需要 BLUETOOTH 权限即可,但是考虑到之后有更多的需求,需要更改系统蓝牙设置,由此需要 BLUETOOTH_ADMIN 权限_也一起声明</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;manifest ... &gt;</span><br><span class="line">&lt;uses-permission android:name=<span class="string">&quot;android.permission.BLUETOOTH&quot;</span> /&gt;</span><br><span class="line">&lt;uses-permission android:name=<span class="string">&quot;android.permission.BLUETOOTH_ADMIN&quot;</span> /&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/manifest&gt;</span><br></pre></td></tr></table></figure></li><li><p>蓝牙设备可用性 获取 BluetoothAdapter<br>获取 BluetoothAdapter，需要静态 getDefaultAdapter() 方法。getDefaultAdapter() 会返回一个表示设备自身的蓝牙适配器的 BluetoothAdapter 设备不支持蓝牙 则返回 null</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BluetoothAdapter</span> <span class="variable">mBluetoothAdapter</span> <span class="operator">=</span> BluetoothAdapter.getDefaultAdapter();</span><br><span class="line"><span class="keyword">if</span> (mBluetoothAdapter == <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="comment">// 蓝牙不可用操作</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>开启蓝牙<br>BluetoothAdapter 的 .isEnabled() 可以判断系统蓝牙是否开启.<br>没有开启时 startActivityForResult() 发送包含 ACTION_REQUEST_ENABLE 的 Intent 请求系统开启蓝牙,并在 onActivityResult() 返回的数据中 RESULT_CANCELED 表示开启失败 RESULT_OK 表示开启成功,这里我们只检测开启失败情况,并提示用户</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!mBluetoothAdapter.isEnabled()) &#123;</span><br><span class="line">  <span class="type">Intent</span> <span class="variable">enableBtIntent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(BluetoothAdapter.ACTION_REQUEST_ENABLE);</span><br><span class="line">  startActivityForResult(enableBtIntent, REQUEST_ENABLE_BT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onActivityResult</span><span class="params">(<span class="type">int</span> requestCode, <span class="type">int</span> resultCode, Intent data)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (requestCode == REQUEST_ENABLE_BT &amp;&amp; resultCode == RESULT_CANCELED) &#123;</span><br><span class="line">          Toast.makeText(MyApplication.getContext(),R.string.Bluetooth_openfail, Toast.LENGTH_SHORT).show();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="type">BluetoothAdapter</span> <span class="variable">mBluetoothAdapter</span> <span class="operator">=</span> BluetoothAdapter.getDefaultAdapter();</span><br><span class="line">      <span class="keyword">if</span> (mBluetoothAdapter == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">//设备不支持蓝牙时处理</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li><li><p>查询已配对的设备<br>调用 getBondedDevices(),返回已配对设备的一组 BluetoothDevice.之后使用for循环遍历</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;BluetoothDevice&gt; pairedDevices = mBluetoothAdapter.getBondedDevices();</span><br><span class="line"><span class="keyword">if</span> (pairedDevices.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//重新加载bluetoothDeviceList</span></span><br><span class="line">        bluetoothDeviceList.clear();</span><br><span class="line">        <span class="comment">//BluetoothDevice列表循环</span></span><br><span class="line">        <span class="keyword">for</span> (BluetoothDevice device : pairedDevices) &#123;</span><br><span class="line">          bluetoothDeviceList.add(device);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li><li><p>扫描设备<br>查找设备是非常耗费系统资源的事项，需要安排在子线程中执行，这里没有用到，由需要请参考Google官方蓝牙教程</p></li><li><p>连接设备<br>蓝牙分主从机，链接为服务器/客户端。这里使用的是连接为客户端。</p><ul><li>首先获取远程设备的 BluetoothDevice 对象，即在选择设备阶段的BluetoothDevice</li><li>调用 createRfcommSocketToServiceRecord(UUID) 获取 BluetoothSocket，UUID通用唯一识别码 在蓝牙中具体是什么没有很好的解释。这里的值取的是<br><code>&quot;00001101-0000-1000-8000-00805F9B34FB&quot;</code></li><li>调用 connect() 发起连接,阻塞调用，需要在子线程中执行。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//蓝牙连接子线程</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ConnectThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BluetoothSocket mmSocket;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析函数</span></span><br><span class="line">    ConnectThread(BluetoothDevice bluetoothDevice) &#123;</span><br><span class="line">        <span class="comment">// 使用一个中间变量 tmp</span></span><br><span class="line">        <span class="comment">// mmSocket 类型是 final</span></span><br><span class="line"></span><br><span class="line">        <span class="type">BluetoothSocket</span> <span class="variable">tmp</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// 获取 BluetoothSocket</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// MY_UUID is the app&#x27;s UUID string, also used by the server code</span></span><br><span class="line">            tmp = bluetoothDevice.createRfcommSocketToServiceRecord(UUID.fromString(MyApplication.MY_UUID));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ignored) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//赋值给 mmSocket</span></span><br><span class="line">        mmSocket = tmp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 关闭蓝牙扫描</span></span><br><span class="line">        MyApplication.getBluetoothAdapter().cancelDiscovery();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 通过 socket 连接到设备. connect() 会一直执行直到成功连接或者抛出异常</span></span><br><span class="line">            mmSocket.connect();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException connectException) &#123;</span><br><span class="line">            <span class="comment">//无法连接到蓝牙,关闭连接并退出</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mmSocket.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//没有正常关闭</span></span><br><span class="line">            <span class="keyword">catch</span> (IOException ignored) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Do work to manage the connection (in a separate thread)</span></span><br><span class="line">        mConnectedThread = <span class="keyword">new</span> <span class="title class_">ConnectedThread</span>(mmSocket);</span><br><span class="line">        mConnectedThread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭蓝牙连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mmSocket.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ignored) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>管理连接<br>获取BluetoothSocket<br>获取 InputStream 和 OutputStream， getInputStream() 和 getOutputStream() 来处理数据传输。read(byte[]) 和 write(byte[]) 读取数据并写入到流式传输。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ConnectedThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">      <span class="comment">//BluetoothSocket</span></span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> BluetoothSocket mmSocket;</span><br><span class="line">      <span class="comment">//输入流</span></span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> InputStream mmInStream;</span><br><span class="line">      <span class="comment">//输出流</span></span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> OutputStream mmOutStream;</span><br><span class="line"></span><br><span class="line">      ConnectedThread(BluetoothSocket socket) &#123;</span><br><span class="line">          <span class="comment">//传入BluetoothSocket，实例化mmSocket</span></span><br><span class="line">          mmSocket = socket;</span><br><span class="line">          <span class="comment">//输入/输出流 中间变量</span></span><br><span class="line">          <span class="type">InputStream</span> <span class="variable">tmpIn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">          <span class="type">OutputStream</span> <span class="variable">tmpOut</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 输入输出流实例化</span></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              tmpIn = socket.getInputStream();</span><br><span class="line">              tmpOut = socket.getOutputStream();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">              e.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">          mmInStream = tmpIn;</span><br><span class="line">          mmOutStream = tmpOut;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">          <span class="type">int</span> bytes;</span><br><span class="line">          <span class="comment">// 连接成功时</span></span><br><span class="line">          <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  <span class="comment">// 在InputStream读数据</span></span><br><span class="line">                  bytes = mmInStream.read();</span><br><span class="line">                  <span class="comment">//发送数据</span></span><br><span class="line">                  Events.<span class="type">bluetooth_Recycle</span> <span class="variable">bluetooth_recycle</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Events</span>.bluetooth_Recycle();</span><br><span class="line">                  bluetooth_recycle.s = bytes;</span><br><span class="line">                  bluetooth_recycle.bytes = String.valueOf((<span class="type">char</span>) bytes);</span><br><span class="line">                  EventBus.getDefault().post(bluetooth_recycle);</span><br><span class="line">              &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//写方法</span></span><br><span class="line">      <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              mmOutStream.write(bytes);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">              e.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//关闭流连接</span></span><br><span class="line">      <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              mmSocket.close();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="eventbus"><a class="markdownIt-Anchor" href="#eventbus"></a> EventBus</h3><ul><li>直接放链接了<blockquote><p><span class="exturl" data-url="aHR0cDovL3d3dy5qaWFuc2h1LmNvbS9wL2EwNDA5NTUxOTRmYw==">http://www.jianshu.com/p/a040955194fc<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cDovL3d3dy5qaWFuc2h1LmNvbS9wL2FjZmU3ODI5NmJiNQ==">http://www.jianshu.com/p/acfe78296bb5<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cDovL3d3dy5mZjUwLm5ldC92aWV3LzQwNTY1MjEyOTc3NjIzNTA2MDYzLmh0bWw=">http://www.ff50.net/view/40565212977623506063.html<i class="fa fa-external-link-alt"></i></span></p></blockquote></li></ul><h2 id="正文"><a class="markdownIt-Anchor" href="#正文"></a> 正文</h2><ul><li><p>蓝牙连接子线程</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ConnectThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> BluetoothSocket mmSocket;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//解析函数</span></span><br><span class="line">      ConnectThread(BluetoothDevice bluetoothDevice) &#123;</span><br><span class="line">          <span class="comment">// 使用一个中间变量 tmp</span></span><br><span class="line">          <span class="comment">// mmSocket 类型是 final</span></span><br><span class="line"></span><br><span class="line">          <span class="type">BluetoothSocket</span> <span class="variable">tmp</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">          <span class="comment">// 获取 BluetoothSocket</span></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// MY_UUID is the app&#x27;s UUID string, also used by the server code</span></span><br><span class="line">              tmp = bluetoothDevice.createRfcommSocketToServiceRecord(UUID.fromString(MyApplication.MY_UUID));</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException ignored) &#123;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">//赋值给 mmSocket</span></span><br><span class="line">          mmSocket = tmp;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="comment">// 关闭蓝牙扫描</span></span><br><span class="line">          MyApplication.getBluetoothAdapter().cancelDiscovery();</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// 通过 socket 连接到设备. connect() 会一直执行直到成功连接或者抛出异常</span></span><br><span class="line">              mmSocket.connect();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException connectException) &#123;</span><br><span class="line">              <span class="comment">//无法连接到蓝牙,关闭连接并退出</span></span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  mmSocket.close();</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">//没有正常关闭</span></span><br><span class="line">              <span class="keyword">catch</span> (IOException ignored) &#123;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Do work to manage the connection (in a separate thread)</span></span><br><span class="line">          mConnectedThread = <span class="keyword">new</span> <span class="title class_">ConnectedThread</span>(mmSocket);</span><br><span class="line">          mConnectedThread.start();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * 关闭蓝牙连接</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              mmSocket.close();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException ignored) &#123;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>管理连接子线程</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">//管理连接子线程</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ConnectedThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="comment">//BluetoothSocket</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BluetoothSocket mmSocket;</span><br><span class="line">    <span class="comment">//输入流</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InputStream mmInStream;</span><br><span class="line">    <span class="comment">//输出流</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OutputStream mmOutStream;</span><br><span class="line"></span><br><span class="line">    ConnectedThread(BluetoothSocket socket) &#123;</span><br><span class="line">        <span class="comment">//传入BluetoothSocket，实例化mmSocket</span></span><br><span class="line">        mmSocket = socket;</span><br><span class="line">        <span class="comment">//输入/输出流 中间变量</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">tmpIn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">tmpOut</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 输入输出流实例化</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            tmpIn = socket.getInputStream();</span><br><span class="line">            tmpOut = socket.getOutputStream();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        mmInStream = tmpIn;</span><br><span class="line">        mmOutStream = tmpOut;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">int</span> bytes;</span><br><span class="line">        <span class="comment">// 连接成功时</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 在InputStream读数据</span></span><br><span class="line">                bytes = mmInStream.read();</span><br><span class="line">                <span class="comment">//发送数据</span></span><br><span class="line">                Events.<span class="type">bluetooth_Recycle</span> <span class="variable">bluetooth_recycle</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Events</span>.bluetooth_Recycle();</span><br><span class="line">                bluetooth_recycle.s = bytes;</span><br><span class="line">                bluetooth_recycle.bytes = String.valueOf((<span class="type">char</span>) bytes);</span><br><span class="line">                EventBus.getDefault().post(bluetooth_recycle);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//写方法</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mmOutStream.write(bytes);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭流连接</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mmSocket.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>连接蓝牙</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//连接线程</span></span><br><span class="line"><span class="keyword">private</span> ConnectThread mConnectThread;</span><br><span class="line"><span class="comment">//管理连接进程</span></span><br><span class="line"><span class="keyword">private</span> ConnectedThread mConnectedThread;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建连接子线程</span></span><br><span class="line">mConnectThread = <span class="keyword">new</span> <span class="title class_">ConnectThread</span>(bluetoothDevice);</span><br><span class="line"><span class="comment">//启动连接子线程</span></span><br><span class="line">mConnectThread.start();</span><br></pre></td></tr></table></figure></li><li><p>向蓝牙写入数据</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//发送数据String,        主线程            优先级4       非粘性事件</span></span><br><span class="line"><span class="meta">@Subscribe(threadMode = ThreadMode.MAIN, priority = 4, sticky = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(Events.bluetooth_Send bluetoothSend)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">bytes</span> <span class="operator">=</span> bluetoothSend.bytes;</span><br><span class="line">    mConnectedThread.write(bytes.getBytes());</span><br><span class="line">    LogUtil.d(Tag, <span class="string">&quot;onEvent:Send&quot;</span> + bluetoothSend.bytes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>接收数据处理</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">//数据转换                后台进程            优先级3       非粘性事件</span></span><br><span class="line"><span class="meta">@Subscribe(threadMode = ThreadMode.BACKGROUND, priority = 3, sticky = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(Events.bluetooth_Transformers bluetoothTransformers)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">bytes</span> <span class="operator">=</span> bluetoothTransformers.bytes;</span><br><span class="line">    <span class="comment">//处理数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://jasper1024.com/jasper/b543c37e/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jfif"><meta itemprop="name" content="Jasper"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="默"><meta itemprop="description" content="微尘"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content=" | 默"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/jasper/b543c37e/" class="post-title-link" itemprop="url">Android笔记—仿绿色守护嗜睡模式通知</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2017-03-07 12:00:00" itemprop="dateCreated datePublished" datetime="2017-03-07T12:00:00Z">2017-03-07</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Android笔记</span></a> </span></span><span id="/jasper/b543c37e/" class="post-meta-item leancloud_visitors" data-flag-title="Android笔记—仿绿色守护嗜睡模式通知" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Disqus：</span> <a title="disqus" href="/jasper/b543c37e/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="jasper/b543c37e/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>3.6k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>3 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><hr><p>资料来源如下</p><ul><li>第一行代码(第二版)</li><li><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vdHJhaW5pbmcvbm90aWZ5LXVzZXIvaW5kZXguaHRtbA==">Android Training Notifying the User<i class="fa fa-external-link-alt"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vZ3VpZGUvdG9waWNzL3VpL25vdGlmaWVycy9ub3RpZmljYXRpb25zLmh0bWwjQ3JlYXRlTm90aWZpY2F0aW9u">Android API 通知<i class="fa fa-external-link-alt"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cub3NjaGluYS5uZXQvcXVlc3Rpb24vMjM0MzQ1XzQwMTEx">【Android】状态栏通知Notification、NotificationManager详解<i class="fa fa-external-link-alt"></i></span></li></ul><p>编程环境</p><ul><li>Android Studio 2.2.3</li></ul><p>导语</p><ul><li>OneTapDoze遇到的第一个难题，顺带记录Android 通知相关内容</li></ul><hr><h2 id="最终效果"><a class="markdownIt-Anchor" href="#最终效果"></a> 最终效果</h2><ul><li><p>绿色守护进入doze模式后，会在通知栏创建一个计时通知 如下图<br><img data-src="https://i.loli.net/2019/03/26/5c9a2eb17614a.png" alt="Screenshot_20170307-231118.png"></p></li><li><p>退出doze模式后，会指示进入doze和退出doze的时间段。<br><img data-src="https://i.loli.net/2019/03/26/5c9a2ec9b2dd7.png" alt="Screenshot_20170307-231132.png"></p></li><li><p>我们要仿照的样式就是这样，进入退出doze，对应创建通知的代码都在doze模式改变的Broadcast中。</p></li></ul><h2 id="基础部分"><a class="markdownIt-Anchor" href="#基础部分"></a> 基础部分</h2><h3 id="创建通知"><a class="markdownIt-Anchor" href="#创建通知"></a> 创建通知</h3><ul><li>行文前：<br>Android每次版本几乎都会有通知API的改动，不同版本之间通知兼容性很是问题，为此我们使用support_v7 库中的NotificationCompat.Builder代替Notification.Builder二者使用方式相同</li></ul><hr><ul><li><p>涉及到的两个类</p><ul><li>NotificationManager</li><li>Notification (support库中对应NotificationCompat)</li></ul></li><li><p>NotificationManager</p><ul><li>状态栏通知的管理类，负责发通知、清除通知等</li><li>NotificationManager 是一个系统Service，必须通过 getSystemService()方法来获取</li></ul></li><li><p>Notification</p><ul><li>具体的状态栏通知对象，可以设置icon、文字、提示声音、振动等参数</li><li>一个Builder对象至少包含三个方面<ul><li>一个小图标，通过setSmallIcon()方法设置。</li><li>通知标题，通过setContentTitle()方法设置。</li><li>详细文本，通过setContentText()方法设置。</li></ul></li></ul></li><li><p>简单示例</p><ul><li><p>创建通知构建器<br>代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Notification</span> <span class="variable">notification</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotificationCompat</span>.Builder(<span class="built_in">this</span>)</span><br><span class="line">           .setContentTitle(<span class="string">&quot;这是通知标题&quot;</span>)</span><br><span class="line">           .setContentText(<span class="string">&quot;这是通知内容&quot;</span>)</span><br><span class="line">           <span class="comment">//这里使用的是应用图标，一般没人这么干，就是为了方便</span></span><br><span class="line">           .setSmallIcon(R.mipmap.ic_launcher)</span><br><span class="line">           .build();</span><br></pre></td></tr></table></figure></li><li><p>发布通知</p><ul><li>获得NotificationManager的实例</li><li>使用notify()方法发布通知。在调用notify()方法 指定通知的ID，(ID用于通知更新) 加载Notification实例</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">mNotificationId</span> <span class="operator">=</span> <span class="number">001</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">NotificationManager</span> <span class="variable">manager</span> <span class="operator">=</span> (NotificationManager) getSystemService(NOTIFICATION_SERVICE);</span><br><span class="line">manager.notify(mNotificationId, notification);</span><br></pre></td></tr></table></figure></li></ul></li><li><p>效果如下</p><ul><li>android 7.0 / 6.0 /4.0 通过</li><li><img data-src="https://i.loli.net/2019/03/26/5c9a2ee2a0d1e.png" alt="ScreenShot_20170202173430.png"></li></ul></li></ul><h3 id="更新通知"><a class="markdownIt-Anchor" href="#更新通知"></a> 更新通知</h3><ul><li><p>可以创建一个全新的NotificationCompat对象，也可以在原NotificationCompat对象基础上修改，最后只要 .notify 方法中对应同一个 mNotificationId ，系统就会自动更新已有通知，代码不在累赘。</p></li><li><p>基础部分到此，足矣</p></li></ul><h2 id="正题"><a class="markdownIt-Anchor" href="#正题"></a> 正题</h2><ul><li>实现时间段的显示，肯定会保存系统进入doze 退出doze对应的时间点。再计算出中间经历的时间。</li></ul><h3 id="提取系统时间"><a class="markdownIt-Anchor" href="#提取系统时间"></a> 提取系统时间</h3><ul><li><p>java.util.Date<br>这里用到了java中的 时间类型 java.util.Date<br>java.util.Date 是java中常用时间类型，可以被SimpleDateFormat格式化format() 指定输出的时间格式<br>比如我们需要 小时：分：秒<br><code>SimpleDateFormat scanf = new SimpleDateFormat(&quot;HH:mm:ss&quot;);</code><br><code>scanf.format(java.util.Date)</code> 即可。</p></li><li><p>提前当前系统时间</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java.util.<span class="type">Date</span> <span class="variable">time_after</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">time_after = <span class="keyword">new</span> <span class="title class_">java</span>.util.Date(System.currentTimeMillis());</span><br></pre></td></tr></table></figure></li><li><p>计算时间差<br>理论上是两个时间相减再格式化输出即可，可惜没成，原因还没找到。于是土办法：</p><ul><li>调用 .getTime() 方法，将 java.util.Date 转化为毫秒计时(long)</li><li>取两者差值</li><li>转化为 时间长短 字符串返回，</li></ul></li><li><p>代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> size = (time_after.getTime() - time_befor.getTime());</span><br><span class="line"> string = scanf.format(time_befor) + <span class="string">&quot;-&quot;</span> + scanf.format(time_after) + <span class="string">&quot;=&quot;</span>+ trform(size);</span><br><span class="line"></span><br><span class="line"> String <span class="title function_">trform</span><span class="params">(<span class="type">long</span> size)</span> &#123;</span><br><span class="line"> <span class="type">long</span> day, hour, min, secone;</span><br><span class="line"></span><br><span class="line"> day = size / (<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>);          <span class="comment">//以天数为单位取整</span></span><br><span class="line"> hour = (size / (<span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>) - day * <span class="number">24</span>);             <span class="comment">//以小时为单位取整</span></span><br><span class="line"> min = ((size / (<span class="number">60</span> * <span class="number">1000</span>)) - day * <span class="number">24</span> * <span class="number">60</span> - hour * <span class="number">60</span>);    <span class="comment">//以分钟为单位取整</span></span><br><span class="line"> secone = (size / <span class="number">1000</span> - day * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> - hour * <span class="number">60</span> * <span class="number">60</span> - min * <span class="number">60</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (day != <span class="number">0</span>) &#123;</span><br><span class="line">   <span class="keyword">return</span> day + <span class="string">&quot;d&quot;</span> + hour + <span class="string">&quot;h&quot;</span> + min + <span class="string">&quot;m&quot;</span> + secone + <span class="string">&quot;s&quot;</span>;</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hour != <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> hour + <span class="string">&quot;h&quot;</span> + min + <span class="string">&quot;m&quot;</span> + secone + <span class="string">&quot;s&quot;</span>;</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (min != <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> min + <span class="string">&quot;m&quot;</span> + secone + <span class="string">&quot;s&quot;</span>;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> secone + <span class="string">&quot;s&quot;</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="通知扩展布局"><a class="markdownIt-Anchor" href="#通知扩展布局"></a> 通知扩展布局</h3><ul><li><p>在如下图片中，可以发现，通知在发出后，只默认显示最近一次的时间记录，其他时间记录可以在此条通知上下滑查看。明显与基础部分不同。<br><img data-src="https://i.loli.net/2019/03/26/5c9a2ec9b2dd7.png" alt="Screenshot_20170307-231132.png"></p></li><li><p>此处应用了 Builder.setStyle() 拓展布局，顾名思义，这是用于拓展通知显示范围</p></li></ul><hr><h4 id="使用扩展布局"><a class="markdownIt-Anchor" href="#使用扩展布局"></a> 使用扩展布局</h4><ul><li>使用拓展布局<ul><li>构建一个 inboxStyle 对象</li><li>.addLine方法 添加 String inboxStyle 行</li><li>使用 Builder.setStyle( inboxStyle )加载到通知</li><li>等待通知发布即可。</li></ul></li><li>简单例程如下<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建 inboxStyle</span></span><br><span class="line"> NotificationCompat.<span class="type">InboxStyle</span> <span class="variable">inboxStyle</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotificationCompat</span>.InboxStyle();</span><br><span class="line"> <span class="comment">//添加 String 行 ，前提是 我已经创建了一个 String</span></span><br><span class="line"> inboxStyle.addLine(string);</span><br><span class="line"> <span class="comment">// 在notification 设置    inboxStyle 在一堆 build 里面</span></span><br><span class="line"> .setStyle(inboxStyle)</span><br></pre></td></tr></table></figure></li><li>清除原有内容，发布新的 inboxStyle 只需要 <code>inboxStyle = new NotificationCompat.InboxStyle();</code></li></ul><h3 id="doze模式改变广播"><a class="markdownIt-Anchor" href="#doze模式改变广播"></a> Doze模式改变广播</h3><ul><li>对应 <code>ACTION_DEVICE_IDLE_MODE_CHANGED</code></li></ul><hr><ul><li>坑：只能动态注册，静态注册无效，具体代码中<code>powermanger.ACTION_DEVICE_IDLE_MODE_CHANGED</code> 需要实例化 PowerManger ，而 PowerManger 又是与 Activity绑定，所以只有应用保持后台存活时才会进入广播。</li><li>例程如下<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实例化 PowerManager</span></span><br><span class="line"><span class="type">PowerManager</span> <span class="variable">powermanger</span> <span class="operator">=</span> (PowerManager) getApplicationContext().getSystemService(Context.POWER_SERVICE);</span><br><span class="line"><span class="comment">//动态注册广播</span></span><br><span class="line">intentFilter = <span class="keyword">new</span> <span class="title class_">IntentFilter</span>();</span><br><span class="line">intentFilter.addAction(powermanger.ACTION_DEVICE_IDLE_MODE_CHANGED);</span><br><span class="line"><span class="comment">//idlemodechage 是 BroadcastReceiver</span></span><br><span class="line">idlemodechage = <span class="keyword">new</span> <span class="title class_">IdleModeChange</span>();</span><br><span class="line">registerReceiver(idlemodechage, intentFilter);</span><br></pre></td></tr></table></figure></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><nav class="pagination"><a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/31/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/31/">31</a><span class="page-number current">32</span><a class="page-number" href="/page/33/">33</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/33/"><i class="fa fa-angle-right"></i></a></nav></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2016 – <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">JasperHale</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span>站点总字数：</span> <span title="站点总字数">1.4m</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span>站点阅读时长 &asymp;</span> <span title="站点阅读时长">20:54</span></span></div><div class="powered-by">由 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZy9waXNjZXMv">NexT.Pisces</span> 强力驱动</div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="reading-progress-bar"></div><span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL0phc3Blci0xMDI0" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"jasper1024","count":true,"i18n":{"disqus":"disqus"}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/third-party/comments/disqus.min.js" defer></script><script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"Jasper-1024/blog_discuss","issue_term":"pathname","theme":"github-dark"}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.25.0/source/js/third-party/comments/utterances.min.js" defer></script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script></body></html>