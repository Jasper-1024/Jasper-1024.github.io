<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="google-site-verification" content="M2t8cZr5nIzHmltyt7Utj3nWYxNyNkCzFyigXBHkGUs"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.31/dist/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"jasper1024.com","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.27.0","exturl":true,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"vs2015","dark":"vs2015"},"prism":{"light":"prism-vsc-dark-plus","dark":"prism-vsc-dark-plus"},"copy_button":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":true,"nav":{"disqus":{"text":"disqus","order":-1},"utterances":{"text":"utterances","order":-2}},"activeClass":"disqus"},"stickytabs":true,"motion":{"enable":true,"async":true,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.27.0/source/js/config.min.js" defer></script><meta name="description" content="微尘"><meta property="og:type" content="website"><meta property="og:title" content="默"><meta property="og:url" content="https://jasper1024.com/page/32/index.html"><meta property="og:site_name" content="默"><meta property="og:description" content="微尘"><meta property="og:locale" content="zh_CN"><meta property="article:author" content="Jasper"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://jasper1024.com/page/32/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/32/index.html","title":""}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>默 - 生存是唯一的长路</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-207687331-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-207687331-1","only_pageview":false,"measure_protocol_api_secret":null}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.27.0/source/js/third-party/analytics/google-analytics.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script><script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous" defer></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.31/dist/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous" defer></script><script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.27.0/source/js/comments.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.27.0/source/js/utils.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.27.0/source/js/motion.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.27.0/source/js/sidebar.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.27.0/source/js/next-boot.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.27.0/source/js/pjax.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.5.0/dist/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.27.0/source/js/third-party/search/local-search.min.js" defer></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdn.jsdelivr.net/npm/pdfobject@2.3.1/pdfobject.min.js","integrity":"sha256-jI72I8ZLVflVOisZIOaLvRew3tyvzeu6aZXFm7P7dEo="},"url":"/lib/pdf/web/viewer.html"}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.27.0/source/js/third-party/tags/pdf.min.js" defer></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@11.10.1/dist/mermaid.min.js","integrity":"sha256-BmQmdWDS8X2OTbrwELWK366LV6escyWhHHe0XCTU/Hk="}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.27.0/source/js/third-party/tags/mermaid.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.27.0/source/js/third-party/fancybox.min.js" defer></script><script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"ItayEcWO7OsLFKF2Y8SsAYG1-MdYXbMMI","app_key":"18UBQFmJXXcOQFebLovT36lh","server_url":null,"security":false}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.27.0/source/js/third-party/statistics/lean-analytics.min.js" defer></script><script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha256-UF1fgpAiu3tPJN/uCqEUHNe7pnr+QR0SQDNfgglgtcM=" crossorigin="anonymous"><script src="https://cdn.jsdelivr.net/npm/quicklink@3.0.1/dist/quicklink.umd.js" integrity="sha256-44BednzIpUeQJcY8qtLyarFu0UCCTbgmWOvaoehiFQQ=" crossorigin="anonymous" defer></script><script class="next-config" data-name="quicklink" type="application/json">{"enable":false,"home":false,"archive":false,"delay":true,"timeout":3000,"priority":true,"url":"https://jasper1024.com/page/32/"}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.27.0/source/js/third-party/quicklink.min.js" defer></script><link rel="stylesheet" href="/css/callout_blocks.css"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="默" type="application/rss+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">默</h1><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">生存是唯一的长路</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">46</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">326</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">62</span></a></li><li class="menu-item menu-item-guestbook"><a href="/guestbook/" rel="section"><i class="fa fa-comments fa-fw"></i>留言</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-overview-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Jasper" src="/images/avatar.jfif"><p class="site-author-name" itemprop="name">Jasper</p><div class="site-description" itemprop="description">微尘</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">326</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">46</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">62</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2phc3Blci0xMDI0" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jasper-1024"><i class="fab fa-github fa-fw"></i>GitHub</span> </span><span class="links-of-author-item"><a href="/ljy087621@gmail.com" title="E-Mail → ljy087621@gmail.com" rel="noopener me"><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly94LmNvbS9KYXNwZXJfMTAyNA==" title="Twitter → https:&#x2F;&#x2F;x.com&#x2F;Jasper_1024"><i class="fab fa-twitter fa-fw"></i>Twitter</span> </span><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly90Lm1lL2phc3BlcjEwMjQ=" title="Telegram → https:&#x2F;&#x2F;t.me&#x2F;jasper1024"><i class="fab fa-skype fa-fw"></i>Telegram</span> </span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → &#x2F;atom.xml" rel="noopener me"><i class="fas fa-rss fa-fw"></i>RSS</a></span></div></div></div><div class="back-to-top animated" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div><div class="sidebar-inner sidebar-blogroll"><div class="links-of-blogroll animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> 链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmZvcmVjaG8uY29tLw==" title="https:&#x2F;&#x2F;blog.forecho.com&#x2F;">forecho</span></li><li class="links-of-blogroll-item"><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmZvcmVjaG8uY29tL2ZyaWVuZHNoaXAtbGlua3Mv" title="https:&#x2F;&#x2F;blog.forecho.com&#x2F;friendship-links&#x2F;">友链聚合</span></li></ul></div></div></aside></div><div class="main-inner index posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://jasper1024.com/jasper/1b31712e/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jfif"><meta itemprop="name" content="Jasper"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="默"><meta itemprop="description" content="微尘"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content=" | 默"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/jasper/1b31712e/" class="post-title-link" itemprop="url">Linux内核C语言中的面向对象</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2017-07-11 10:17:11 / 修改时间：12:00:00" itemprop="dateCreated datePublished" datetime="2017-07-11T10:17:11Z">2017-07-11</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/linux%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">linux学习</span></a> </span></span><span id="/jasper/1b31712e/" class="post-meta-item leancloud_visitors" data-flag-title="Linux内核C语言中的面向对象" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Disqus：</span> <a title="disqus" href="/jasper/1b31712e/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="jasper/1b31712e/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>1.2k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><p>转载自”Blog of UnicornX” (<span class="exturl" data-url="aHR0cDovL3VuaWNvcm54LmdpdGh1Yi5pby8=">http://unicornx.github.io/<i class="fa fa-external-link-alt"></i></span>)</p></li><li><p>面向对象的思想在c语言中的应用，第一次看到才知道c语言还能这么用。。。</p></li></ul><hr><h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><ul><li>语言只是工具，重要的是思想。但是！！C语言用面向对象？？看了内核代码，真给那些写Linux、内核的大神跪了。。。</li><li>当然因为C语言的局限性，并非完全面向对象的实现，私有成员等就没有了。</li></ul><h3 id="封装"><a class="markdownIt-Anchor" href="#封装"></a> 封装</h3><ul><li><p>既类在C语言中的实现，实际上是 struct + 函数体 = 函数表<br>结构体里不允许存在成员函数，但是换成指向函数的指针是可以滴。</p></li><li><p>示例</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">foo_operations</span> &#123;</span></span><br><span class="line"> <span class="type">void</span> (*op_a) (<span class="keyword">struct</span> foo *, <span class="type">loff_t</span>, <span class="type">int</span>);</span><br><span class="line">  <span class="type">void</span> (*op_b) (<span class="keyword">struct</span> foo *, <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *);</span><br><span class="line">  <span class="type">void</span> (*op_c) (<span class="keyword">struct</span> foo *, <span class="type">const</span> <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *);</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure></li></ul><h3 id="继承"><a class="markdownIt-Anchor" href="#继承"></a> 继承</h3><ul><li><p>这个简单点， struct 里面套 struct ，警告熟悉c语言的应该都清除。。。这里没有父类子类的严格区分，实际上是完全自由的。</p></li><li><p>示例</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">foo</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> a;</span><br><span class="line">  <span class="type">int</span> b;</span><br><span class="line">  <span class="type">int</span> c;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">foo_operations</span> <span class="title">ops</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li></ul><h3 id="多态"><a class="markdownIt-Anchor" href="#多态"></a> 多态</h3><ul><li><p>这个是最有意思的，c语言中严格规定同一个.c文件/工程中不能存在重名函数，但是c语言的精华-指针给了思路，借助结构体，我函数名不变，每指向不同的结构体变量就行了。。。虽然还是很麻烦。。</p></li><li><p>示例</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">foo</span> <span class="title">a</span>;</span></span><br><span class="line">a-&gt;ops = ops1;</span><br><span class="line">a-&gt;ops-&gt;op_a(a);</span><br><span class="line"><span class="comment">//切换</span></span><br><span class="line">a-&gt;ops = ops2;</span><br><span class="line">a-&gt;ops-&gt;op_a(a);</span><br></pre></td></tr></table></figure></li></ul><h3 id="链表"><a class="markdownIt-Anchor" href="#链表"></a> 链表</h3><ul><li><p>内核内大量运用链表，开始不清楚真是头晕。。</p></li><li><p>示例</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>一个指向自身的结构体，包含下一个与自身的指针。<br>使用</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">A_LIST</span> &#123;</span></span><br><span class="line">  <span class="type">data_t</span>            data;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    *<span class="title">list</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li><li><p>offsetof宏</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> offsetof(type, member) (size_t)&amp;(((type*)0)-&gt;member)</span></span><br></pre></td></tr></table></figure><p>offsetof是用来判断结构体中成员的偏移位置</p></li><li><p>container_of_宏</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> container_of(ptr, type, member) (&#123; \</span></span><br><span class="line"><span class="meta">   const typeof( ((type *)0)-&gt;member ) *__mptr = (ptr); \</span></span><br><span class="line"><span class="meta">   (type *)( (char *)__mptr - offsetof(type,member) );&#125;)</span></span><br></pre></td></tr></table></figure><p>根据一个结构体变量中的一个域成员变量的指针来获取指向整个结构体变量的指针…链表元素常用</p></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://jasper1024.com/jasper/4dda4cf7/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jfif"><meta itemprop="name" content="Jasper"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="默"><meta itemprop="description" content="微尘"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content=" | 默"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/jasper/4dda4cf7/" class="post-title-link" itemprop="url">Android笔记—乐联网上传数据 TCP长连接总结</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2017-06-11 12:00:00" itemprop="dateCreated datePublished" datetime="2017-06-11T12:00:00Z">2017-06-11</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Android笔记</span></a> </span></span><span id="/jasper/4dda4cf7/" class="post-meta-item leancloud_visitors" data-flag-title="Android笔记—乐联网上传数据 TCP长连接总结" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Disqus：</span> <a title="disqus" href="/jasper/4dda4cf7/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="jasper/4dda4cf7/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>7.9k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>7 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><hr><p>资料来源如下</p><ul><li>乐联网</li></ul><p>编程环境</p><ul><li>Android Studio 2.2.3</li></ul><hr><h2 id="最终效果"><a class="markdownIt-Anchor" href="#最终效果"></a> 最终效果</h2><ul><li>使用okhttp上传数据。</li><li>Tcp长连接实现方向控制</li><li>以代码为主</li></ul><h2 id="相关教程"><a class="markdownIt-Anchor" href="#相关教程"></a> 相关教程</h2><ul><li><p>okhttp入门</p><blockquote><p><span class="exturl" data-url="aHR0cDovL2Jsb2cuY3Nkbi5uZXQvYmllemhpaHVhL2FydGljbGUvZGV0YWlscy81MDYwMzYyNA==">http://blog.csdn.net/biezhihua/article/details/50603624<i class="fa fa-external-link-alt"></i></span></p></blockquote></li><li><p>乐联网</p><blockquote><p><span class="exturl" data-url="aHR0cHM6Ly93d3cubGV3ZWk1MC5jb20vZGV2L2RvYy8xNzY=">https://www.lewei50.com/dev/doc/176<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cubGV3ZWk1MC5jb20vZGV2L2RvYy8xNTU=">https://www.lewei50.com/dev/doc/155<i class="fa fa-external-link-alt"></i></span></p></blockquote></li><li><p>Tcp长连接</p><blockquote><p><span class="exturl" data-url="aHR0cDovL2xzMTUxMTQ4NDM1NjkuYmxvZy41MWN0by5jb20vMTEwMTUzOTkvMTc2NzE5NQ==">http://ls15114843569.blog.51cto.com/11015399/1767195<i class="fa fa-external-link-alt"></i></span></p></blockquote></li><li><p>简易上传</p><blockquote><p><span class="exturl" data-url="aHR0cDovL2xzMTUxMTQ4NDM1NjkuYmxvZy41MWN0by5jb20vMTEwMTUzOTkvMTc2NzE5NQ==">http://ls15114843569.blog.51cto.com/11015399/1767195<i class="fa fa-external-link-alt"></i></span></p></blockquote></li></ul><h2 id="上传数据"><a class="markdownIt-Anchor" href="#上传数据"></a> 上传数据</h2><ul><li><p>API介绍</p><blockquote><p><span class="exturl" data-url="aHR0cHM6Ly93d3cubGV3ZWk1MC5jb20vZGV2L2FwaWluZm8vMw==">https://www.lewei50.com/dev/apiinfo/3<i class="fa fa-external-link-alt"></i></span></p></blockquote></li><li><p>API测试</p><blockquote><p><span class="exturl" data-url="aHR0cHM6Ly93d3cubGV3ZWk1MC5jb20vZGV2L2FwaXRlc3QvMw==">https://www.lewei50.com/dev/apitest/3<i class="fa fa-external-link-alt"></i></span></p></blockquote></li><li><p>地址：<span class="exturl" data-url="aHR0cDovL3d3dy5sZXdlaTUwLmNvbS9hcGkvdjEvZ2F0ZXdheS91cGRhdGVzZW5zb3JzLyVFNCVCRCVBMCVFNyU5QSU4NCVFNyVCRCU5MSVFNSU4NSVCMyVFNSU4RiVCNw==">http://www.lewei50.com/api/v1/gateway/updatesensors/你的网关号<i class="fa fa-external-link-alt"></i></span></p><p>POST方式</p><p>需要配置header头 Userkey</p></li><li><p>数据发送/返回方式JSON</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span><span class="string">&quot;T1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Value&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span><span class="string">&quot;01H1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Value&quot;</span><span class="punctuation">:</span><span class="string">&quot;96.2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>返回格式</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Successful&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Message&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li><li><p>okhttp POST 传感器数据 这里使用了一个静态内部类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">//返回数据处理</span></span><br><span class="line">  <span class="keyword">public</span> okhttp3.<span class="type">Callback</span> <span class="variable">callback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">okhttp3</span>.Callback() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(Call call, Response response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">          <span class="comment">//返回服务器内容</span></span><br><span class="line">          <span class="type">String</span> <span class="variable">responsedata</span> <span class="operator">=</span> response.body().string();</span><br><span class="line">          LogUtil.d(<span class="string">&quot;okHttp&quot;</span>, responsedata);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Call call, IOException e)</span> &#123;</span><br><span class="line">          <span class="comment">//异常处理</span></span><br><span class="line">          LogUtil.d(<span class="string">&quot;okHttp&quot;</span>, <span class="string">&quot;POST错误&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//内部类</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Http</span> &#123;</span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">MediaType</span> <span class="variable">MEDIA_TYPE_MARKDOWN</span></span><br><span class="line">              <span class="operator">=</span> MediaType.parse(<span class="string">&quot;text/x-markdown; charset=utf-8&quot;</span>);</span><br><span class="line"><span class="comment">//POST数据，指定接收回掉</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">postData</span><span class="params">(String sensor_name, String sensor_data, okhttp3.Callback callback)</span> &#123;</span><br><span class="line">          <span class="type">OkHttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>();</span><br><span class="line">          <span class="keyword">final</span> <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span></span><br><span class="line">                  <span class="string">&quot;[&quot;</span> +</span><br><span class="line">                          <span class="string">&quot;    &#123;&quot;</span> +</span><br><span class="line">                          <span class="string">&quot;        \&quot;Name\&quot;:\&quot;&quot;</span> + sensor_name + <span class="string">&quot;\&quot;,&quot;</span> +</span><br><span class="line">                          <span class="string">&quot;        \&quot;Value\&quot;:\&quot;&quot;</span> + sensor_data + <span class="string">&quot;\&quot;&quot;</span> +</span><br><span class="line">                          <span class="string">&quot;    &#125;&quot;</span> +</span><br><span class="line">                          <span class="string">&quot;]&quot;</span>;</span><br><span class="line">          <span class="type">RequestBody</span> <span class="variable">requestBody</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestBody</span>() &#123;</span><br><span class="line">              <span class="meta">@Override</span></span><br><span class="line">              <span class="keyword">public</span> MediaType <span class="title function_">contentType</span><span class="params">()</span> &#123;</span><br><span class="line">                  <span class="keyword">return</span> MEDIA_TYPE_MARKDOWN;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="meta">@Override</span></span><br><span class="line">              <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeTo</span><span class="params">(BufferedSink sink)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                  sink.write(value.getBytes());</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;;</span><br><span class="line">          <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">                  .url(<span class="string">&quot;http://www.lewei50.com/api/V1/gateway/UpdateSensors/01&quot;</span>)</span><br><span class="line">                  .header(<span class="string">&quot;userkey&quot;</span>, <span class="string">&quot;你的userkey&quot;</span>)</span><br><span class="line">                  .post(requestBody)</span><br><span class="line">                  .build();</span><br><span class="line">          client.newCall(request).enqueue(callback);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li><li><p>实际使用 放在一个后台服务内，调用相当简单</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Http.postData(<span class="string">&quot;PM2.5&quot;</span>, <span class="string">&quot;你的数据转为String&quot;</span>, callback);</span><br></pre></td></tr></table></figure></li></ul><h2 id="tcp长连接远程控制"><a class="markdownIt-Anchor" href="#tcp长连接远程控制"></a> Tcp长连接，远程控制</h2><ul><li><p>首先参考<span class="exturl" data-url="aHR0cHM6Ly93ZW5rdS5iYWlkdS5jb20vdmlldy9mMzQ1N2I2M2RkMzM4M2M0YmI0Y2QyZjAuaHRtbA==">乐联网反向控制教程<i class="fa fa-external-link-alt"></i></span>，新建一个控制器，这里以开关为例。</p></li><li><p>原理是与服务器保持一个TCP长连接，不到40s刷新一次，以此保持通道，与被控制段通信，发送控制信息。</p></li><li><p>Tcp长连接参考了@墨迹流韶的<span class="exturl" data-url="aHR0cDovL2Jsb2cuY29jb3Blci5jb20vMjAxNy8wMS8yMS9BbmRyb2lkL0NvbW1vbi8yMDE3LTAxLTIxLUFuZHJvaWQlRTUlOUYlQkElRTQlQkElOEVUY3AlRTUlOEQlOEYlRTglQUUlQUUlRTclOUElODRTb2NrZXQlRTklOTUlQkYlRTklOTMlQkUlRTYlOEUlQTUlRTUlQjAlODElRTglQTMlODUv">Android基于Tcp协议的Socket长链接封装<i class="fa fa-external-link-alt"></i></span></p></li><li><p>地址 <span class="exturl" data-url="aHR0cDovL3RjcC5sZXdlaTUwLmNvbQ==">tcp.lewei50.com<i class="fa fa-external-link-alt"></i></span><br>端口号 9960<br>心跳包间隔 1min以内</p></li><li><p>发送/接收数据格式 Json<br>本地发送数据格式</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;update&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;gatewayNo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;你的网关号&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;userkey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;你的userkey&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#125;</span>&amp;^!</span><br></pre></td></tr></table></figure><p>服务器发送控制命令格式，数据处理时需要去掉字符串最后的&amp;^!</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;send&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&quot;gatewayNo&quot;</span><span class="punctuation">:</span><span class="string">&quot;01&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&quot;userkey&quot;</span><span class="punctuation">:</span><span class="string">&quot;6d16ddb3c58c4e448a7e15e7acxxxxxx&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&quot;f&quot;</span><span class="punctuation">:</span><span class="string">&quot; updateSensor&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&quot;p1&quot;</span><span class="punctuation">:</span><span class="string">&quot;D1&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&quot;p2&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#125;</span>&amp;^!</span><br></pre></td></tr></table></figure><p>本地响应控制命令后返回数据格式</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;response&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&quot;result&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;ok!&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line"></span><br><span class="line">       <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;D1&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  	<span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#125;</span>&amp;^!</span><br></pre></td></tr></table></figure></li><li><p>TCP连接类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TcpSocketHelper</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">String</span> <span class="variable">mTag</span> <span class="operator">=</span> <span class="string">&quot;TcpSocketHelper&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> Socket socket;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">boolean</span> _connect;</span><br><span class="line">  <span class="keyword">private</span> ReceiveThread mReceiveThread;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">boolean</span> receiveStop;</span><br><span class="line">  <span class="keyword">private</span> Date lastKeepAliveOkTime;</span><br><span class="line">  <span class="keyword">private</span> OnRecivedListener mRecivedListener;</span><br><span class="line">  <span class="comment">//地址</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">String</span> <span class="variable">mIpAddr</span> <span class="operator">=</span> <span class="string">&quot;http://tcp.lewei50.com&quot;</span>;</span><br><span class="line">  <span class="comment">//端口</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> <span class="variable">mPort</span> <span class="operator">=</span> <span class="number">9960</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 开启链接socket</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> ipAddr</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> port</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startConnect</span><span class="params">(String ipAddr, <span class="type">int</span> port)</span>&#123;</span><br><span class="line">      LogUtil.d(mTag, <span class="string">&quot;准备链接...&quot;</span>);</span><br><span class="line">      <span class="built_in">this</span>.mIpAddr = ipAddr;</span><br><span class="line">      <span class="built_in">this</span>.mPort = port;</span><br><span class="line">      InetAddress serverAddr;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          socket = <span class="keyword">new</span> <span class="title class_">Socket</span>(ipAddr, port);</span><br><span class="line">          LogUtil.d(mTag, <span class="string">&quot;准备链接...&quot;</span>);</span><br><span class="line">          _connect = <span class="literal">true</span>;</span><br><span class="line">          mReceiveThread = <span class="keyword">new</span> <span class="title class_">ReceiveThread</span>();</span><br><span class="line">          receiveStop = <span class="literal">false</span>;</span><br><span class="line">          mReceiveThread.start();</span><br><span class="line">          LogUtil.d(mTag, <span class="string">&quot;链接成功...&quot;</span>);</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          LogUtil.d(mTag, <span class="string">&quot;链接出错...&quot;</span> + e.getMessage());</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 关闭链接</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">closeConnect</span><span class="params">()</span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (socket != <span class="literal">null</span>)&#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              socket.close();</span><br><span class="line">              socket = <span class="literal">null</span>;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">              e.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 保持心跳</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">KeepAlive</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="comment">// 判断socket是否已断开,断开就重连</span></span><br><span class="line">      <span class="keyword">if</span> (lastKeepAliveOkTime != <span class="literal">null</span>) &#123;</span><br><span class="line">          LogUtil.d(mTag, <span class="string">&quot;上次心跳成功时间:&quot;</span>+ DateFormat.format(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>, lastKeepAliveOkTime));</span><br><span class="line">          <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> Calendar.getInstance().getTime();</span><br><span class="line">          <span class="type">long</span> <span class="variable">between</span> <span class="operator">=</span> (now.getTime() - lastKeepAliveOkTime.getTime());<span class="comment">// 得到两者的毫秒数</span></span><br><span class="line">          <span class="keyword">if</span> (between &gt; <span class="number">60</span> * <span class="number">1000</span>) &#123;</span><br><span class="line">              LogUtil.d(mTag, <span class="string">&quot;心跳异常超过40,重新连接:&quot;</span>);</span><br><span class="line">              lastKeepAliveOkTime = <span class="literal">null</span>;</span><br><span class="line">              socket = <span class="literal">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          lastKeepAliveOkTime = Calendar.getInstance().getTime();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!checkIsAlive()) &#123;</span><br><span class="line">          LogUtil.d(mTag, <span class="string">&quot;链接已断开,重新连接.&quot;</span>);</span><br><span class="line">          startConnect(mIpAddr, mPort);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 此方法是检测是否连接</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkIsAlive</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (socket == <span class="literal">null</span>||!socket.isConnected())</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 发送数据的方法</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendmessage</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">      <span class="type">boolean</span> <span class="variable">isAlive</span> <span class="operator">=</span> checkIsAlive();</span><br><span class="line">      <span class="keyword">if</span> (!isAlive)</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      LogUtil.d(mTag, <span class="string">&quot;准备发送消息:&quot;</span> + msg);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (socket != <span class="literal">null</span> &amp;&amp; socket.isConnected()) &#123;</span><br><span class="line">              <span class="keyword">if</span> (!socket.isOutputShutdown()) &#123;</span><br><span class="line"></span><br><span class="line">                  <span class="comment">//2.得到socket读写流</span></span><br><span class="line">                  OutputStream os=socket.getOutputStream();</span><br><span class="line">                  <span class="comment">//true:是否自动flush</span></span><br><span class="line">                  PrintWriter outStream=<span class="keyword">new</span> <span class="title class_">PrintWriter</span>(os, <span class="literal">true</span>);</span><br><span class="line">                  outStream.print(msg);</span><br><span class="line">                  outStream.flush();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          LogUtil.d(mTag, <span class="string">&quot;发送成功!&quot;</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 设置接收数据监听器</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> mRecivedListener</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setmRecivedListener</span><span class="params">(OnRecivedListener mRecivedListener)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.mRecivedListener = mRecivedListener;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 数据接收线程</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">ReceiveThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  sleep(<span class="number">2000</span>);</span><br><span class="line">                    <span class="comment">// 判断 Socket 是否处于连接状态</span></span><br><span class="line">                  <span class="keyword">if</span> (socket != <span class="literal">null</span> &amp;&amp; socket.isConnected()) &#123;</span><br><span class="line">                      <span class="comment">// 客户端接收服务器端的响应，读取服务器端向客户端的输入流</span></span><br><span class="line">                      <span class="type">InputStream</span> <span class="variable">isRead</span> <span class="operator">=</span> socket.getInputStream();</span><br><span class="line">                      <span class="comment">// 缓冲区</span></span><br><span class="line">                      <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[isRead.available()];</span><br><span class="line">                      <span class="comment">// 读取缓冲区</span></span><br><span class="line">                      isRead.read(buffer);</span><br><span class="line">                      <span class="comment">// 转换为字符串</span></span><br><span class="line">                      <span class="type">String</span> <span class="variable">responseInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(buffer);</span><br><span class="line">                      <span class="comment">// 日志中输出</span></span><br><span class="line">                      <span class="keyword">if</span>(responseInfo != <span class="literal">null</span>&amp;&amp;!responseInfo.equals(<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">                          LogUtil.d(<span class="string">&quot;TcpManager&quot;</span>, <span class="string">&quot;返回：&quot;</span>+responseInfo);</span><br><span class="line">                          mRecivedListener.onRecived(responseInfo);</span><br><span class="line">                      &#125;</span><br><span class="line"></span><br><span class="line">                      lastKeepAliveOkTime = Calendar.getInstance().getTime();</span><br><span class="line">                      KeepAlive();</span><br><span class="line"></span><br><span class="line">                      <span class="keyword">continue</span>;</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      <span class="keyword">if</span> (socket != <span class="literal">null</span>)</span><br><span class="line">                          LogUtil.d(mTag, <span class="string">&quot;链接状态:&quot;</span> + socket.isConnected());</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">              &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                  LogUtil.d(mTag, <span class="string">&quot;监听出错:&quot;</span> + e.toString());</span><br><span class="line">                  e.printStackTrace();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>使用,包装在一个后台service中，在service中实现TcpSocketHelper的onRecived方法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  //tcp返回信息</span><br><span class="line">  @Override</span><br><span class="line">  public void onRecived(String data) &#123;</span><br><span class="line">      LogUtil.d(&quot;okHttpService&quot;, data);</span><br><span class="line">      //处理服务器发回的数据</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">TcpSocketHelper tcpSocketHelper  = new TcpSocketHelper();</span><br><span class="line">tcpSocketHelper.startConnect(&quot;tcp.lewei50.com&quot;, 9960);</span><br><span class="line">//设置监听</span><br><span class="line">tcpSocketHelper.setmRecivedListener(this);</span><br></pre></td></tr></table></figure></li><li><p>发送心跳包</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span></span><br><span class="line">          <span class="string">&quot;    &#123;&quot;</span> +</span><br><span class="line">                  <span class="string">&quot;        \&quot;method\&quot;:\&quot;update\&quot;,&quot;</span> +</span><br><span class="line">                  <span class="string">&quot;        \&quot;gatewayNo\&quot;:\&quot;01\&quot;,&quot;</span> +</span><br><span class="line">                  <span class="string">&quot;        \&quot;userkey\&quot;:\&quot;你的userkey\&quot;&quot;</span> +</span><br><span class="line">                  <span class="string">&quot;    &#125;&amp;^!&quot;</span>;</span><br><span class="line"> <span class="comment">//发送数据</span></span><br><span class="line"> tcpSocketHelper.sendmessage(value);</span><br></pre></td></tr></table></figure></li><li><p>处理数据 在service的onRecived中</p></li><li><p>本地处理完毕后，向服务器返回被控制器状态</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">value5</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;method\&quot;:\&quot;response\&quot;,\&quot;result\&quot;:&#123;\&quot;successful\&quot;:true,\&quot;message\&quot;:\&quot;ok!\&quot;,\&quot;data\&quot;:[&#123;\&quot;id\&quot;:\&quot;D1\&quot;,\&quot;value \&quot;:\&quot;1\&quot;&#125;]&#125;&#125;&amp;^! &quot;</span>;</span><br><span class="line"></span><br><span class="line">tcpSocketHelper.sendmessage(value6);</span><br></pre></td></tr></table></figure></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://jasper1024.com/jasper/2c46ee71/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jfif"><meta itemprop="name" content="Jasper"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="默"><meta itemprop="description" content="微尘"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content=" | 默"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/jasper/2c46ee71/" class="post-title-link" itemprop="url">Android笔记—Activity</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2016-12-07 12:00:00" itemprop="dateCreated datePublished" datetime="2016-12-07T12:00:00Z">2016-12-07</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2017-05-08 12:00:00" itemprop="dateModified" datetime="2017-05-08T12:00:00Z">2017-05-08</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Android笔记</span></a> </span></span><span id="/jasper/2c46ee71/" class="post-meta-item leancloud_visitors" data-flag-title="Android笔记—Activity" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Disqus：</span> <a title="disqus" href="/jasper/2c46ee71/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="jasper/2c46ee71/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>12k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>11 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><hr><ul><li>资料来源如下</li><li>第一行代码(第二版)</li></ul><hr><h2 id="activity基础"><a class="markdownIt-Anchor" href="#activity基础"></a> Activity基础</h2><h3 id="activity定义"><a class="markdownIt-Anchor" href="#activity定义"></a> Activity定义</h3><ul><li>Activity 是Android四大组件之一，用户可与其提供的屏幕进行交互，以执行操作。 每个 Activity 都会获得一个用于绘制其用户界面的窗口。窗口可以充满屏幕，也可浮动。应用通常由多个彼此联系的 Activity 组成。应用中的某个 Activity 为“主”Activity，即首次启动应用时的Activity。</li></ul><h3 id="创建activity"><a class="markdownIt-Anchor" href="#创建activity"></a> 创建Activity</h3><ul><li><p>新建FirstAtivity继承自AppCompatActivity</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FirstActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span>&#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span>  <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure></li><li><p>创建加载布局<br><a target="_blank" rel="noopener external nofollow noreferrer" href="http://snapgr.am/image/LoY4"><img data-src="https://i.loli.net/2019/03/26/5c9a2a9bf2a52.jpg" alt="1.jpg"></a></p></li><li><p>切换到first-layout</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  &lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="line">  &lt;LinearLayout</span><br><span class="line">  xmlns:android=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="line">  android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">  android:layout_height=<span class="string">&quot;match_parent&quot;</span>&gt;</span><br><span class="line">  &lt;Button</span><br><span class="line">      android:id=<span class="string">&quot;@+id/button_1&quot;</span></span><br><span class="line">      android:text=<span class="string">&quot;button_1&quot;</span></span><br><span class="line">      android:layout_width=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">      android:layout_height=<span class="string">&quot;wrap_content&quot;</span> /&gt;</span><br><span class="line">&lt;/LinearLayout&gt;</span><br></pre></td></tr></table></figure></li><li><p>在FirestActivity中加载layout<br>在onCreate中加入</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setContentView(R.layout.first_layout);</span><br></pre></td></tr></table></figure></li><li><p>在AndroidMainfest文件中注册。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;activity</span><br><span class="line">           android:name=<span class="string">&quot;.FirstActivity&quot;</span></span><br><span class="line">           android:label=<span class="string">&quot;This is FirstActivity&quot;</span>&gt;</span><br><span class="line">           &lt;intent-filter&gt;</span><br><span class="line">               &lt;action android:name=<span class="string">&quot;android.intent.action.MAIN&quot;</span>/&gt;</span><br><span class="line">               &lt;category android:name=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span>/&gt;</span><br><span class="line">           &lt;/intent-filter&gt;</span><br><span class="line">&lt;/activity&gt;</span><br></pre></td></tr></table></figure></li><li><p>在模拟器中启动apk<br><a target="_blank" rel="noopener external nofollow noreferrer" href="http://snapgr.am/image/LogP"><img data-src="https://i.loli.net/2019/03/26/5c9a2ab459df5.jpg" alt="5ea429.jpg"></a></p></li></ul><h3 id="使用toast"><a class="markdownIt-Anchor" href="#使用toast"></a> 使用Toast</h3><blockquote><p><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vZ3VpZGUvdG9waWNzL3VpL25vdGlmaWVycy90b2FzdHMuaHRtbCNQb3NpdGlvbmluZw==">Toast google官方说明<i class="fa fa-external-link-alt"></i></span></p></blockquote><ul><li><p>推送一个短小信息推送给用户<br>如图（摘自android developer）<br><img data-src="https://i.loli.net/2019/03/26/5c9a2acc54d34.png" alt="toast.png"></p></li><li><p>使用方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Toast.makeText(context, text, duration).show();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>举例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Toast.makeText(FirstActivity.<span class="built_in">this</span>, <span class="string">&quot;you clicked button 1&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line"><span class="comment">/*                  activity.this   消息内容                显示时间设置   */</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="使用menu"><a class="markdownIt-Anchor" href="#使用menu"></a> 使用Menu</h3><ul><li><p>创建菜单</p><ul><li>在res下新疆menu文件夹，右击menu文件夹—new—Menu resource file，创建main的菜单文件。</li><li>main.xml中添加如下代码<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">menu</span>        <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">item</span></span></span><br><span class="line"><span class="tag">     <span class="attr">android:id</span>=<span class="string">&quot;@+id/add_item&quot;</span></span></span><br><span class="line"><span class="tag">     <span class="attr">android:title</span>=<span class="string">&quot;Add&quot;</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">item</span></span></span><br><span class="line"><span class="tag">     <span class="attr">android:id</span>=<span class="string">&quot;@+id/remove_item&quot;</span></span></span><br><span class="line"><span class="tag">     <span class="attr">android:title</span>=<span class="string">&quot;Remove&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">menu</span>&gt;</span></span><br></pre></td></tr></table></figure>这里创建了两个菜单项 Add和Remove</li><li>在FirestActivity中重写 onCreateOptionsMenu()方法（快捷键 Ctrl+O）<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> &#123;</span><br><span class="line">    getMenuInflater().inflate(R.menu.main, menu);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><code>getMenuInflater()</code>可以得到MenuInflater对象，再调用.inflate就可以创建菜单。.inflat接受俩个参数，一是资源文件名，二是菜单项添加至那个对象中。onCreateOptionsMenu方法中返回true表示创建菜单并显示。</li><li>效果如下。<br><img data-src="https://i.loli.net/2019/03/26/5c9a2ae41cb42.png" alt="Screenshot_1481113497.png"></li></ul></li><li><p>创建菜单点击响应事件</p><ul><li>重写onOptionsItemSelected方法<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> &#123;</span><br><span class="line">   <span class="keyword">switch</span> (item.getItemId()) &#123;</span><br><span class="line">       <span class="keyword">case</span> R.id.add_item:</span><br><span class="line">           Toast.makeText(<span class="built_in">this</span>, <span class="string">&quot;Add&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">case</span> R.id.remove_item:</span><br><span class="line">           Toast.makeText(<span class="built_in">this</span>, <span class="string">&quot;Remove&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">default</span>:</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>通过item.getItemId()判断点击选项，弹出不同的Toast</li></ul></li></ul><h3 id="向一个activity-并传递字符串"><a class="markdownIt-Anchor" href="#向一个activity-并传递字符串"></a> 向一个activity 并传递字符串</h3><ul><li><p>构建一个Intent<br><code>Intent intent = new Intent(this, DisplayMessageActivity.class);</code><br>构造方法有两个参数：<br>Context 是第一个参数，这里使用了this是因为Activity是Context的子类。<br>Class 类是系统将要分发的APP组件，在这里，这个Activity将会被启动。</p></li><li><pre class="highlight"><code class="java"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(View view)</span> &#123;
    <span class="comment">// 创建一个新的intent对象，绑定DisplayMessageActivity</span>
    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="built_in">this</span>, DisplayMessageActivity.class);
    <span class="comment">//创建一个editText对象，绑定xml中editText</span>
    <span class="type">EditText</span> <span class="variable">editText</span> <span class="operator">=</span> (EditText) findViewById(R.id.edit_message);
    <span class="comment">//获取editText中输入文字，转成字符串</span>
    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> editText.getText().toString();
    <span class="comment">//一个Intent对象可以携带被称为extras的键值对。</span>
    <span class="comment">// putExtra()方法将键放在第一个参数中，将值放在第二个参数中。</span>
    intent.putExtra(EXTRA_MESSAGE, message);
    <span class="comment">//启动intent对应Activity</span>
    startActivity(intent);
    &#125;
&lt;!--code￼<span class="number">9</span>--&gt;

</code></pre></li></ul><h3 id="返回数据给上一个activity"><a class="markdownIt-Anchor" href="#返回数据给上一个activity"></a> 返回数据给上一个Activity</h3><ul><li><p>构建Intent使用startActivityForResult()方法传入请求码，启动下一个Activity<br>在下一个Activity中构建Intent，intent.putExtra存入键值-key，调用setResult()方法，传入finish()结束掉Activity<br>重写第一个Activity中的onActivityResult()方法，调用.getStringExtra取出key对应键值。</p></li><li><p>startActivityForResult(Intent, int Bundle) Intent与单纯启动Activity的Intent相同，第二个是请求码，下一级 回调提供相同的请求码，以便您应用可以正确识别结果。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(FirestActivity.<span class="built_in">this</span>,ScendActivity.class);</span><br><span class="line">startActivityForResult(intent,<span class="number">1</span>);</span><br></pre></td></tr></table></figure></li><li><p>setResult()方法，第一个参数向上级方法处理结果，一般使用RESULT_OK或RESULT_CANCELED，第二个参数 对应Intent</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//新建显示Intent</span></span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line"><span class="comment">//存入key-键值</span></span><br><span class="line">intent.putExtra(<span class="string">&quot;data_return&quot;</span>,<span class="string">&quot;Hello Firest&quot;</span>);</span><br><span class="line">setResult(RESULT_OK,intent);</span><br><span class="line"><span class="comment">//结束Activity</span></span><br><span class="line">finish();</span><br></pre></td></tr></table></figure></li><li><p>onActivityResult()三个参数.第一个startActivityForResult() 传递的请求代码。第二个 Activity 指定的结果代码。成功是 RESULT_OK；失败，则是 RESULT_CANCELED。第三个是传送结果数据的 Intent。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onActivityResult</span><span class="params">(<span class="type">int</span> requestCode,<span class="type">int</span> resultCode,Intent data)</span>&#123;</span><br><span class="line">    <span class="comment">//选择不同请求码对应处理逻辑</span></span><br><span class="line">    <span class="keyword">switch</span>(requestCode)&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="comment">//处理结果时候ok</span></span><br><span class="line">            <span class="keyword">if</span>(resultCode == RESULT_OK)&#123;</span><br><span class="line">                <span class="comment">//取出数据</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">returnedData</span> <span class="operator">=</span> data.getStringExtra(<span class="string">&quot;data_return&quot;</span>);</span><br><span class="line">                Log.d(<span class="string">&quot;FirstActivity&quot;</span>, returnedData);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="activity生命周期"><a class="markdownIt-Anchor" href="#activity生命周期"></a> Activity生命周期</h2><p><img data-src="https://i.loli.net/2019/03/26/5c9a2afc17732.png" alt="basic-lifecycle.png"></p><ul><li>Activity 3种状态<ul><li>Resumed/继续<br>Activity 处于前台，且用户可以与其交互</li><li>Paused/暂停<br>Activity 被在前台中处于另一个 Activity—部分阻挡。 暂停的 Activity 不会接收用户输入并且无法执行任何代码。</li><li>Stopped/停止<br>Activity完全隐藏，对用户完全不可见.当停止时，activity的所有状态信息比如成员变量都会被保留，但是不能再执行任何代码</li></ul></li></ul><h3 id="启动一个activity"><a class="markdownIt-Anchor" href="#启动一个activity"></a> 启动一个Activity</h3><ul><li>onCreate方法</li><li>主Activity：<ul><li>用户点击app图标，启动主Activity</li><li>在AndroidManifest.xml中声明<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul></li><li>通过调用onCreate方法创建一个Activity实例，onCreate方法在Activity的整个生命周期中只执行一次。</li><li>之后系统会很快的调用onStart和onResume方法，Activity进入Resumed/继续模式。直到被其他activity覆盖/屏幕关闭。</li></ul><h3 id="销毁activity"><a class="markdownIt-Anchor" href="#销毁activity"></a> 销毁Activity</h3><ul><li>onDestory方法<br>大多数的APP不需要实现这个方法，因为本地类引用会随着Activity一起总结，不过Activity的清理工作应该放在onPause下或者onStop。</li><li>Note:<br>在所有的情况下系统调用onDestory方法之后已经调用过onPause方法与onStop方法，不过有一个例外情况：你在onCreate方法中调用了finish方法。在一些例子中，当你的Activity临时决定要启动另一个Activity，你可能要在onCreate方法内调用finish方法来销毁这个Activity，在这种情况下，系统会立即调用onDestory方法，而不会调用其它任何生命周期方法。</li></ul><h3 id="暂停activity"><a class="markdownIt-Anchor" href="#暂停activity"></a> 暂停Activity</h3><ul><li>onPause()方法</li><li>Activity被其他Activity覆盖/失去用户焦点，系统调用onPause()方法，Activity 进入暂停状态。<ul><li>note：android7.0及以上版本加入了多窗口模式，当Activity失去用户焦点时，可能处于多窗口模式。</li></ul></li><li>onPause() 常用回调：<ul><li>检查 Activity 是否可见。不可见则停止可能消耗 CPU 的操作</li><li>提交未保存的更改，仅保存用户离开时希望永久性保存此类更改（比如电子邮件草稿）。</li><li>释放系统资源，GPS/Camer等</li><li>示例 (释放Camer)<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPause</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="built_in">super</span>.onPause();  <span class="comment">// Always call the superclass method first</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Release the Camera because we don&#x27;t need it when paused</span></span><br><span class="line"><span class="comment">// and other activities might need to use it.</span></span><br><span class="line"><span class="keyword">if</span> (mCamera != <span class="literal">null</span>) &#123;</span><br><span class="line">   mCamera.release();</span><br><span class="line">   mCamera = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>注意事项：<ul><li>在onPause()一般不执行永久性存储用户更改，不执行 CPU 密集型工作，这些工作一般放在onStop() 。</li></ul></li></ul></li></ul><h3 id="继续-activity"><a class="markdownIt-Anchor" href="#继续-activity"></a> 继续 Activity</h3><ul><li>onResume() 方法</li><li>暂停状态回到继续状态，Activity第一次启动时也会调用这个方法。</li><li>onResume() 以初始化在 onPause() 期间释放的组件。</li><li>示例(重新获取Camera)<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResume</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="built_in">super</span>.onResume();  <span class="comment">// Always call the superclass method first</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get the Camera instance as the activity achieves full user focus</span></span><br><span class="line">  <span class="keyword">if</span> (mCamera == <span class="literal">null</span>) &#123;</span><br><span class="line">      initializeCamera(); <span class="comment">// Local method to handle camera init</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="停止-activity"><a class="markdownIt-Anchor" href="#停止-activity"></a> 停止 Activity</h3><ul><li><p>note：<br>大多数相对简单的 Activity 而言，系统在 Activity 停止时会将Activity 实例保留在系统内存中，无需实现 onStop() 和 onRestart() 或甚至onStart() 方法。可能只需使用 onPause() 暂停正在进行的操作，并从系统资源断开连接。</p></li><li><p>onStop() 方法</p></li><li><p>场景：</p><ul><li>用户在最近应用切换到另一个应用</li><li>应用中执行开始新 Activity 的操作</li><li>Activity使用时，接打电话</li></ul></li><li><p>调用时，Activity不再可见，释放几乎所有用户不使用时不需要的资源。如果系统内存紧张，则可能销毁内存中的Acitivity实例。</p></li><li><p>onStop() 方法调用后，Activity不再可见，极端情况下，系统可能会仅终止应用进程，而不调用 onDestroy() ，因此需要使用 onStop() 释放几乎所有用户不使用时不需要的资源。</p></li><li><p>尽管 onPause() 方法在 onStop()之前调用，在onStop() 执行更大、占用更多 CPU 的关闭操作，比如向数据库写入信息</p></li><li><p>示例（草稿笔记内容保存在永久存储）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onStop</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="built_in">super</span>.onStop();  <span class="comment">// Always call the superclass method first</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Save the note&#x27;s current draft, because the activity is stopping</span></span><br><span class="line">  <span class="comment">// and we want to be sure the current note progress isn&#x27;t lost.</span></span><br><span class="line">  <span class="type">ContentValues</span> <span class="variable">values</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line">  values.put(NotePad.Notes.COLUMN_NAME_NOTE, getCurrentNoteText());</span><br><span class="line">  values.put(NotePad.Notes.COLUMN_NAME_TITLE, getCurrentNoteTitle());</span><br><span class="line"></span><br><span class="line">  getContentResolver().update(</span><br><span class="line">  mUri,    <span class="comment">// The URI for the note to update.</span></span><br><span class="line">  values,  <span class="comment">// The map of column names and new values to apply to them.</span></span><br><span class="line">   <span class="literal">null</span>,    <span class="comment">// No SELECT criteria are used.</span></span><br><span class="line">   <span class="literal">null</span>     <span class="comment">// No WHERE columns are used.</span></span><br><span class="line">   );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="启动重启-activity"><a class="markdownIt-Anchor" href="#启动重启-activity"></a> 启动/重启 Activity</h3><ul><li>onStart() 方法</li><li>Activity 停止转换为继续状态时，系统回调onRestart() 方法+ onStart() 方法.onStop() 方法清理了所有 Activity 的资源，重启 Activity 需要重新实例化它们。同时 Activity 初次创建时重新实例化它们。 出于此，经常使用 onStart() 方法作为 onStop() 方法的对应</li><li>示例<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="built_in">super</span>.onStart();  <span class="comment">// Always call the superclass method first</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// The activity is either being restarted or started for the first time</span></span><br><span class="line">   <span class="comment">// so this is where we should make sure that GPS is enabled</span></span><br><span class="line">   <span class="type">LocationManager</span> <span class="variable">locationManager</span> <span class="operator">=</span></span><br><span class="line">    (LocationManager) getSystemService(Context.LOCATION_SERVICE);</span><br><span class="line">   <span class="type">boolean</span> <span class="variable">gpsEnabled</span> <span class="operator">=</span> locationManager.isProviderEnabled(LocationManager.GPS_PROVIDER);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!gpsEnabled) &#123;</span><br><span class="line">    <span class="comment">// Create a dialog here that requests the user to enable GPS, and use an intent</span></span><br><span class="line">    <span class="comment">// with the android.provider.Settings.ACTION_LOCATION_SOURCE_SETTINGS action</span></span><br><span class="line">    <span class="comment">// to take the user to the Settings screen to enable GPS when they click &quot;OK&quot;</span></span><br><span class="line">   	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onRestart</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="built_in">super</span>.onRestart();  <span class="comment">// Always call the superclass method first</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// Activity being restarted from stopped state</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="保存-activity-状态"><a class="markdownIt-Anchor" href="#保存-activity-状态"></a> 保存 Activity 状态</h3><ul><li><p>onSaveInstanceState()方法</p></li><li><p>默认情况下，Activity 实例被销毁时系统会使用 Bundle 实例状态保存 Activity 布局中有关每个 View 对象的信息。在Activity 重建时，布局状态便自动恢复先前的状态。</p></li><li><p>默认实现保存有关 Activity 视图层次的状态信息，例如 EditText 小部件中的文本或ListView 的滚动位置</p></li><li><p>要恢复的更多信息，需要重写 onSaveInstanceState()方法，将键值对添加至 Bundle 对象</p></li><li><p><img data-src="https://i.loli.net/2019/03/26/5c9a2b13d82f2.png" alt="basic-lifecycle-savestate.png"></p></li><li><p>note:<br>旋转屏幕时，Activity 将被销毁并重新创建。原因：方向更改时可能需要时加载备用资源（比如布局）</p></li><li><p>示例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">STATE_SCORE</span> <span class="operator">=</span> <span class="string">&quot;playerScore&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">STATE_LEVEL</span> <span class="operator">=</span> <span class="string">&quot;playerLevel&quot;</span>;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSaveInstanceState</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">  <span class="comment">// Save the user&#x27;s current game state</span></span><br><span class="line">   savedInstanceState.putInt(STATE_SCORE, mCurrentScore);</span><br><span class="line">   savedInstanceState.putInt(STATE_LEVEL, mCurrentLevel);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Always call the superclass so it can save the view hierarchy state</span></span><br><span class="line">   <span class="built_in">super</span>.onSaveInstanceState(savedInstanceState);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="恢复-activity"><a class="markdownIt-Anchor" href="#恢复-activity"></a> 恢复 Activity</h3><ul><li>onCreate() 和 onRestoreInstanceState() 回调方法均接收包含实例状态信息的相同 Bundle</li><li>onCreate() 方法</li><li>调用onCreate() 方法需要区分是创建 Activity 的新实例还是恢复先前的实例，判断 Bundle 是否为 null</li><li>示例<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">   <span class="built_in">super</span>.onCreate(savedInstanceState); <span class="comment">// Always call the superclass first</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// Check whether we&#x27;re recreating a previously destroyed instance</span></span><br><span class="line">   <span class="keyword">if</span> (savedInstanceState != <span class="literal">null</span>) &#123;</span><br><span class="line">       <span class="comment">// Restore value of members from saved state</span></span><br><span class="line">       mCurrentScore = savedInstanceState.getInt(STATE_SCORE);</span><br><span class="line">       mCurrentLevel = savedInstanceState.getInt(STATE_LEVEL);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="comment">// Probably initialize members with default values for a new instance</span></span><br><span class="line">  	 &#125;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>onRestoreInstanceState()方法</li><li>只需要恢复的已保存的状态</li><li>示例</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onRestoreInstanceState</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">   <span class="comment">// Always call the superclass so it can restore the view hierarchy</span></span><br><span class="line">   <span class="built_in">super</span>.onRestoreInstanceState(savedInstanceState);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Restore state members from saved instance</span></span><br><span class="line">   mCurrentScore = savedInstanceState.getInt(STATE_SCORE);</span><br><span class="line">   mCurrentLevel = savedInstanceState.getInt(STATE_LEVEL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="重启activity其他选择"><a class="markdownIt-Anchor" href="#重启activity其他选择"></a> 重启Activity其他选择</h3><ul><li><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vZ3VpZGUvdG9waWNzL3Jlc291cmNlcy9ydW50aW1lLWNoYW5nZXMuaHRtbA==">官方说明<i class="fa fa-external-link-alt"></i></span></li><li>重启应用并恢复大量数据不仅成本高昂，而且会留下糟糕的使用体验，有两个其他选择</li></ul><h4 id="在配置变更期间保留对象"><a class="markdownIt-Anchor" href="#在配置变更期间保留对象"></a> 在配置变更期间保留对象</h4><ul><li>Activity 因配置变更而重启，则可通过保留 Fragment 来减轻重新初始化 Activity 的负担</li><li>当 Android 系统因配置变更而关闭 Activity 时，不会销毁已标记为要保留的 Activity 的片段。 您可以将此类片段添加到 Activity 以保留有状态的对象。</li></ul><h2 id="activity最佳实践"><a class="markdownIt-Anchor" href="#activity最佳实践"></a> Activity最佳实践</h2><h3 id="知晓当前运行的活动"><a class="markdownIt-Anchor" href="#知晓当前运行的活动"></a> 知晓当前运行的活动</h3><ul><li><p>自定义BaseActivity继承自AppCompatActivity<br>重写onCreate方法，打印当前运行的Activity名<br>app类所有Activity改为继承BaseActivity</p></li><li><p>代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">      <span class="comment">//打印当前类名</span></span><br><span class="line">      Log.d(<span class="string">&quot;BaseActivity&quot;</span>, getClass().getSimpleName())；</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li><li><p>效果如下<br><img data-src="https://i.loli.net/2019/03/26/5c9a2b32811f2.png" alt="ScreenShot_20161208172740.png"></p></li></ul><h3 id="随时退出程序"><a class="markdownIt-Anchor" href="#随时退出程序"></a> 随时退出程序</h3><ul><li>新建ActivityCollector类作为活动管理器，添加/删除Activity登记,在BaseActivity中添加对应代码。</li><li>代码如下<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActivityCollector</span> &#123;</span><br><span class="line"><span class="comment">//新建Activity的列表对象</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Activity&gt; activities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="comment">//添加Activity进入列表</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addActivity</span><span class="params">(Activity activity)</span> &#123;</span><br><span class="line">       activities.add(activity);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//在列表中移除Activity</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">removeActivity</span><span class="params">(Activity activity)</span> &#123;</span><br><span class="line">       activities.remove(activity);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//for循环列表 结束所有Activity</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">finishAll</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">for</span> (Activity activity : activities) &#123;</span><br><span class="line">           <span class="keyword">if</span> (!activity.isFinishing()) &#123;</span><br><span class="line">               activity.finish();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li><li>BaseActivity<br>在onCreate()方法中添加<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Activity管理器中添加新的活动</span></span><br><span class="line">ActivityCollector.addActivity(<span class="built_in">this</span>);</span><br></pre></td></tr></table></figure>重写onDestroy()方法<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">super</span>.onDestroy();</span><br><span class="line">    <span class="comment">//Activity管理器中移除活动</span></span><br><span class="line">    ActivityCollector.removeActivity(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>在任何地方调用finishAll()方法即可。</li></ul><h3 id="启动活动的最近写法"><a class="markdownIt-Anchor" href="#启动活动的最近写法"></a> 启动活动的最近写法</h3><ul><li>启动下一个Activity并传递数据模块化</li><li>在SecondActivity内增加actionStart()方法<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//调用的Activity，数据1，数据2</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">actionStart</span><span class="params">(Context context, String data1, String data2)</span>&#123;</span><br><span class="line">    <span class="comment">//新建Intent，绑定SecondActivity</span></span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(context,ScendActivity.class);</span><br><span class="line">    <span class="comment">//存入data1，data2</span></span><br><span class="line">    intent.putExtra(<span class="string">&quot;param1&quot;</span>,data1);</span><br><span class="line">    intent.putExtra(<span class="string">&quot;param2&quot;</span>,data2);</span><br><span class="line">    <span class="comment">//启动Activity</span></span><br><span class="line">    context.startActivity(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>启动SecondActivity方式<br><code>ScendActivity.actionStart(FirestActivity.this,&quot;data1&quot;,&quot;data2&quot;);</code></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://jasper1024.com/jasper/4a534826/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jfif"><meta itemprop="name" content="Jasper"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="默"><meta itemprop="description" content="微尘"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content=" | 默"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/jasper/4a534826/" class="post-title-link" itemprop="url">Android笔记-自用MVP框架</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2017-05-08 12:00:00" itemprop="dateCreated datePublished" datetime="2017-05-08T12:00:00Z">2017-05-08</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Android笔记</span></a> </span></span><span id="/jasper/4a534826/" class="post-meta-item leancloud_visitors" data-flag-title="Android笔记-自用MVP框架" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Disqus：</span> <a title="disqus" href="/jasper/4a534826/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="jasper/4a534826/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>3.6k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>3 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><hr><p>资料来源如下</p><ul><li>网络</li></ul><p>编程环境</p><ul><li>Android Studio 2.2.3</li></ul><p>导语</p><ul><li>转眼刚用上手的MVP又不符合需求了，还是总结一下，继续MVVM吧。</li></ul><hr><h3 id="起"><a class="markdownIt-Anchor" href="#起"></a> 起</h3><ul><li><p>主要内容是转载，搭建小工程应该足够了。<br><span class="exturl" data-url="aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZGFudGVzdG9uZXMvYXJ0aWNsZS9kZXRhaWxzLzUwODk5MjM1">Android mvp 架构的自述<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZGFudGVzdG9uZXMvYXJ0aWNsZS9kZXRhaWxzLzUxNDQ1MjA4">如何更高效的使用MVP以及官方MVP架构解析<i class="fa fa-external-link-alt"></i></span></p></li><li><p>框架开源在GitHub 地址<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0phc3Blci0xMDI0L012cFRlc3Q=">点我直达<i class="fa fa-external-link-alt"></i></span></p></li><li><p>好，我们开始吧！</p></li></ul><hr><h3 id="mvc-mvp-mvvm"><a class="markdownIt-Anchor" href="#mvc-mvp-mvvm"></a> MVC MVP MVVM</h3><ul><li>省略200行，详情看<span class="exturl" data-url="aHR0cHM6Ly93d3cudGlhbm1heWluZy5jb20vdHV0b3JpYWwvQW5kcm9pZE1WQw==">Android App的设计架构：MVC,MVP,MVVM与架构经验谈<i class="fa fa-external-link-alt"></i></span></li><li>再累赘属于掉书袋了，作者写的是很用心，恩，MVVM也有。</li></ul><h3 id="框架详解"><a class="markdownIt-Anchor" href="#框架详解"></a> 框架详解</h3><ul><li><p>整个框架截图<br><img data-src="https://i.loli.net/2019/03/26/5c9a27f178026.png" alt="ScreenShot_20170509215208.png"></p></li><li><p>整体层次比较明确了，BaseClass 里存放基类，Model层存放数据存储有关类、Presenter层存放逻辑代码、View层存放Activity、frament等。</p></li><li><p>这个框架是由MVP在Android中应用存在的问题而搭建的，基类中代码也由此而来。</p></li></ul><h3 id="问题"><a class="markdownIt-Anchor" href="#问题"></a> 问题</h3><ul><li><p>presenter一直持有Activity对象导致的内存泄漏问题</p><ul><li>使用mvp的时候，presenter会持有view，如果presenter有后台异步的长时间的动作，比如网络请求，这时如果返回退出了Activity，后台异步的动作不会立即停止，这里就会有内存泄漏的隐患。</li><li>需要一个销毁view的方法，这里是在基类中完成的。</li></ul></li><li><p>presenter绑定和解绑繁琐</p><ul><li>一般一个presenter对应一个Activity，一般应用内存在多个Actiivity，绑定与解绑相当繁琐。</li><li>统一在 Basepresenter 与 BaseActivity中进行，同时解决内存泄漏问题，还有其他常用内容一并添加。</li></ul></li><li><p>presenter 与 Model 的通信问题。</p><ul><li>presenter已经与View层 强耦合了，框架中需要解耦presenter 与 Model ，使用异步通信。Handle等都太复杂了。。。</li><li>开始没有什么好的解决办法，直到遇到了EventBus，当然EventBus也不是万能解决方案，跨进程，还是要另辟蹊径，不过EventBus足够自己写着完了。还有Rxjava，恩，还在玩着，没搞太懂。</li></ul></li></ul><h3 id="代码"><a class="markdownIt-Anchor" href="#代码"></a> 代码</h3><ul><li><p>BasePresenter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BasePresenter</span>&lt;Viewinterface&gt; &#123;</span><br><span class="line">   <span class="comment">//传入泛型</span></span><br><span class="line">   <span class="keyword">public</span> Viewinterface mView;</span><br><span class="line">   <span class="comment">//绑定</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">attach</span><span class="params">(Viewinterface mView)</span> &#123;</span><br><span class="line">       <span class="built_in">this</span>.mView = mView;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//解绑，防止view为空是内存泄漏</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dettach</span><span class="params">()</span> &#123;</span><br><span class="line">       mView = <span class="literal">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>BaseActivity</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseActivity</span> &lt;Viewinterface,mPresenter <span class="keyword">extends</span> <span class="title class_">BasePresenter</span>&lt;Viewinterface&gt;&gt;<span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">   <span class="comment">//获取Presenter对象</span></span><br><span class="line">   <span class="keyword">public</span> mPresenter mpresenter;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">       <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">       <span class="comment">//Presenter实例化</span></span><br><span class="line">       mpresenter = initPresenter();</span><br><span class="line">       <span class="comment">//打印当前activity</span></span><br><span class="line">       LogUtil.d(<span class="string">&quot;Activity&quot;</span>, getClass().getSimpleName()+<span class="string">&quot;onCreate&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onResume</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">//重新刷新时重新绑定view</span></span><br><span class="line">       mpresenter.attach((Viewinterface) <span class="built_in">this</span>);</span><br><span class="line">       <span class="built_in">super</span>.onResume();</span><br><span class="line">       LogUtil.d(<span class="string">&quot;Activity&quot;</span>, getClass().getSimpleName()+<span class="string">&quot;onResume&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">//解绑presenter持有的view</span></span><br><span class="line">       mpresenter.dettach();</span><br><span class="line">       <span class="built_in">super</span>.onDestroy();</span><br><span class="line">       LogUtil.d(<span class="string">&quot;Activity&quot;</span>, getClass().getSimpleName()+<span class="string">&quot;onDestroy&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span>  <span class="keyword">abstract</span> mPresenter <span class="title function_">initPresenter</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Presenter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Presenter</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>mPresenter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">mPresenter</span> <span class="keyword">extends</span> <span class="title class_">BasePresenter</span>&lt;Viewif&gt; <span class="keyword">implements</span> <span class="title class_">Presenter</span> &#123;</span><br><span class="line">   <span class="keyword">private</span> Model mModel;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">mPresenter</span><span class="params">(Viewif view)</span> &#123;</span><br><span class="line">       <span class="built_in">this</span>.attach(view);</span><br><span class="line">       <span class="built_in">this</span>.mModel = <span class="keyword">new</span> <span class="title class_">mModel</span>();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>BaseView</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BaseView</span>&lt;T&gt;  &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>Viewif</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Viewif</span> <span class="keyword">extends</span> <span class="title class_">BaseView</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>MainActivity</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">BaseActivity</span>&lt;Viewif, mPresenter&gt; <span class="keyword">implements</span> <span class="title class_">Viewif</span>&#123;</span><br><span class="line"></span><br><span class="line">   Presenter presenter;</span><br><span class="line">   <span class="comment">//Presenter初始化</span></span><br><span class="line">   <span class="keyword">public</span> mPresenter <span class="title function_">initPresenter</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">mPresenter</span>(<span class="built_in">this</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">       <span class="comment">//presenter初始化</span></span><br><span class="line">       presenter = mpresenter;</span><br><span class="line">       <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">       setContentView(R.layout.activity_main);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>LogUtil</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogUtil</span> &#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">VERBOSE</span> <span class="operator">=</span> <span class="number">1</span>;<span class="comment">//啰嗦，等级最低的</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEBUG</span> <span class="operator">=</span> <span class="number">2</span>;<span class="comment">//调试</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">INFO</span> <span class="operator">=</span> <span class="number">3</span>;<span class="comment">//信息</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">WARN</span> <span class="operator">=</span> <span class="number">4</span>;<span class="comment">//警告</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ERROR</span> <span class="operator">=</span> <span class="number">5</span>;<span class="comment">//错误</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NOTHING</span> <span class="operator">=</span> <span class="number">6</span>;<span class="comment">//什么也不打印出来</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">level</span> <span class="operator">=</span> VERBOSE;<span class="comment">//LEVEL:标准</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">v</span><span class="params">(String tag, String msg)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (level &lt;= VERBOSE) &#123;<span class="comment">//如果大于或者等于定义的标准就打印出来</span></span><br><span class="line">           Log.v(tag, msg);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">d</span><span class="params">(String tag, String msg)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (level &lt;= DEBUG) &#123;</span><br><span class="line">           Log.d(tag, msg);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">i</span><span class="params">(String tag, String msg)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (level &lt;= INFO) &#123;</span><br><span class="line">           Log.i(tag, msg);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">w</span><span class="params">(String tag, String msg)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (level &lt;= WARN) &#123;</span><br><span class="line">           Log.w(tag, msg);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">e</span><span class="params">(String tag, String msg)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (level &lt;= ERROR) &#123;</span><br><span class="line">           Log.e(tag, msg);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://jasper1024.com/jasper/b69fad24/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jfif"><meta itemprop="name" content="Jasper"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="默"><meta itemprop="description" content="微尘"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content=" | 默"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/jasper/b69fad24/" class="post-title-link" itemprop="url">Android笔记—蓝牙串口(BlueTooth+EventBus)</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2017-04-17 12:00:00" itemprop="dateCreated datePublished" datetime="2017-04-17T12:00:00Z">2017-04-17</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Android笔记</span></a> </span></span><span id="/jasper/b69fad24/" class="post-meta-item leancloud_visitors" data-flag-title="Android笔记—蓝牙串口(BlueTooth+EventBus)" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Disqus：</span> <a title="disqus" href="/jasper/b69fad24/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="jasper/b69fad24/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>8.7k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>8 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><hr><p>资料来源如下</p><ul><li>第一行代码(第二版)</li></ul><p>编程环境</p><ul><li>Android Studio 2.2.3</li></ul><p>导语</p><ul><li>毕设中的蓝牙部分,记录以供复习</li></ul><hr><h2 id="概述"><a class="markdownIt-Anchor" href="#概述"></a> 概述</h2><h3 id="最终效果"><a class="markdownIt-Anchor" href="#最终效果"></a> 最终效果</h3><ul><li><p>Android应用 与 Hc-05 蓝牙模块连接,单片机与 Android 端 可以通过串口正常收发数据.</p></li><li><p>预留足够灵活的接口, Android 应用中可以在任意位置获取到蓝牙数据</p></li><li><p>Activity切换时,蓝牙连接不断开.</p></li></ul><h3 id="用到的开源库知识点资料-简介来源"><a class="markdownIt-Anchor" href="#用到的开源库知识点资料-简介来源"></a> 用到的开源库/知识点资料 简介/来源</h3><ul><li>蓝牙:<br><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vZ3VpZGUvdG9waWNzL2Nvbm5lY3Rpdml0eS9ibHVldG9vdGguaHRtbA==">Android API 指南<i class="fa fa-external-link-alt"></i></span></li></ul><blockquote><p><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vZ3VpZGUvdG9waWNzL2Nvbm5lY3Rpdml0eS9ibHVldG9vdGguaHRtbA==">https://developer.android.com/guide/topics/connectivity/bluetooth.html<i class="fa fa-external-link-alt"></i></span></p></blockquote><ul><li><p>EventBus:<br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dyZWVucm9ib3QvRXZlbnRCdXM=">EventBus-GitHub<i class="fa fa-external-link-alt"></i></span> 是一个Android端优化的publish/subscribe消息总线,用来替代 Intent 、 Handler 、 Broadcast 等在 Actvity 、 Fragment 、 Service 等组件之间传递信息 . EventBus 可以传递一个完整的对象,简单高效, <strong>注意 EventBus 只能在多线程之间传递消息,无法在不同进程之间传递消息</strong> ,EventBus 3.0 以后进一步简化了传递方式,真的是很值得学习的一个开源库!</p><p>参考资料如下:</p><p><span class="exturl" data-url="aHR0cDovL3d3dy5qaWFuc2h1LmNvbS9wL2FjZmU3ODI5NmJiNQ==">EventBus 3.0初探: 入门使用及其使用 完全解析<i class="fa fa-external-link-alt"></i></span></p><p><span class="exturl" data-url="aHR0cDovL3d3dy5qaWFuc2h1LmNvbS9wLzFlYWNhMzRlNTMxNA==">EventBus3(3.0.0)源码解析<i class="fa fa-external-link-alt"></i></span></p></li></ul><hr><h2 id="基础部分"><a class="markdownIt-Anchor" href="#基础部分"></a> 基础部分</h2><ul><li>蓝牙 与 EventBus 基础部分</li></ul><h3 id="bluetooth"><a class="markdownIt-Anchor" href="#bluetooth"></a> BlueTooth</h3><hr><ul><li>备注 : 这里使用的是 传统蓝牙 即 蓝牙4.0以前版本, 而不是 蓝牙4.0 ( ble低功耗蓝牙)及以后版本</li></ul><hr><ul><li>Android 对 Bluetooth 做了很好的封装,我们可以比较轻松的在 Android Bluetooth API 上进行开发.</li><li>Android中所有蓝牙API均来自 android.bluetooth 包</li></ul><h4 id="bluetooth基础"><a class="markdownIt-Anchor" href="#bluetooth基础"></a> BlueTooth基础</h4><ul><li><p>BluetoothAdapter 本地蓝牙适配器<br>BluetoothAdapter 是所有蓝牙交互的入口点, 在初始化蓝牙及蓝牙配对阶段使用<br>1.发现其他蓝牙设备<br>2.查询绑定（配对）设备的列表<br>3.使用已知的 MAC 地址实例化 BluetoothDevice<br>4.创建 BluetoothServerSocket 侦听来自其他设备的通信。</p></li><li><p>BluetoothDevice 远程蓝牙设备<br>含有该设备的信息，例如设备的名称、地址、类和绑定状态等。</p></li><li><p>BluetoothSocket 蓝牙套接字接口（与 TCP Socket 相似）<br>与 BluetoothDevice 配合建立远程连接,允许应用通过 InputStream 和 OutputStream 与其他蓝牙设备交换数据.</p></li></ul><h4 id="初始化蓝牙"><a class="markdownIt-Anchor" href="#初始化蓝牙"></a> 初始化蓝牙</h4><ul><li><p>声明蓝牙权限<br>Android 应用使用蓝牙前都需要声明蓝牙权限<br>一般只需要 BLUETOOTH 权限即可,但是考虑到之后有更多的需求,需要更改系统蓝牙设置,由此需要 BLUETOOTH_ADMIN 权限_也一起声明</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;manifest ... &gt;</span><br><span class="line">&lt;uses-permission android:name=<span class="string">&quot;android.permission.BLUETOOTH&quot;</span> /&gt;</span><br><span class="line">&lt;uses-permission android:name=<span class="string">&quot;android.permission.BLUETOOTH_ADMIN&quot;</span> /&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/manifest&gt;</span><br></pre></td></tr></table></figure></li><li><p>蓝牙设备可用性 获取 BluetoothAdapter<br>获取 BluetoothAdapter，需要静态 getDefaultAdapter() 方法。getDefaultAdapter() 会返回一个表示设备自身的蓝牙适配器的 BluetoothAdapter 设备不支持蓝牙 则返回 null</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BluetoothAdapter</span> <span class="variable">mBluetoothAdapter</span> <span class="operator">=</span> BluetoothAdapter.getDefaultAdapter();</span><br><span class="line"><span class="keyword">if</span> (mBluetoothAdapter == <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="comment">// 蓝牙不可用操作</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>开启蓝牙<br>BluetoothAdapter 的 .isEnabled() 可以判断系统蓝牙是否开启.<br>没有开启时 startActivityForResult() 发送包含 ACTION_REQUEST_ENABLE 的 Intent 请求系统开启蓝牙,并在 onActivityResult() 返回的数据中 RESULT_CANCELED 表示开启失败 RESULT_OK 表示开启成功,这里我们只检测开启失败情况,并提示用户</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!mBluetoothAdapter.isEnabled()) &#123;</span><br><span class="line">  <span class="type">Intent</span> <span class="variable">enableBtIntent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(BluetoothAdapter.ACTION_REQUEST_ENABLE);</span><br><span class="line">  startActivityForResult(enableBtIntent, REQUEST_ENABLE_BT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onActivityResult</span><span class="params">(<span class="type">int</span> requestCode, <span class="type">int</span> resultCode, Intent data)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (requestCode == REQUEST_ENABLE_BT &amp;&amp; resultCode == RESULT_CANCELED) &#123;</span><br><span class="line">          Toast.makeText(MyApplication.getContext(),R.string.Bluetooth_openfail, Toast.LENGTH_SHORT).show();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="type">BluetoothAdapter</span> <span class="variable">mBluetoothAdapter</span> <span class="operator">=</span> BluetoothAdapter.getDefaultAdapter();</span><br><span class="line">      <span class="keyword">if</span> (mBluetoothAdapter == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">//设备不支持蓝牙时处理</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li><li><p>查询已配对的设备<br>调用 getBondedDevices(),返回已配对设备的一组 BluetoothDevice.之后使用for循环遍历</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;BluetoothDevice&gt; pairedDevices = mBluetoothAdapter.getBondedDevices();</span><br><span class="line"><span class="keyword">if</span> (pairedDevices.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//重新加载bluetoothDeviceList</span></span><br><span class="line">        bluetoothDeviceList.clear();</span><br><span class="line">        <span class="comment">//BluetoothDevice列表循环</span></span><br><span class="line">        <span class="keyword">for</span> (BluetoothDevice device : pairedDevices) &#123;</span><br><span class="line">          bluetoothDeviceList.add(device);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li><li><p>扫描设备<br>查找设备是非常耗费系统资源的事项，需要安排在子线程中执行，这里没有用到，由需要请参考Google官方蓝牙教程</p></li><li><p>连接设备<br>蓝牙分主从机，链接为服务器/客户端。这里使用的是连接为客户端。</p><ul><li>首先获取远程设备的 BluetoothDevice 对象，即在选择设备阶段的BluetoothDevice</li><li>调用 createRfcommSocketToServiceRecord(UUID) 获取 BluetoothSocket，UUID通用唯一识别码 在蓝牙中具体是什么没有很好的解释。这里的值取的是<br><code>&quot;00001101-0000-1000-8000-00805F9B34FB&quot;</code></li><li>调用 connect() 发起连接,阻塞调用，需要在子线程中执行。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//蓝牙连接子线程</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ConnectThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BluetoothSocket mmSocket;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析函数</span></span><br><span class="line">    ConnectThread(BluetoothDevice bluetoothDevice) &#123;</span><br><span class="line">        <span class="comment">// 使用一个中间变量 tmp</span></span><br><span class="line">        <span class="comment">// mmSocket 类型是 final</span></span><br><span class="line"></span><br><span class="line">        <span class="type">BluetoothSocket</span> <span class="variable">tmp</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// 获取 BluetoothSocket</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// MY_UUID is the app&#x27;s UUID string, also used by the server code</span></span><br><span class="line">            tmp = bluetoothDevice.createRfcommSocketToServiceRecord(UUID.fromString(MyApplication.MY_UUID));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ignored) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//赋值给 mmSocket</span></span><br><span class="line">        mmSocket = tmp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 关闭蓝牙扫描</span></span><br><span class="line">        MyApplication.getBluetoothAdapter().cancelDiscovery();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 通过 socket 连接到设备. connect() 会一直执行直到成功连接或者抛出异常</span></span><br><span class="line">            mmSocket.connect();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException connectException) &#123;</span><br><span class="line">            <span class="comment">//无法连接到蓝牙,关闭连接并退出</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mmSocket.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//没有正常关闭</span></span><br><span class="line">            <span class="keyword">catch</span> (IOException ignored) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Do work to manage the connection (in a separate thread)</span></span><br><span class="line">        mConnectedThread = <span class="keyword">new</span> <span class="title class_">ConnectedThread</span>(mmSocket);</span><br><span class="line">        mConnectedThread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭蓝牙连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mmSocket.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ignored) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>管理连接<br>获取BluetoothSocket<br>获取 InputStream 和 OutputStream， getInputStream() 和 getOutputStream() 来处理数据传输。read(byte[]) 和 write(byte[]) 读取数据并写入到流式传输。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ConnectedThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">      <span class="comment">//BluetoothSocket</span></span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> BluetoothSocket mmSocket;</span><br><span class="line">      <span class="comment">//输入流</span></span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> InputStream mmInStream;</span><br><span class="line">      <span class="comment">//输出流</span></span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> OutputStream mmOutStream;</span><br><span class="line"></span><br><span class="line">      ConnectedThread(BluetoothSocket socket) &#123;</span><br><span class="line">          <span class="comment">//传入BluetoothSocket，实例化mmSocket</span></span><br><span class="line">          mmSocket = socket;</span><br><span class="line">          <span class="comment">//输入/输出流 中间变量</span></span><br><span class="line">          <span class="type">InputStream</span> <span class="variable">tmpIn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">          <span class="type">OutputStream</span> <span class="variable">tmpOut</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 输入输出流实例化</span></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              tmpIn = socket.getInputStream();</span><br><span class="line">              tmpOut = socket.getOutputStream();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">              e.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">          mmInStream = tmpIn;</span><br><span class="line">          mmOutStream = tmpOut;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">          <span class="type">int</span> bytes;</span><br><span class="line">          <span class="comment">// 连接成功时</span></span><br><span class="line">          <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  <span class="comment">// 在InputStream读数据</span></span><br><span class="line">                  bytes = mmInStream.read();</span><br><span class="line">                  <span class="comment">//发送数据</span></span><br><span class="line">                  Events.<span class="type">bluetooth_Recycle</span> <span class="variable">bluetooth_recycle</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Events</span>.bluetooth_Recycle();</span><br><span class="line">                  bluetooth_recycle.s = bytes;</span><br><span class="line">                  bluetooth_recycle.bytes = String.valueOf((<span class="type">char</span>) bytes);</span><br><span class="line">                  EventBus.getDefault().post(bluetooth_recycle);</span><br><span class="line">              &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//写方法</span></span><br><span class="line">      <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              mmOutStream.write(bytes);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">              e.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//关闭流连接</span></span><br><span class="line">      <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              mmSocket.close();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="eventbus"><a class="markdownIt-Anchor" href="#eventbus"></a> EventBus</h3><ul><li>直接放链接了<blockquote><p><span class="exturl" data-url="aHR0cDovL3d3dy5qaWFuc2h1LmNvbS9wL2EwNDA5NTUxOTRmYw==">http://www.jianshu.com/p/a040955194fc<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cDovL3d3dy5qaWFuc2h1LmNvbS9wL2FjZmU3ODI5NmJiNQ==">http://www.jianshu.com/p/acfe78296bb5<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cDovL3d3dy5mZjUwLm5ldC92aWV3LzQwNTY1MjEyOTc3NjIzNTA2MDYzLmh0bWw=">http://www.ff50.net/view/40565212977623506063.html<i class="fa fa-external-link-alt"></i></span></p></blockquote></li></ul><h2 id="正文"><a class="markdownIt-Anchor" href="#正文"></a> 正文</h2><ul><li><p>蓝牙连接子线程</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ConnectThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> BluetoothSocket mmSocket;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//解析函数</span></span><br><span class="line">      ConnectThread(BluetoothDevice bluetoothDevice) &#123;</span><br><span class="line">          <span class="comment">// 使用一个中间变量 tmp</span></span><br><span class="line">          <span class="comment">// mmSocket 类型是 final</span></span><br><span class="line"></span><br><span class="line">          <span class="type">BluetoothSocket</span> <span class="variable">tmp</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">          <span class="comment">// 获取 BluetoothSocket</span></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// MY_UUID is the app&#x27;s UUID string, also used by the server code</span></span><br><span class="line">              tmp = bluetoothDevice.createRfcommSocketToServiceRecord(UUID.fromString(MyApplication.MY_UUID));</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException ignored) &#123;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">//赋值给 mmSocket</span></span><br><span class="line">          mmSocket = tmp;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="comment">// 关闭蓝牙扫描</span></span><br><span class="line">          MyApplication.getBluetoothAdapter().cancelDiscovery();</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// 通过 socket 连接到设备. connect() 会一直执行直到成功连接或者抛出异常</span></span><br><span class="line">              mmSocket.connect();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException connectException) &#123;</span><br><span class="line">              <span class="comment">//无法连接到蓝牙,关闭连接并退出</span></span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  mmSocket.close();</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">//没有正常关闭</span></span><br><span class="line">              <span class="keyword">catch</span> (IOException ignored) &#123;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Do work to manage the connection (in a separate thread)</span></span><br><span class="line">          mConnectedThread = <span class="keyword">new</span> <span class="title class_">ConnectedThread</span>(mmSocket);</span><br><span class="line">          mConnectedThread.start();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * 关闭蓝牙连接</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              mmSocket.close();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException ignored) &#123;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>管理连接子线程</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">//管理连接子线程</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ConnectedThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="comment">//BluetoothSocket</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BluetoothSocket mmSocket;</span><br><span class="line">    <span class="comment">//输入流</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InputStream mmInStream;</span><br><span class="line">    <span class="comment">//输出流</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OutputStream mmOutStream;</span><br><span class="line"></span><br><span class="line">    ConnectedThread(BluetoothSocket socket) &#123;</span><br><span class="line">        <span class="comment">//传入BluetoothSocket，实例化mmSocket</span></span><br><span class="line">        mmSocket = socket;</span><br><span class="line">        <span class="comment">//输入/输出流 中间变量</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">tmpIn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">tmpOut</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 输入输出流实例化</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            tmpIn = socket.getInputStream();</span><br><span class="line">            tmpOut = socket.getOutputStream();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        mmInStream = tmpIn;</span><br><span class="line">        mmOutStream = tmpOut;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">int</span> bytes;</span><br><span class="line">        <span class="comment">// 连接成功时</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 在InputStream读数据</span></span><br><span class="line">                bytes = mmInStream.read();</span><br><span class="line">                <span class="comment">//发送数据</span></span><br><span class="line">                Events.<span class="type">bluetooth_Recycle</span> <span class="variable">bluetooth_recycle</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Events</span>.bluetooth_Recycle();</span><br><span class="line">                bluetooth_recycle.s = bytes;</span><br><span class="line">                bluetooth_recycle.bytes = String.valueOf((<span class="type">char</span>) bytes);</span><br><span class="line">                EventBus.getDefault().post(bluetooth_recycle);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//写方法</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mmOutStream.write(bytes);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭流连接</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mmSocket.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>连接蓝牙</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//连接线程</span></span><br><span class="line"><span class="keyword">private</span> ConnectThread mConnectThread;</span><br><span class="line"><span class="comment">//管理连接进程</span></span><br><span class="line"><span class="keyword">private</span> ConnectedThread mConnectedThread;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建连接子线程</span></span><br><span class="line">mConnectThread = <span class="keyword">new</span> <span class="title class_">ConnectThread</span>(bluetoothDevice);</span><br><span class="line"><span class="comment">//启动连接子线程</span></span><br><span class="line">mConnectThread.start();</span><br></pre></td></tr></table></figure></li><li><p>向蓝牙写入数据</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//发送数据String,        主线程            优先级4       非粘性事件</span></span><br><span class="line"><span class="meta">@Subscribe(threadMode = ThreadMode.MAIN, priority = 4, sticky = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(Events.bluetooth_Send bluetoothSend)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">bytes</span> <span class="operator">=</span> bluetoothSend.bytes;</span><br><span class="line">    mConnectedThread.write(bytes.getBytes());</span><br><span class="line">    LogUtil.d(Tag, <span class="string">&quot;onEvent:Send&quot;</span> + bluetoothSend.bytes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>接收数据处理</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">//数据转换                后台进程            优先级3       非粘性事件</span></span><br><span class="line"><span class="meta">@Subscribe(threadMode = ThreadMode.BACKGROUND, priority = 3, sticky = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(Events.bluetooth_Transformers bluetoothTransformers)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">bytes</span> <span class="operator">=</span> bluetoothTransformers.bytes;</span><br><span class="line">    <span class="comment">//处理数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://jasper1024.com/jasper/b543c37e/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jfif"><meta itemprop="name" content="Jasper"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="默"><meta itemprop="description" content="微尘"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content=" | 默"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/jasper/b543c37e/" class="post-title-link" itemprop="url">Android笔记—仿绿色守护嗜睡模式通知</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2017-03-07 12:00:00" itemprop="dateCreated datePublished" datetime="2017-03-07T12:00:00Z">2017-03-07</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Android笔记</span></a> </span></span><span id="/jasper/b543c37e/" class="post-meta-item leancloud_visitors" data-flag-title="Android笔记—仿绿色守护嗜睡模式通知" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Disqus：</span> <a title="disqus" href="/jasper/b543c37e/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="jasper/b543c37e/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>3.6k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>3 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><hr><p>资料来源如下</p><ul><li>第一行代码(第二版)</li><li><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vdHJhaW5pbmcvbm90aWZ5LXVzZXIvaW5kZXguaHRtbA==">Android Training Notifying the User<i class="fa fa-external-link-alt"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vZ3VpZGUvdG9waWNzL3VpL25vdGlmaWVycy9ub3RpZmljYXRpb25zLmh0bWwjQ3JlYXRlTm90aWZpY2F0aW9u">Android API 通知<i class="fa fa-external-link-alt"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cub3NjaGluYS5uZXQvcXVlc3Rpb24vMjM0MzQ1XzQwMTEx">【Android】状态栏通知Notification、NotificationManager详解<i class="fa fa-external-link-alt"></i></span></li></ul><p>编程环境</p><ul><li>Android Studio 2.2.3</li></ul><p>导语</p><ul><li>OneTapDoze遇到的第一个难题，顺带记录Android 通知相关内容</li></ul><hr><h2 id="最终效果"><a class="markdownIt-Anchor" href="#最终效果"></a> 最终效果</h2><ul><li><p>绿色守护进入doze模式后，会在通知栏创建一个计时通知 如下图<br><img data-src="https://i.loli.net/2019/03/26/5c9a2eb17614a.png" alt="Screenshot_20170307-231118.png"></p></li><li><p>退出doze模式后，会指示进入doze和退出doze的时间段。<br><img data-src="https://i.loli.net/2019/03/26/5c9a2ec9b2dd7.png" alt="Screenshot_20170307-231132.png"></p></li><li><p>我们要仿照的样式就是这样，进入退出doze，对应创建通知的代码都在doze模式改变的Broadcast中。</p></li></ul><h2 id="基础部分"><a class="markdownIt-Anchor" href="#基础部分"></a> 基础部分</h2><h3 id="创建通知"><a class="markdownIt-Anchor" href="#创建通知"></a> 创建通知</h3><ul><li>行文前：<br>Android每次版本几乎都会有通知API的改动，不同版本之间通知兼容性很是问题，为此我们使用support_v7 库中的NotificationCompat.Builder代替Notification.Builder二者使用方式相同</li></ul><hr><ul><li><p>涉及到的两个类</p><ul><li>NotificationManager</li><li>Notification (support库中对应NotificationCompat)</li></ul></li><li><p>NotificationManager</p><ul><li>状态栏通知的管理类，负责发通知、清除通知等</li><li>NotificationManager 是一个系统Service，必须通过 getSystemService()方法来获取</li></ul></li><li><p>Notification</p><ul><li>具体的状态栏通知对象，可以设置icon、文字、提示声音、振动等参数</li><li>一个Builder对象至少包含三个方面<ul><li>一个小图标，通过setSmallIcon()方法设置。</li><li>通知标题，通过setContentTitle()方法设置。</li><li>详细文本，通过setContentText()方法设置。</li></ul></li></ul></li><li><p>简单示例</p><ul><li><p>创建通知构建器<br>代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Notification</span> <span class="variable">notification</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotificationCompat</span>.Builder(<span class="built_in">this</span>)</span><br><span class="line">           .setContentTitle(<span class="string">&quot;这是通知标题&quot;</span>)</span><br><span class="line">           .setContentText(<span class="string">&quot;这是通知内容&quot;</span>)</span><br><span class="line">           <span class="comment">//这里使用的是应用图标，一般没人这么干，就是为了方便</span></span><br><span class="line">           .setSmallIcon(R.mipmap.ic_launcher)</span><br><span class="line">           .build();</span><br></pre></td></tr></table></figure></li><li><p>发布通知</p><ul><li>获得NotificationManager的实例</li><li>使用notify()方法发布通知。在调用notify()方法 指定通知的ID，(ID用于通知更新) 加载Notification实例</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">mNotificationId</span> <span class="operator">=</span> <span class="number">001</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">NotificationManager</span> <span class="variable">manager</span> <span class="operator">=</span> (NotificationManager) getSystemService(NOTIFICATION_SERVICE);</span><br><span class="line">manager.notify(mNotificationId, notification);</span><br></pre></td></tr></table></figure></li></ul></li><li><p>效果如下</p><ul><li>android 7.0 / 6.0 /4.0 通过</li><li><img data-src="https://i.loli.net/2019/03/26/5c9a2ee2a0d1e.png" alt="ScreenShot_20170202173430.png"></li></ul></li></ul><h3 id="更新通知"><a class="markdownIt-Anchor" href="#更新通知"></a> 更新通知</h3><ul><li><p>可以创建一个全新的NotificationCompat对象，也可以在原NotificationCompat对象基础上修改，最后只要 .notify 方法中对应同一个 mNotificationId ，系统就会自动更新已有通知，代码不在累赘。</p></li><li><p>基础部分到此，足矣</p></li></ul><h2 id="正题"><a class="markdownIt-Anchor" href="#正题"></a> 正题</h2><ul><li>实现时间段的显示，肯定会保存系统进入doze 退出doze对应的时间点。再计算出中间经历的时间。</li></ul><h3 id="提取系统时间"><a class="markdownIt-Anchor" href="#提取系统时间"></a> 提取系统时间</h3><ul><li><p>java.util.Date<br>这里用到了java中的 时间类型 java.util.Date<br>java.util.Date 是java中常用时间类型，可以被SimpleDateFormat格式化format() 指定输出的时间格式<br>比如我们需要 小时：分：秒<br><code>SimpleDateFormat scanf = new SimpleDateFormat(&quot;HH:mm:ss&quot;);</code><br><code>scanf.format(java.util.Date)</code> 即可。</p></li><li><p>提前当前系统时间</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java.util.<span class="type">Date</span> <span class="variable">time_after</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">time_after = <span class="keyword">new</span> <span class="title class_">java</span>.util.Date(System.currentTimeMillis());</span><br></pre></td></tr></table></figure></li><li><p>计算时间差<br>理论上是两个时间相减再格式化输出即可，可惜没成，原因还没找到。于是土办法：</p><ul><li>调用 .getTime() 方法，将 java.util.Date 转化为毫秒计时(long)</li><li>取两者差值</li><li>转化为 时间长短 字符串返回，</li></ul></li><li><p>代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> size = (time_after.getTime() - time_befor.getTime());</span><br><span class="line"> string = scanf.format(time_befor) + <span class="string">&quot;-&quot;</span> + scanf.format(time_after) + <span class="string">&quot;=&quot;</span>+ trform(size);</span><br><span class="line"></span><br><span class="line"> String <span class="title function_">trform</span><span class="params">(<span class="type">long</span> size)</span> &#123;</span><br><span class="line"> <span class="type">long</span> day, hour, min, secone;</span><br><span class="line"></span><br><span class="line"> day = size / (<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>);          <span class="comment">//以天数为单位取整</span></span><br><span class="line"> hour = (size / (<span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>) - day * <span class="number">24</span>);             <span class="comment">//以小时为单位取整</span></span><br><span class="line"> min = ((size / (<span class="number">60</span> * <span class="number">1000</span>)) - day * <span class="number">24</span> * <span class="number">60</span> - hour * <span class="number">60</span>);    <span class="comment">//以分钟为单位取整</span></span><br><span class="line"> secone = (size / <span class="number">1000</span> - day * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> - hour * <span class="number">60</span> * <span class="number">60</span> - min * <span class="number">60</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (day != <span class="number">0</span>) &#123;</span><br><span class="line">   <span class="keyword">return</span> day + <span class="string">&quot;d&quot;</span> + hour + <span class="string">&quot;h&quot;</span> + min + <span class="string">&quot;m&quot;</span> + secone + <span class="string">&quot;s&quot;</span>;</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hour != <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> hour + <span class="string">&quot;h&quot;</span> + min + <span class="string">&quot;m&quot;</span> + secone + <span class="string">&quot;s&quot;</span>;</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (min != <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> min + <span class="string">&quot;m&quot;</span> + secone + <span class="string">&quot;s&quot;</span>;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> secone + <span class="string">&quot;s&quot;</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="通知扩展布局"><a class="markdownIt-Anchor" href="#通知扩展布局"></a> 通知扩展布局</h3><ul><li><p>在如下图片中，可以发现，通知在发出后，只默认显示最近一次的时间记录，其他时间记录可以在此条通知上下滑查看。明显与基础部分不同。<br><img data-src="https://i.loli.net/2019/03/26/5c9a2ec9b2dd7.png" alt="Screenshot_20170307-231132.png"></p></li><li><p>此处应用了 Builder.setStyle() 拓展布局，顾名思义，这是用于拓展通知显示范围</p></li></ul><hr><h4 id="使用扩展布局"><a class="markdownIt-Anchor" href="#使用扩展布局"></a> 使用扩展布局</h4><ul><li>使用拓展布局<ul><li>构建一个 inboxStyle 对象</li><li>.addLine方法 添加 String inboxStyle 行</li><li>使用 Builder.setStyle( inboxStyle )加载到通知</li><li>等待通知发布即可。</li></ul></li><li>简单例程如下<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建 inboxStyle</span></span><br><span class="line"> NotificationCompat.<span class="type">InboxStyle</span> <span class="variable">inboxStyle</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotificationCompat</span>.InboxStyle();</span><br><span class="line"> <span class="comment">//添加 String 行 ，前提是 我已经创建了一个 String</span></span><br><span class="line"> inboxStyle.addLine(string);</span><br><span class="line"> <span class="comment">// 在notification 设置    inboxStyle 在一堆 build 里面</span></span><br><span class="line"> .setStyle(inboxStyle)</span><br></pre></td></tr></table></figure></li><li>清除原有内容，发布新的 inboxStyle 只需要 <code>inboxStyle = new NotificationCompat.InboxStyle();</code></li></ul><h3 id="doze模式改变广播"><a class="markdownIt-Anchor" href="#doze模式改变广播"></a> Doze模式改变广播</h3><ul><li>对应 <code>ACTION_DEVICE_IDLE_MODE_CHANGED</code></li></ul><hr><ul><li>坑：只能动态注册，静态注册无效，具体代码中<code>powermanger.ACTION_DEVICE_IDLE_MODE_CHANGED</code> 需要实例化 PowerManger ，而 PowerManger 又是与 Activity绑定，所以只有应用保持后台存活时才会进入广播。</li><li>例程如下<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实例化 PowerManager</span></span><br><span class="line"><span class="type">PowerManager</span> <span class="variable">powermanger</span> <span class="operator">=</span> (PowerManager) getApplicationContext().getSystemService(Context.POWER_SERVICE);</span><br><span class="line"><span class="comment">//动态注册广播</span></span><br><span class="line">intentFilter = <span class="keyword">new</span> <span class="title class_">IntentFilter</span>();</span><br><span class="line">intentFilter.addAction(powermanger.ACTION_DEVICE_IDLE_MODE_CHANGED);</span><br><span class="line"><span class="comment">//idlemodechage 是 BroadcastReceiver</span></span><br><span class="line">idlemodechage = <span class="keyword">new</span> <span class="title class_">IdleModeChange</span>();</span><br><span class="line">registerReceiver(idlemodechage, intentFilter);</span><br></pre></td></tr></table></figure></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://jasper1024.com/jasper/e1752787/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jfif"><meta itemprop="name" content="Jasper"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="默"><meta itemprop="description" content="微尘"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content=" | 默"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/jasper/e1752787/" class="post-title-link" itemprop="url">Android笔记— Android 权限详解</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2017-01-19 12:00:00" itemprop="dateCreated datePublished" datetime="2017-01-19T12:00:00Z">2017-01-19</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Android笔记</span></a> </span></span><span id="/jasper/e1752787/" class="post-meta-item leancloud_visitors" data-flag-title="Android笔记— Android 权限详解" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Disqus：</span> <a title="disqus" href="/jasper/e1752787/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="jasper/e1752787/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>4.4k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>4 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><hr><p>资料来源如下</p><ul><li>第一行代码(第二版)</li><li><span class="exturl" data-url="aHR0cDovL3d3dy5qaWFuc2h1LmNvbS9wLzU3Nzk4NjE4YmQ5MA==">android6.0运行时权限详解<i class="fa fa-external-link-alt"></i></span></li></ul><p>编程环境</p><ul><li>Android Studio 2.2.3</li></ul><p>导语</p><ul><li>内容提供器是安全的应用间共享数据途径，在正式进入之前需要了解一下 Android 自6.0以来权限的变化</li></ul><hr><h2 id="android-权限详解"><a class="markdownIt-Anchor" href="#android-权限详解"></a> Android 权限详解</h2><hr><p>资料来源：</p><ul><li><span class="exturl" data-url="aHR0cDovL3d3dy5qaWFuc2h1LmNvbS9wLzU3Nzk4NjE4YmQ5MA==">android6.0运行时权限详解<i class="fa fa-external-link-alt"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vZ3VpZGUvdG9waWNzL3NlY3VyaXR5L3Blcm1pc3Npb25zLmh0bWw=">Develop-API Guides-系统权限<i class="fa fa-external-link-alt"></i></span></li><li>第一行代码(第二版)</li></ul><hr><h3 id="android权限介绍"><a class="markdownIt-Anchor" href="#android权限介绍"></a> Android权限介绍</h3><ul><li><p>Android 是一个权限分隔的操作系统<br>每个应用系统标识（Linux 用户 ID 和组 ID）不同。系统各部分标识亦不相同。Linux 据此将不同的应用以及应用与系统分隔开来。<br>更详细的安全功能通过“权限”提供，权限 会限制特定进程可以执行的具体操作，并且根据 URI 权限授权临时访问特定的数据段</p></li><li><p>权限声明<br>最常见的权限声明在 AndroidManifest.xml 文件中一个或多个uses-permission 标记,</p><ul><li>例如 声明短信权限<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">package</span>=<span class="string">&quot;com.android.app.myapp&quot;</span> &gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.RECEIVE_SMS&quot;</span> /&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>android 6.0 权限机制<br>android 6.0之前 权限及在安装的时候，根据权限声明产生一个权限列表，用户只有在同意之后才能完成app的安装。<br>android 6.0 以后 引入了 运行时权限 功能，应用所需权限不再一次性在安装时申请，而是在运行时需要用到那种权限向用户申请，同时用户也可以随时取消该授权</p></li><li><p>权限分类</p><ul><li>Normal Permissions(普通权限)<br>不涉及用户隐私，不需要用户进行授权的，例如 手机震动、访问网络等</li><li>Dangerous Permission(危险权限)<br>涉及到用户隐私的，需要用户进行授权，例如 读取sdcard、访问通讯录等<br><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vZ3VpZGUvdG9waWNzL3NlY3VyaXR5L3Blcm1pc3Npb25zLmh0bWw=">危险权限组<i class="fa fa-external-link-alt"></i></span>如表1</li></ul></li></ul><h3 id="应用运行时申请权限适用于-android60-及以上版本"><a class="markdownIt-Anchor" href="#应用运行时申请权限适用于-android60-及以上版本"></a> 应用运行时申请权限（适用于 Android6.0 及以上版本）</h3><ul><li>通过一个简单的实例来说明过程</li></ul><h4 id="实例"><a class="markdownIt-Anchor" href="#实例"></a> 实例：</h4><ul><li><p>拨打电话 CALL_PHONE _权限为例</p><ul><li>权限声明<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.CALL_PHONE&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>拨打10010</p><ul><li>代码如下 构建一个隐式intent 启动拨打电话<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_CALL);</span><br><span class="line">intent.setData(Uri.parse(<span class="string">&quot;tel:10010&quot;</span>));</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure></li></ul></li><li><p>在主界面上添加一个Button 在其onClick方法中拨打电话，运行程序!</p></li></ul><hr><ul><li>在An’d’roid 6.0 以下版本中 电话都可以正常拨出。Android 6.0 以上版本中 则可能会应用崩溃/无反应，查看logcat的打印日志可以看到 “Permission Denial”权限被禁止的信息，接下来尝试使用 运行时申请权限</li></ul><hr><ul><li><p>检查是否已获得授权<br>int checkSelfPermission(Context context, String permission)方法</p><ul><li>Context context context<br>String permission 权限具体名称<br>打电话对应 Manifest.permission.CALL_PHONE _</li><li>方法返回 PERMISSION_GRANTED / PERMISSION_DENIED</li><li>例程<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(ContextCompat.checkSelfPermission</span><br><span class="line">(MainActivity.<span class="built_in">this</span>,Manifest.permission.CALL_PHONE)</span><br><span class="line">!=PackageManager.PERMISSION_GRANTED)</span><br><span class="line">&#123;</span><br><span class="line">         ;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">         ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>申请权限<br>void ActivityCompat.requestPermissions (Activity activity, String[] permissions, int requestCode)方法</p><ul><li><p>Activity activity Activity实例<br>String[] permissions 请求权限名<br>int requestCode 请求码，大于0即可，对应在onRequestPermissionsResult 回掉方法中的requestCode</p></li><li><p>例程</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ActivityCompat.requestPermissions(MainActivity.<span class="built_in">this</span>,</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">String</span>[]&#123;Manifest.permission.CALL_PHONE&#125;,<span class="number">1</span> );</span><br></pre></td></tr></table></figure></li></ul></li><li><p>授权后回掉<br>无论用户是否授权都会进入回掉方法，需要重写该方法。<br>void onRequestPermissionsResult (int requestCode, String[] permissions, int[] grantResults)方法</p><ul><li><p>int requestCode 在 requestPermissions 中传入的请求码<br>String[] permissions 请求的权限，不为空<br>int[] grantResults 授权结果 只有 PERMISSION_GRANTED / PERMISSION_DENIED 两个值</p></li><li><p>例程</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onRequestPermissionsResult</span><span class="params">(<span class="type">int</span> requestCode, String[] permissions, <span class="type">int</span>[] grantResults)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (requestCode) &#123;</span><br><span class="line">    	<span class="comment">//请求码 1</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="comment">//授权结果(int) 的 长度是否大于0  与上 授权结果是否等于  PackageManager.PERMISSION_GRANTED</span></span><br><span class="line">            <span class="keyword">if</span> (grantResults.length &gt; <span class="number">0</span> &amp;&amp; grantResults[<span class="number">0</span>] == PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">            <span class="comment">//授权通过执行</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//授权没有通过</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>当用户拒绝后再次询问<br>boolean ActivityCompat.shouldShowRequestPermissionRationale(Activity activity, String permission) （真心太长了）</p><ul><li>Activity activity Activity实例<br>String permission 权限名称<br>应用第一次需要授权时,用户授权，该方法返回false。当用户拒绝授权,下次需要该权限时,该方法会返回true</li><li>例程<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> (ActivityCompat.shouldShowRequestPermissionRationale</span><br><span class="line">(PermissionActivity.<span class="built_in">this</span>,Manifest.permission.READ_CONTACTS))</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//第二次询问用户是否授权</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="comment">//用户依旧拒绝后操作</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>例程源码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">      setContentView(R.layout.activity_main);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Button</span><span class="params">(View view)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(ContextCompat.checkSelfPermission(MainActivity.<span class="built_in">this</span>,Manifest.permission.CALL_PHONE) != PackageManager.PERMISSION_GRANTED)&#123;</span><br><span class="line">          ActivityCompat.requestPermissions(MainActivity.<span class="built_in">this</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;Manifest.permission.CALL_PHONE&#125;,<span class="number">1</span> );</span><br><span class="line">      &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">          call();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_CALL);</span><br><span class="line">          intent.setData(Uri.parse(<span class="string">&quot;tel:10010&quot;</span>));</span><br><span class="line">          startActivity(intent);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onRequestPermissionsResult</span><span class="params">(<span class="type">int</span> requestCode, String[] permissions, <span class="type">int</span>[] grantResults)</span> &#123;</span><br><span class="line">      <span class="keyword">switch</span> (requestCode) &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">              <span class="keyword">if</span> (grantResults.length &gt; <span class="number">0</span> &amp;&amp; grantResults[<span class="number">0</span>] == PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">                  call();</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  Toast.makeText(<span class="built_in">this</span>, <span class="string">&quot;You denied the permission&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">     <span class="attr">android:onClick</span>=<span class="string">&quot;Button&quot;</span></span></span><br><span class="line"><span class="tag">     <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">     <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">     <span class="attr">android:text</span>=<span class="string">&quot;Hello World!&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://jasper1024.com/jasper/b516a013/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jfif"><meta itemprop="name" content="Jasper"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="默"><meta itemprop="description" content="微尘"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content=" | 默"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/jasper/b516a013/" class="post-title-link" itemprop="url">Android笔记—数据保存</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2017-01-14 12:00:00" itemprop="dateCreated datePublished" datetime="2017-01-14T12:00:00Z">2017-01-14</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Android笔记</span></a> </span></span><span id="/jasper/b516a013/" class="post-meta-item leancloud_visitors" data-flag-title="Android笔记—数据保存" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Disqus：</span> <a title="disqus" href="/jasper/b516a013/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="jasper/b516a013/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>4k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>4 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><hr><p>资料来源如下</p><ul><li>第一行代码(第二版)</li></ul><p>编程环境</p><ul><li>Android Studio 2.2.3</li></ul><hr><h2 id="android-中的主要数据存储"><a class="markdownIt-Anchor" href="#android-中的主要数据存储"></a> Android 中的主要数据存储</h2><ul><li><p>有三种</p></li><li><p>保存键值集<br>要保存的相对较小键值集合，使用 SharedPreferences</p></li><li><p>保存文件<br>使用 Android 文件系统通过 File API 读取和写入文件，适合按开始到结束的顺序不跳过地读取或写入大量数据。 例如，图片文件或通过网络交换的任何内容</p></li><li><p>在 SQL 数据库中保存数据<br>Android内建的SQLite 数据库存储重复或结构化数据</p></li></ul><hr><ul><li>PS：这里如果没有学过 SQL 数据库使用，推荐LitePal</li><li>Android开源数据库<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0xpdGVQYWxGcmFtZXdvcmsvTGl0ZVBhbCNsYXRlc3QtZG93bmxvYWRzLw==">LitePal<i class="fa fa-external-link-alt"></i></span> ：郭霖(第一行代码作者)</li><li>详细介绍在这里<span class="exturl" data-url="aHR0cDovL3d3dy5qaWFuc2h1LmNvbS9wLzU1NzY4MmUwYTlmMA==">（懒人必备）Android开源数据库LitePal<i class="fa fa-external-link-alt"></i></span></li></ul><hr><h3 id="保存键值集"><a class="markdownIt-Anchor" href="#保存键值集"></a> 保存键值集</h3><ul><li><p>想要保存的相对较小键值集合</p></li><li><p>调用SharedPreferences</p></li><li><p>首先：获取SharedPreferences的句柄<br>用户可以创建一个共享参数文件或访问一个已经存在的共享参数文件。<br>具体途径有三条</p><ul><li>getSharedPreferences (String name, int mode)<ul><li>第一个参数：SharedPreferences的名称，第二个：参数指定操作模式</li><li>需要创建/读取 多个共享参数文件时使用，每个文件都拥有一个标识符，可以通过这个标识符通过该方法的第一个参数获得共享参数对象。可以通过APP中的任意Context对象调用它。</li><li>示例<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//指定SharedPreferences名称为data  模式为MODE_PRIVATE：只有当前程序才有权限读取/修改</span></span><br><span class="line"><span class="type">SharedPreferences</span> <span class="variable">sharedPref</span> <span class="operator">=</span> getSharedPreferences(<span class="string">&quot;data&quot;</span>, MODE_PRIVATE);</span><br></pre></td></tr></table></figure></li></ul></li><li>getPreferences (int mode)<ul><li>参数：指定操作模式</li><li>只创建 Activity 的一个SharedPreferences。在Activity 中使用。 方法会检索属于该 Activity 的默认共享首选项文件，无需提供名称</li><li>示例<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//模式：MODE_PRIVATE：只有当前程序才有权限读取/修改</span></span><br><span class="line"><span class="type">SharedPreferences</span> <span class="variable">sharedPref</span> <span class="operator">=</span> getActivity().getPreferences(Context.MODE_PRIVATE);</span><br></pre></td></tr></table></figure></li></ul></li><li>getDefaultSharedPreferences(context)<ul><li>参数：context</li><li>自动以档期应用程序包名作为前缀命名SharedPreferences文件</li></ul></li></ul></li><li><p>写入数据到共享参数中</p><ul><li>SharedPreferences 调用 edit() 创建一个 SharedPreferences.Editor<br>使用诸如 putInt() 和 putString() 方法写入的键和值<br>最后调用commit() 以保存更改<br>也可调用apply() 保存更改</li></ul></li></ul><hr><ul><li>commit() 与 apply() 相同/区别</li><li>相同<ul><li>都是提交preference修改数据</li></ul></li><li>区别<ul><li>apply没有返回值 commit返回boolean表明修改是否提交成功</li><li>apply是将操作提交到内存，而后异步真正提交到文件<br>commit是同步的提交到文件<br>多个commit同时提交，互相等待，效率较低<br>apply直接覆盖，效率较高</li><li>apply没有任何错误提示，只是提交的动作</li></ul></li></ul><hr><ul><li>示例<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建 .edit()</span></span><br><span class="line">SharedPreferences.<span class="type">Editor</span> <span class="variable">editor</span> <span class="operator">=</span> sharedPref.edit();</span><br><span class="line"><span class="comment">//写入字符串。key-值 TextView</span></span><br><span class="line">editor.putString(<span class="string">&quot;TextView&quot;</span>,<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"><span class="comment">//保存更改</span></span><br><span class="line">editor.commit();</span><br></pre></td></tr></table></figure></li><li>从共享参数中读取数据<ul><li>获取SharedPreferences的句柄<br>方式同上</li><li>调用比如getInt()或getString()方法，然后传入键值，如果键不存在，则会返回一个默认值</li><li>示例<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取SharedPreferences的句柄</span></span><br><span class="line"><span class="type">SharedPreferences</span> <span class="variable">sharedPreferences</span> <span class="operator">=</span> getSharedPreferences(<span class="string">&quot;data&quot;</span>,MODE_PRIVATE);</span><br><span class="line"><span class="comment">//读取键值对应数据</span></span><br><span class="line"><span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> sharedPreferences.getString(<span class="string">&quot;TextView&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="comment">//打印到log中 验证</span></span><br><span class="line">Log.d(<span class="string">&quot;data&quot;</span>,text);</span><br></pre></td></tr></table></figure></li></ul></li></ul><h3 id="保存到文件"><a class="markdownIt-Anchor" href="#保存到文件"></a> 保存到文件</h3><ul><li><p>Android 设备有两个文件存储区域： 内部存储 和 外部存储<br>Android 设备早期内置的非易失性内存（内部存储），以及移动存储介质 微型 SD 卡等（外部存储）<br>任何Android设备始终有两个存储空间，并且无论外部存储设备是否可移动，API 的行为均一致</p></li><li><p>Android的文件存储是以java流为基础，并优化了一些操作。java流不属于本文范围。</p></li><li><p>涉及java流部分参考<span class="exturl" data-url="aHR0cDovL2FuZHJvaWR0b2FzdC5pdGV5ZS5jb20vYmxvZy8xMTcyNjcz">Android文件IO详解<i class="fa fa-external-link-alt"></i></span></p></li></ul><h4 id="内部存储"><a class="markdownIt-Anchor" href="#内部存储"></a> 内部存储</h4><h4 id="保存到内部存储"><a class="markdownIt-Anchor" href="#保存到内部存储"></a> 保存到内部存储</h4><ul><li><p>某一应用对其内部存储 始终具有 进行读写的权限，而无需声明任何权限，在 Android N之前，内部文件可以通过放宽权限让其他应用访问。<strong>但是极不推荐以这种方式共享文件</strong></p></li><li><p>简单实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(String inputText)</span>&#123;</span><br><span class="line">      <span class="comment">//新建一个FileOutputStream对象(字节流)</span></span><br><span class="line">      <span class="type">FileOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">      <span class="comment">//新建一个BufferedWriter (字符流)</span></span><br><span class="line">      <span class="type">BufferedWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">try</span>&#123;</span><br><span class="line">          <span class="comment">//out 实例化</span></span><br><span class="line">          out = openFileOutput(<span class="string">&quot;data&quot;</span>,Context.MODE_PRIVATE);</span><br><span class="line">          <span class="comment">//OutputStreamWrit  字节流转换为字符流</span></span><br><span class="line">          <span class="comment">//字符流绑定BufferedWriter(缓冲区)</span></span><br><span class="line">          writer = <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(out));</span><br><span class="line">          <span class="comment">//写入到文件</span></span><br><span class="line">          writer.write(inputText);</span><br><span class="line">      &#125;<span class="keyword">catch</span> (IOException e )&#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="keyword">try</span>&#123;</span><br><span class="line">              <span class="comment">//如果写入成功</span></span><br><span class="line">              <span class="keyword">if</span> (writer != <span class="literal">null</span>) &#123;</span><br><span class="line">              	<span class="comment">//关闭流</span></span><br><span class="line">                  writer.close();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">              e.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li><li><p>FileOutputStream：</p><ul><li>继承自 OutputStream 用于文件处理的节点流</li><li>用于写入原始字节流到文件</li></ul></li><li><p>FileOutputStream openFileOutput (String name, int mode)</p><ul><li>返回FileOutputStream对象</li><li>第一个参数是文件名</li><li>第二个参数是操作模式，有4种取值<ul><li>MODE_PRIVATE(默认)_当同一文件名存在时覆盖原文件</li><li>MODE_APPEND _当同名文件存在时，在原文件末尾追加</li><li>其余两种均在android4.2及以上版本中废弃</li></ul></li></ul></li><li><p>OutputStreamWrit</p><ul><li>继承自 Writer</li><li>将字节流转换为字符流</li></ul></li><li><p>BufferedWriter</p><ul><li>继承自Writer</li><li>绑定字符输出流，提高具体的流对象的效率</li><li>.flush()方法 对缓冲区进行刷新，让数据到目的地</li><li>.close();方法 关闭缓冲区，即关闭绑定的流</li></ul></li></ul><h5 id="从内部存储读取文件"><a class="markdownIt-Anchor" href="#从内部存储读取文件"></a> 从内部存储读取文件</h5><ul><li><p>简单实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">load</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="comment">//新建FileInputStream对象</span></span><br><span class="line">     <span class="type">FileInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">     <span class="comment">//新建 BufferedReader对象</span></span><br><span class="line">     <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">     <span class="comment">//新建一个StringBuilder 空</span></span><br><span class="line">      content = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">     <span class="keyword">try</span>&#123;</span><br><span class="line">     	<span class="comment">//FileInputStream对象实例化</span></span><br><span class="line">         in = openFileInput(<span class="string">&quot;data&quot;</span>);</span><br><span class="line">         <span class="comment">//字节流转换为字符流</span></span><br><span class="line">         <span class="comment">//缓冲流绑定字符流</span></span><br><span class="line">         reader = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(in));</span><br><span class="line">         <span class="comment">//空 String</span></span><br><span class="line">         <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">         <span class="comment">//读取文件内容，并判断是否读取完成</span></span><br><span class="line">         <span class="keyword">while</span>((line = reader.readLine())!=<span class="literal">null</span>)&#123;</span><br><span class="line">         	<span class="comment">//读取内容添加到 StringBuilder 对象中</span></span><br><span class="line">             content.append(line);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">finally</span> &#123;</span><br><span class="line">         <span class="keyword">if</span>(reader != <span class="literal">null</span>)&#123;</span><br><span class="line">             <span class="keyword">try</span>&#123;</span><br><span class="line">             	<span class="comment">//关闭流</span></span><br><span class="line">                 reader.close();</span><br><span class="line">             &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">                 e.printStackTrace();</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">//将读取结果 由StringBuilder转换为String 并返回</span></span><br><span class="line">     <span class="keyword">return</span> content.toString();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li><li><p>FileInputStream</p><ul><li>继承自 InputStream，用于文件处理的节点流</li><li>从文件中读取</li></ul></li><li><p>FileInputStream openFileInput(String filename)</p><ul><li>返回FileInputStream对象</li><li>参数为 读取的文件名</li></ul></li><li><p>InputStreamRead</p><ul><li>将字节流转换为字符流</li></ul></li><li><p>BufferedReader</p><ul><li>缓冲流</li></ul></li></ul><h4 id="外部存储"><a class="markdownIt-Anchor" href="#外部存储"></a> 外部存储</h4><ul><li>占坑</li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://jasper1024.com/jasper/af503cd2/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jfif"><meta itemprop="name" content="Jasper"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="默"><meta itemprop="description" content="微尘"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content=" | 默"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/jasper/af503cd2/" class="post-title-link" itemprop="url">Android笔记—Broadcast广播</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2016-12-23 12:00:00" itemprop="dateCreated datePublished" datetime="2016-12-23T12:00:00Z">2016-12-23</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Android笔记</span></a> </span></span><span id="/jasper/af503cd2/" class="post-meta-item leancloud_visitors" data-flag-title="Android笔记—Broadcast广播" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Disqus：</span> <a title="disqus" href="/jasper/af503cd2/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="jasper/af503cd2/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>9k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>8 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><hr><p>资料来源如下</p><ul><li>第一行代码(第二版)</li></ul><p>编程环境</p><ul><li>Android Studio 2.2.3</li></ul><hr><h2 id="broadcastreceiver基础"><a class="markdownIt-Anchor" href="#broadcastreceiver基础"></a> BroadcastReceiver基础</h2><ul><li>首先祭出官方文档及<strong>中文翻译</strong></li></ul><blockquote><p><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vcmVmZXJlbmNlL2FuZHJvaWQvY29udGVudC9Ccm9hZGNhc3RSZWNlaXZlci5odG1s">https://developer.android.com/reference/android/content/BroadcastReceiver.html<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cDovL3d3dy5qaWFuc2h1LmNvbS9wLzFiNTYxNzJiMGM3Nw==">http://www.jianshu.com/p/1b56172b0c77<i class="fa fa-external-link-alt"></i></span></p></blockquote><h3 id="broadcastreceiver概述"><a class="markdownIt-Anchor" href="#broadcastreceiver概述"></a> BroadcastReceiver概述</h3><ol><li><span class="exturl" data-url="aHR0cDovL3d3dy5jbmJsb2dzLmNvbS9xaXVzY3V0L2FydGljbGVzLzIyMTIwNjQuaHRtbA==">@别路寻忆<i class="fa fa-external-link-alt"></i></span><br>Android中的四大组件是 Activity、Service、Broadcast和Content Provider。而Intent是一个对动作和行为的抽象描述，负责组件之间程序之间进行消息传递。那么Broadcast Receiver组件就提供了一种把Intent作为一个消息广播出去，由所有对其感兴趣的程序对其作出反应的机制。</li><li><span class="exturl" data-url="aHR0cDovL2Jsb2cuY3Nkbi5uZXQvenVvbG9uZ3NuYWlsL2FydGljbGUvZGV0YWlscy82NDUwMTU2">@zuolongsnail专栏<i class="fa fa-external-link-alt"></i></span><ul><li><p>广播接收器是一个专注于接收广播通知信息，并做出对应处理的组件。很多广播是源自于系统代码的──比如，通知时区改变、电池电量低、拍摄了一张照片或者用户改变了语言选项。应用程序也可以进行广播──比如说，通知其它应用程序一些数据下载完成并处于可用状态。</p></li><li><p>应用程序可以拥有任意数量的广播接收器以对所有它感兴趣的通知信息予以响应。所有的接收器均继承自BroadcastReceiver基类。</p></li><li><p>广播接收器没有用户界面。然而，它们可以启动一个activity来响应它们收到的信息，或者用NotificationManager来通知用户。通知可以用很多种方式来吸引用户的注意力──闪动背灯、震动、播放声音等等。一般来说是在状态栏上放一个持久的图标，用户可以打开它并获取消息。</p></li></ul></li></ol><h3 id="广播分类"><a class="markdownIt-Anchor" href="#广播分类"></a> 广播分类</h3><ul><li><p>触发广播发生的事件分类有两种</p><ol><li>Android系统广播事件<br>由android设备状态变化而触发的系统广播如：<br>Intent.ACTION_POWER_CONNECTED;<br>//插上外部电源时发出的广播<br>Intent.ACTION_SCREEN_ON;<br>//屏幕被打开之后的广播<br>ACTION_TIME_CHANGED<br>//系统时间改变而触发的广播</li><li>自定义的广播事件<br>这个比较好理解了，比如qq当我们再另外一台手机上登陆时，手头的这个手机qq就会自动下线。腾讯的服务器通过后台服务启用了自定义广播来终结正在运行的Activity，详情之后会有例程，不再累赘。</li></ol></li><li><p>能够被接收的广播类型</p><ol><li><p>普通广播（Normal broadcasts）：<br>（由 Context.sendBroadcast发出）异步发出。所有广播接收器都可以在同一时间接收广播。广播接收者无法接收广播的处理结果或者阻断广播的传递。</p></li><li><p>有序广播（Ordered broadcasts）：<br>（由 Context.sendOrderedBroadcast发出）每次只发送给一个广播接收器。当每个广播接收器依次执行时，它可以向下一个广播接收器传播结果，或者阻断该广播，使得该广播不能被下一个广播接收器接收到。</p></li></ol><ul><li>通俗解释：<br>普通广播就相当于小区/村委会的大喇叭，有事发生（触发广播）通知所有的人（广播接收器），全功率的大喊大叫确保所有人（广播接收器）都能听到。而有人（广播接收器）在睡觉被吵醒但是又没办法砸了那个大喇叭，只能继续听着（无法接收广播的处理结果或者阻断广播的传递）。<br>有序广播 就相当于间谍机关的绝密消息传递。绝密到手（触发广播）间谍秘密汇总给上线A（广播接收器A）。本来 上线（广播接收器A）应该 听取完毕重新整理情向首长B（广播接收器B）报告（向广播接收器B传播 广播接收器A修改的结果）,但是A被收买，将情报隐匿了，没有向首长B汇报（广播接收器A阻断该广播，使得该广播不能被下一个广播接收器B接收到）。（PS结局首长B错误带人炸了村委会，该睡觉的人终于可以安生睡觉了！）</li></ul></li><li><p>广播事件注册有两种</p><ol><li>静态注册，就是在AndroidManifest.xml文件中定义，注册的广播接收器必须要继承BroadcastReceiver.</li><li>动态注册，是在程序中使用Context.registerReceiver注册，注册的广播接收器相当于一个匿名类。两种方式都需要IntentFIlter。</li></ol><ul><li>例程见下节。</li></ul></li></ul><h2 id="动态注册在代码中注册"><a class="markdownIt-Anchor" href="#动态注册在代码中注册"></a> 动态注册（在代码中注册）</h2><ul><li><p>在代码中通过registerReceiver()注册。app关闭后,该接收器也会随之销毁。</p></li><li><p>首先定义一个内部子类NetworkChangeReceiver继承自 BroadcastReceiver</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">NetworkChangeReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//重写onReceive，接收到广播后提示消息</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line"> 	Toast.makeText(context, <span class="string">&quot;network is available网络已变化&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li><li><p>在onCreate()方法中创建IntentFilter实例和NetworkChangeReceiver实例。并在IntentFilter实例中添加网络变化时系统广播对应值。随后传入registerReceiver()中注册。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line"> <span class="comment">//创建IntentFilter实例</span></span><br><span class="line">    intentFilter = <span class="keyword">new</span> <span class="title class_">IntentFilter</span>();</span><br><span class="line">    <span class="comment">//添加对应系统广播</span></span><br><span class="line">    intentFilter.addAction(<span class="string">&quot;android.net.conn.CONNECTIVITY_CHANGE&quot;</span>);</span><br><span class="line">    <span class="comment">//添加NetworkChangeReceiver实例</span></span><br><span class="line">    networkChangeReceiver = <span class="keyword">new</span> <span class="title class_">NetworkChangeReceiver</span>();</span><br><span class="line">    <span class="comment">//动态注册</span></span><br><span class="line">    registerReceiver(networkChangeReceiver, intentFilter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>动态注册的广播接收器最后要取消注册。在onDestroy()方法中调用unregisterReceiver()销毁动态注册的广播接收器。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">super</span>.onDestroy();</span><br><span class="line">    unregisterReceiver(networkChangeReceiver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>最后要在AndroidMainfest.xml中声明查询系统网络状态的权限。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_NETWORK_STATE&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>运行效果如如所示（模拟器）<br><img data-src="https://i.loli.net/2019/03/26/5c9a3127de6ea.jpg" alt=""></p></li></ul><h2 id="静态注册xml中注册"><a class="markdownIt-Anchor" href="#静态注册xml中注册"></a> 静态注册（xml中注册）</h2><ul><li>直接在Manifest.xml文件中配置广播接收者</li><li>例程为了方便同样以<code>android.net.conn.CONNECTIVITY_CHANGE</code>为例，与动态注册相同。</li></ul><h3 id="不使用内部子类第一行代码"><a class="markdownIt-Anchor" href="#不使用内部子类第一行代码"></a> 不使用内部子类（第一行代码）</h3><ul><li><p>新建名称为BootCompleteReceiver的java class 代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span>  <span class="keyword">class</span> <span class="title class_">BootCompleteReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span>&#123;</span><br><span class="line">       Toast.makeText(context, <span class="string">&quot;网络改变&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">  		 &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在AndroidManifest.xml文件中注册广播接收器<br>代码如下</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">&quot;.BootCompleteReceiver&quot;</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.net.conn.CONNECTIVITY_CHANGE&quot;</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>在AndroidManifest.xml中声明权限</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">uses-permission</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_NETWORK_STATE&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">uses-permission</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="使用内部子类在activity中定义"><a class="markdownIt-Anchor" href="#使用内部子类在activity中定义"></a> 使用内部子类（在Activity中定义）</h3><hr><p><strong>在这晕圈了一下午，找不出毛病。看书多仔细吧，书上说了不用内部子类。</strong><br>详细资料在这里</p><blockquote><p><span class="exturl" data-url="aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY2hkamovYXJ0aWNsZS9kZXRhaWxzLzE5NDk2NTY3">http://blog.csdn.net/chdjj/article/details/19496567<i class="fa fa-external-link-alt"></i></span></p></blockquote><hr><ul><li><strong>清单文件注册广播接收者时，广播接收者的名字格式需要注意因为是内部类，所以需要在内部类所在的类与内部类之间加上$符号</strong>(这一点在AndroidStudio中输入时有提示)</li><li><strong>内部类在声明时一定要写成静态内部类（class关键字前加上static）。否则会抛出异常</strong>（广播发生时，应用停止运行）</li></ul><hr><ul><li><p>在MainActivity中新建子类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">BootCompleteReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span>&#123;</span><br><span class="line">        Toast.makeText(context, <span class="string">&quot;Boot complete&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在AndroidManifest.xml中注册广播接收器</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">&quot;.MainActivity$BootCompleteReceiver&quot;</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.net.conn.CONNECTIVITY_CHANGE&quot;</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>在AndroidManifest.xml中声明权限</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">uses-permission</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_NETWORK_STATE&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">uses-permission</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>运行效果同动态注册</p></li></ul><h2 id="使用广播接收器注意事项"><a class="markdownIt-Anchor" href="#使用广播接收器注意事项"></a> 使用广播接收器注意事项</h2><ul><li>在onReceive()方法中不宜添加过多逻辑/耗时操作，广播接收器没有多线程，一旦时间过长，程序就会报错。</li><li>广播接收器一般为启动其他组件作用。</li></ul><h2 id="发送标准广播"><a class="markdownIt-Anchor" href="#发送标准广播"></a> 发送标准广播</h2><hr><ul><li>发送标准广播之前，首先要注册一个作为目标的广播接收器。（过程略，只上代码）<br>新建MyBroadcastReceiver.class<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBroadcastReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span></span><br><span class="line">   &#123;</span><br><span class="line">    Toast.makeText(context,<span class="string">&quot;MyBroadcastReceiver&quot;</span>,Toast.LENGTH_SHORT).show();</span><br><span class="line">   	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>在Xml中注册（静态）<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">&quot;.MyBroadcastReceiver&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.broadcasttest.MyBroad&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><hr><ul><li><p>xml中注册一个Button</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:onClick</span>=<span class="string">&quot;SendBroad&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:text</span>=<span class="string">&quot;SendBroad&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>MainActivity中新建 SendBroad()函数<br>首先构建一个 Intent对象，将自定义的广播值填入。再调用sendBroadcast方法将广播发送出去。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">SendBroad</span><span class="params">(View view)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="string">&quot;com.example.broadcasttest.MyBroad&quot;</span>);</span><br><span class="line">    sendBroadcast(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>发送的是标准广播。运行效果如下图。<br><a target="_blank" rel="noopener external nofollow noreferrer" href="http://snapgr.am/image/L2ou"><img data-src="https://i.loli.net/2019/03/26/5c9a3140244ac.png" alt="Screenshot_20160910-220121.png"></a></p></li></ul><h2 id="发送有序广播"><a class="markdownIt-Anchor" href="#发送有序广播"></a> 发送有序广播</h2><hr><ul><li>首先新建一个Broad2 的工程。同样接收Broad发送的广播。<br>代码如下<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnotherBroadcast</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span></span><br><span class="line">   &#123;</span><br><span class="line">       Toast.makeText(context,<span class="string">&quot; AnotherBroadcast&quot;</span>,Toast.LENGTH_SHORT).show();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">&quot;.AnotherBroadcast&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">intent-filter</span> <span class="attr">android:priority</span>=<span class="string">&quot;10&quot;</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.broadcasttest.MyBroad&quot;</span>/&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li>测试效果：当摁下发送广播按钮后，弹出两个提示。</li></ul><hr><ul><li><p>修改Broad项目中onClick对应事件。将sendBroadcast(）改为sendOrderedBroadcast();发送有序广播。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">SendBroad</span><span class="params">(View view)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="string">&quot;com.example.broadcasttest.MyBroad&quot;</span>);</span><br><span class="line">    sendOrderedBroadcast(intent,<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>效果与发送标准广播相同（还未定义优先级/截断等）</p></li><li><p>定义优先级，再Broad的AndroidMainfest.xml中修改注册的广播添加android:priority=&quot;100&quot;优先级100</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">&quot;.MyBroadcastReceiver&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span> <span class="attr">android:priority</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.broadcasttest.MyBroad&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>在Broad2的AndroidMainfest.xml中添加android:priority=&quot;10&quot;优先级10</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">&quot;.AnotherBroadcast&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span> <span class="attr">android:priority</span>=<span class="string">&quot;10&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.broadcasttest.MyBroad&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>发送广播后MyBroadcastReceiver最先收到广播。</p></li><li><p>截断广播。有序广播中前一个广播接收器可以截断广播传播。添加 abortBroadcast();即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBroadcastReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span></span><br><span class="line">   &#123;</span><br><span class="line">       Toast.makeText(context,<span class="string">&quot;MyBroadcastReceiver&quot;</span>,Toast.LENGTH_SHORT).show();</span><br><span class="line">       abortBroadcast();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>再次点击按钮发送广播，只有MyBroadcastReceiver可以接收到发送的广播。</p></li></ul><h2 id="本地广播"><a class="markdownIt-Anchor" href="#本地广播"></a> 本地广播</h2><ul><li><p>只在app应用内部传递的广播。注册过程类似于动态注册。</p></li><li><p>定义一个内部类LocalReceiver继承自BroadcastReceiver</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LocalReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span>&#123;</span><br><span class="line">        Toast.makeText(context, <span class="string">&quot;received local broadcast&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>首先在onCreate()方法中通过localBroadcastManager.getInstan得到一个LocalBroadcastManager的实例，再创建IntentFilter实例和LocalReceiver实例。并在IntentFilter实例中添加广播。随后传入localBroadcastManager.registerReceiver()中注册本地广播。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> IntentFilter intentFilter;</span><br><span class="line"><span class="keyword">private</span> LocalReceiver localReceiver;</span><br><span class="line"><span class="keyword">private</span> LocalBroadcastManager localBroadcastManager;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line">    <span class="type">Toolbar</span> <span class="variable">toolbar</span> <span class="operator">=</span> (Toolbar) findViewById(R.id.toolbar);</span><br><span class="line"></span><br><span class="line">    localBroadcastManager = localBroadcastManager.getInstance(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">    intentFilter = <span class="keyword">new</span> <span class="title class_">IntentFilter</span>();</span><br><span class="line">    intentFilter.addAction(<span class="string">&quot;com.example.broadcasttest.LOCAL_BROADCAST&quot;</span>);</span><br><span class="line">    localReceiver = <span class="keyword">new</span> <span class="title class_">LocalReceiver</span>();</span><br><span class="line">    localBroadcastManager.registerReceiver(localReceiver, intentFilter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在Activity的onDestroy()中销毁注册。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">super</span>.onDestroy();</span><br><span class="line">    localBroadcastManager.unregisterReceiver(localReceiver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在Button对应的函数中调用localBroadcastManager.sendBroadcast发送本地广播。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">SendBroad</span><span class="params">(View view)</span></span><br><span class="line">&#123;</span><br><span class="line">      <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="string">&quot;com.example.broadcasttest.LOCAL_BROADCAST&quot;</span>);</span><br><span class="line">      localBroadcastManager.sendBroadcast(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>效果基本同上，不加累赘。不过在Broad2中是怎样都搜不到广播了。</p></li><li><p>本地广播特点</p><ul><li>明确广播只在应用内部，传递数据无需担心泄密。</li><li>其他程序广播无法发送至程序内部。</li><li>本地广播比全局广播更为高效。</li></ul></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://jasper1024.com/jasper/1e4507ea/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jfif"><meta itemprop="name" content="Jasper"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="默"><meta itemprop="description" content="微尘"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content=" | 默"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/jasper/1e4507ea/" class="post-title-link" itemprop="url">Android笔记—Fragments</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2016-12-18 12:00:00" itemprop="dateCreated datePublished" datetime="2016-12-18T12:00:00Z">2016-12-18</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Android笔记</span></a> </span></span><span id="/jasper/1e4507ea/" class="post-meta-item leancloud_visitors" data-flag-title="Android笔记—Fragments" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Disqus：</span> <a title="disqus" href="/jasper/1e4507ea/#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="jasper/1e4507ea/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>5.9k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>5 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><hr><p>资料来源如下</p><ul><li>第一行代码(第二版)</li><li><span class="exturl" data-url="aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdmFucGVyc2llXzk5ODcvYXJ0aWNsZS9kZXRhaWxzLzUxMzExODA4">Android官方文档之App Components（Fragments）<i class="fa fa-external-link-alt"></i></span></li></ul><p>编程环境</p><ul><li>Android Studio 2.2.3</li></ul><p>导语</p><ul><li>Fragments的艺术之旅</li></ul><hr><h2 id="fragments简介"><a class="markdownIt-Anchor" href="#fragments简介"></a> Fragments简介</h2><ul><li>Fragment—片段 是Android 在 Android 3.0（API 11 级）中引入了，主要是为了给大屏幕（如平板电脑）上更加动态和灵活的 UI 设计提供支持。</li><li>可以将多个片段组合在一个 Activity 中来构建多窗格 UI，以及在多个 Activity 中重复使用某个片段。可以将片段视为 Activity 的模块化组成部分，它具有自己的生命周期，能接收自己的输入事件，可以在 Activity 运行时添加或删除片段（类似于不同 Activity 中重复使用的“子 Activity”）</li><li><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vZ3VpZGUvY29tcG9uZW50cy9mcmFnbWVudHMuaHRtbA==">Google官方文档(中文)<i class="fa fa-external-link-alt"></i></span></li></ul><h2 id="创建fragments"><a class="markdownIt-Anchor" href="#创建fragments"></a> 创建Fragments</h2><ul><li><p>fragment创建过程与Activity类似。</p></li><li><p>创建Fragment，需要继承一个Fragment类，并实现Fragment的生命周期回调方法，如onCreate(), onStart(), onPause(), onStop()等</p></li><li><p>一般来说，在Fragment中应至少重写以下这些生命周期方法<br><strong>必须重写的时onCreateView()方法.</strong></p><ul><li>onCreate()：创建Fragment实例时，系统回调的方法。在该方法中，对一些必要的组件进行初始化</li><li>onCreateView()：Fragment上绘制UI时，回掉该方法。返回一个View对象，表示Fragment的根视图；若Fragment不需要绑定示图，可以返回null</li><li>onPause()：当用户离开Fragment时回调。在该方法中，对Fragment的数据信息做持久化的保存工作</li></ul></li></ul><h3 id="创建一个fragment类"><a class="markdownIt-Anchor" href="#创建一个fragment类"></a> 创建一个Fragment类</h3><ul><li><p>新建first_fragme 继承自Fragment</p></li><li><p>Android Studio中 对应Fragment 包有两个，选择support-v4 _(这个版本可以再Android版本中保持Fragment特性一致)</p></li><li><p>Fragment并非一定要绑定一个布局文件，下面会提到。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FirstFragment</span> <span class="keyword">extends</span> <span class="title class_">Fragment</span> &#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> View <span class="title function_">onCreateView</span> <span class="params">(LayoutInflater inflater, ViewGroup container, Bundle saveInstanceState)</span>&#123;</span><br><span class="line">       <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> inflater.inflate(R.layout.fragment_firest,container,<span class="literal">false</span>);</span><br><span class="line">       <span class="keyword">return</span> view;</span><br><span class="line">   	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>与此对应的fragment_firest布局文件 _<br>LinearLayout加一个Button，背景颜色设置为了靛蓝色。</p></li><li><p>onCreateView()方法</p><ul><li>ViewGroup来自宿主Activity容器布局，Fragment的布局将其作为根视图插入至该视图中。</li><li>Bundle用于回传之前占据该位置的Fragment实例所保存的Bundle信息，当该Fragment的新实例处于resume状态时，该参数被回传</li></ul></li><li><p>inflate() 方法</p><ul><li><p>参数1（int）：需要绑定的Layout的资源ID；</p></li><li><p>参数2（ViewGroup）：绑定的Layout布局的父视图；</p></li><li><p>参数3（boolean）：是否需要将参数1的Layout资源依附于，参数2的ViewGroup上，false，表示不依附。（系统已经默认将Layout插入至ViewGroup中，若为true，将添加一层冗余的视图</p></li></ul></li></ul><h3 id="在xml将fragment添加到activity"><a class="markdownIt-Anchor" href="#在xml将fragment添加到activity"></a> 在XML将fragment添加到activity</h3><ul><li><p>在activity_main.xml中添加如下代码。跟添加一个layout没有太大区别。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/left_fragment&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;ljy.com.fragmenttest.fragment_firest&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;0dp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_weight</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>至此一个fragment添加完毕。为了对比，再新建一个second_fragment，背景颜色不同，两者同时添加进activity_main中。</p></li><li><p><img data-src="https://i.loli.net/2019/03/26/5c9a28449535d.png" alt="Screenshot_1476109113.png"></p></li><li><p>一般来说必须为fragment设定唯一的身份标识，以便当宿主Activity为restart状态时可以恢复fragment</p><ul><li>android:id属性为fragment指定唯一ID</li><li>android:tag属性为fragment指定唯一字符串标识</li><li>未指定，则该fragment的标识为其父容器控件的ID</li></ul></li></ul><h3 id="动态添加碎片"><a class="markdownIt-Anchor" href="#动态添加碎片"></a> 动态添加碎片</h3><hr><ul><li><strong>处理片段时，请谨记：Activity 布局必须包含一个可以插入片段的容器 View</strong></li></ul><hr><ul><li><p>添加或移除片段必须使用 FragmentManager 创建 FragmentTransaction， FragmentTransaction将提供添加、移除、替换片段以及执行其他片段事务所需的 API。Activity 内调用 getSupportFragmentManager() 以获取 FragmentManager</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">rightfragment</span> <span class="variable">right</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">rightfragment</span>();</span><br><span class="line"><span class="type">FragmentManager</span> <span class="variable">fragmentManager</span> <span class="operator">=</span> getSupportFragmentManager();</span><br></pre></td></tr></table></figure></li><li><p>调用 beginTransaction() 创建一个 FragmentTransaction事务，并调用 add() 添加一个片段，做好更改准备时，调用 commit()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FragmentTransaction</span> <span class="variable">transaction</span> <span class="operator">=</span> fragmentManager.beginTransaction();</span><br><span class="line">transaction.replace(R.id.right_layout,right);</span><br><span class="line">transaction.commit();</span><br></pre></td></tr></table></figure></li><li><p>示例：</p><ul><li><p>首先改造一下activity_main.xml_<br>FrameLayout包含一个left_fragment</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  <span class="tag">&lt;<span class="name">FrameLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/right_layout&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;0dp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_weight</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/left_fragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;com.example.fragment_text.leftfragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>在MainActivity的onCreate方法中添加fragment</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//新建准备替换的Fragment实例</span></span><br><span class="line"><span class="type">rightfragment</span> <span class="variable">right</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">rightfragment</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//新建FragmentManager</span></span><br><span class="line"><span class="type">FragmentManager</span> <span class="variable">fragmentManager</span> <span class="operator">=</span> getSupportFragmentManager();</span><br><span class="line"><span class="comment">// 调用beginTransaction() 创建FragmentTransaction</span></span><br><span class="line"><span class="type">FragmentTransaction</span> <span class="variable">transaction</span> <span class="operator">=</span> fragmentManager.beginTransaction();</span><br><span class="line"></span><br><span class="line"><span class="comment">//FragmentTransaction内处理添加/替换等。</span></span><br><span class="line">transaction.replace(R.id.right_layout,right);</span><br><span class="line"></span><br><span class="line"><span class="comment">//最后执行commit()方法</span></span><br><span class="line">transaction.commit();</span><br></pre></td></tr></table></figure></li></ul></li></ul><h2 id="管理fragments执行fragment事务"><a class="markdownIt-Anchor" href="#管理fragments执行fragment事务"></a> 管理Fragments/执行Fragment事务</h2><ul><li><p>Activity中管理Fragment，使用FragmentManager(</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FragmentManager</span> <span class="variable">fragmentManager</span> <span class="operator">=</span> getFragmentManager();</span><br></pre></td></tr></table></figure><p>可以实现的操作</p><ul><li>findFragmentById()方法获取由Activity管辖的绑定了UI的Fragment实例</li><li>popBackStack()方法将Fragment从后退栈中弹出</li><li>addOnBackStackChangedListener()方法注册监听器，用于监听后退栈的变化</li></ul></li><li><p>Fragment可实现动态添加、删除、替换 等 操作，每一组向Activity提交的变化称为事务，使用FragmentTransaction这操作事务,调用beginTransaction(）开启一个事务</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FragmentManager</span> <span class="variable">fragmentManager</span> <span class="operator">=</span> getFragmentManager();</span><br><span class="line"><span class="type">FragmentTransaction</span> <span class="variable">fragmentTransaction</span> <span class="operator">=</span> fragmentManager.beginTransaction();</span><br></pre></td></tr></table></figure><p>可实现对Feagment的操作</p><ul><li>add() //添加</li><li>remove() //移除</li><li>replace() //替换</li></ul></li><li><p>事务要在Activity中生效，调用commit()方法提交</p></li><li><p>commit()方法之前，调用addToBackStack()方法，可以将该事物添加到由Activity管辖的Fragment返回栈中。点击Back键即撤销该事物提交的更改</p></li></ul><hr><ul><li><p>使用FragmentTransaction操作事务时注意</p><ul><li>commit()必须在最后调用</li><li>一个布局容器中添加多个Fragment，加入的顺序决定了这些Fragment绑定的UI视图在View树中的层级顺序</li></ul></li><li><p>commit()方法提交后，并不会立即执行事务，UI更新只能在主线程中进行，主线程空闲时，才会执行事务操作<br>Android也提供了 在UI线程中调用executePendingTransactions()方法，使commit()方法调用后立即执行提交的事务（一般用不到）</p></li></ul><hr><h2 id="与-activity-通信"><a class="markdownIt-Anchor" href="#与-activity-通信"></a> 与 Activity 通信</h2><ul><li>Fragment 中获取 Activity 实例<br>getActivity()方法可以获取到 Activity 实例<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MainActivity</span> <span class="variable">activity</span> <span class="operator">=</span> (MainActivity) getActivity();</span><br></pre></td></tr></table></figure>调用Activity中的试图也很简单，使用findViewById()即可，getActivity()方法返回的既是一个Context对象<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">View</span> <span class="variable">listView</span> <span class="operator">=</span> getActivity().findViewById(R.id.list);</span><br></pre></td></tr></table></figure></li></ul><hr><ul><li>在Fragment中使用Context对象，getActivity()方法，只能是在fragment已经依附于Activity后才能调用。当fragment未依附于某个Activity、或fragment已经处于其生命周期的末尾而不再依附于某个Activity时，调用getActivity()方法会直接返回null</li></ul><hr><ul><li><p>Activity 中获取 Fragment 实例()<br>FragmentManger提供了findFragmentById()方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RightFragment</span> <span class="variable">fragment</span> <span class="operator">=</span> (RightFragment) getFragmentManager().findFragmentById(R.id.example_fragment);</span><br></pre></td></tr></table></figure><p>如果使用的使support-V4包，则 getFragmentManager()改为getSupportFragmentManager()，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RightFragment</span> <span class="variable">fragment</span> <span class="operator">=</span> (RightFragment)getSupportFragmentManager().findFragmentById(R.id.example_fragment);</span><br></pre></td></tr></table></figure></li><li><p>Fragment与Frangment之间也可以通过宿主Activity，获取到另一个Fragment实例，调用另一个Fragment中的方法</p></li></ul><h3 id="为activity创建事件回调"><a class="markdownIt-Anchor" href="#为activity创建事件回调"></a> 为Activity创建事件回调</h3><ul><li>占坑，</li></ul><h2 id="frangment的生命周期"><a class="markdownIt-Anchor" href="#frangment的生命周期"></a> Frangment的生命周期</h2><ul><li><p>与Activity极为相似，且 Frangment的生命周期与宿主Activity有很大关联</p></li><li><p>有3种状态</p><ul><li>Resumed继续：宿主Activity处于running，Fragment处于可见状态</li><li>Paused暂停：另一个Activity处于前台并获得了焦点，该Fragment的宿主Activity并未被全部遮挡</li><li>Stopped停止：Fragment不可见或Fragment已被Activity移除，宿主Activity被回收时，Fragment也将被回收</li></ul></li><li><p><img data-src="https://i.loli.net/2019/03/26/5c9a285c3740c.png" alt="fragment_lifecycle.png"></p></li></ul><h3 id="宿主activity的影响"><a class="markdownIt-Anchor" href="#宿主activity的影响"></a> 宿主Activity的影响</h3><ul><li><a target="_blank" rel="noopener external nofollow noreferrer" href="http://snapgr.am/image/L5KP"><img data-src="https://i.loli.net/2019/03/26/5c9a2873e3f1b.png" alt="activity_fragment_lifecycle.png"></a></li></ul><hr><h4 id="重要回调方法"><a class="markdownIt-Anchor" href="#重要回调方法"></a> 重要回调方法</h4><ul><li>onAttach()：fragment关联Activity时回调</li><li>onCreateView()：fragment绑定UI视图(加载布局)时回调</li><li>onActivityCreated()：宿主Activity创建完毕 (宿主Activity的onCreate()方法返回) 后调用</li><li>onDestroyView()：与fragment绑定的UI视图被移除时回调</li><li>onDetach()：fragment不再依附于Activity时回调</li></ul><hr><ul><li><p>Activity 与Fragment在生命周期之间的最显著差异在于它们在其各自返回栈中的存储方式。<br>默认情况下，Activity 停止时会被放入由系统管理的 Activity 返回栈（以便用户通过返回按钮回退到 Activity），<br>Frament仅当您在移除片段的事务执行期间通过调用 addToBackStack() 请求保存实例时，系统才会将Fragment放入由宿主 Activity 管理的返回栈。</p></li><li><p>一旦Activity处于resume状态时，可以自由地添加或移除fragment，也就是说，只有当Activity的状态为resume时，fragment才能够自由地控制自己的生命周期</p></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><nav class="pagination"><a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/31/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/31/">31</a><span class="page-number current">32</span><a class="page-number" href="/page/33/">33</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/33/"><i class="fa fa-angle-right"></i></a></nav></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2016 – <span itemprop="copyrightYear">2026</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">JasperHale</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span>站点总字数：</span> <span title="站点总字数">1.2m</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span>站点阅读时长 &asymp;</span> <span title="站点阅读时长">18:54</span></span></div><div class="powered-by">由 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZy9waXNjZXMv">NexT.Pisces</span> 强力驱动</div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="reading-progress-bar"></div><span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL0phc3Blci0xMDI0" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"jasper1024","count":true,"i18n":{"disqus":"disqus"}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.27.0/source/js/third-party/comments/disqus.min.js" defer></script><script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"Jasper-1024/blog_discuss","issue_term":"pathname","theme":"github-dark"}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.27.0/source/js/third-party/comments/utterances.min.js" defer></script><script>!function(){function e(){var e,t=document.getElementById("not-by-ai-badge-template");t&&t.content&&((e=document.querySelector(".post-copyright ul"))&&(e.querySelector(".post-copyright-not-by-ai")||e.appendChild(t.content.cloneNode(!0))))}e(),document.addEventListener("pjax:complete",e)}()</script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script></body></html>